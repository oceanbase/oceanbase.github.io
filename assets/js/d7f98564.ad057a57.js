"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[4244],{78972:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>r});var s=n(74848),a=n(28453);const i={title:"Statistics O&M Manual",weight:1},o=void 0,l={id:"user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/operations_and_maintenance",title:"Statistics O&M Manual",description:"This statistics O&M manual is used for OceanBase Database Community Edition V4.2.0 or later. By default, if you collect statistics on a table, execution plans involving access to the table are refreshed in the plan cache. We recommend that you do not collect statistics during peak hours unless necessary.",source:"@site/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/01_operations_and_maintenance.md",sourceDirName:"user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics",slug:"/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/operations_and_maintenance",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/operations_and_maintenance",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/01_operations_and_maintenance.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Statistics O&M Manual",weight:1},sidebar:"operation_and_maintenanceEnglishSidebar",previous:{title:"O&M SQL Statements Used in OCP",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/commonly_used_sql/ocp_monitor_ob"},next:{title:"Best Practices for Statistics Collection",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/best_practices"}},c={},r=[{value:"Basic Knowledge of Statistics",id:"basic-knowledge-of-statistics",level:2},{value:"Troubleshoot Collection Job Execution Failures",id:"troubleshoot-collection-job-execution-failures",level:2},{value:"Working principles of automatic statistics collection",id:"working-principles-of-automatic-statistics-collection",level:3},{value:"Troubleshooting procedure",id:"troubleshooting-procedure",level:3},{value:"Troubleshoot Collection Job Scheduling Failures",id:"troubleshoot-collection-job-scheduling-failures",level:2},{value:"Troubleshoot Stuck Collection Caused by an Ultra-large Table",id:"troubleshoot-stuck-collection-caused-by-an-ultra-large-table",level:2},{value:"Common O&amp;M Methods of Statistics",id:"common-om-methods-of-statistics",level:2},{value:"Disable and enable automatic statistics collection",id:"disable-and-enable-automatic-statistics-collection",level:3},{value:"Quickly query tables with outdated or missing statistics in the current tenant",id:"quickly-query-tables-with-outdated-or-missing-statistics-in-the-current-tenant",level:3},{value:"Modify the statistics collection strategies of ultra-large tables",id:"modify-the-statistics-collection-strategies-of-ultra-large-tables",level:3},{value:"Lock statistics to prevent statistics updates",id:"lock-statistics-to-prevent-statistics-updates",level:3},{value:"Modify the strategies for slow statistics collection",id:"modify-the-strategies-for-slow-statistics-collection",level:3},{value:"References",id:"references",level:2}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"This statistics O&M manual is used for OceanBase Database Community Edition V4.2.0 or later. By default, if you collect statistics on a table, execution plans involving access to the table are refreshed in the plan cache. We recommend that you do not collect statistics during peak hours unless necessary."})})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"basic-knowledge-of-statistics",children:"Basic Knowledge of Statistics"}),"\n",(0,s.jsxs)(t.p,{children:['Before you read this topic, we recommend that you learn about the basic knowledge of statistics. For more information, see the "Statistics" section in ',(0,s.jsx)(t.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/sql_tuning",children:"Common SQL tuning methods"}),"."]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"If you already have a basic understanding of OceanBase Database statistics, you can directly read the following sections."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"troubleshoot-collection-job-execution-failures",children:"Troubleshoot Collection Job Execution Failures"}),"\n",(0,s.jsx)(t.h3,{id:"working-principles-of-automatic-statistics-collection",children:"Working principles of automatic statistics collection"}),"\n",(0,s.jsxs)(t.p,{children:["Automatic statistics collection jobs are implemented based on the ",(0,s.jsx)(t.code,{children:"DBMS_SCHEDULER"})," system package. The following table describes the seven windows defined to schedule statistics collection jobs during each week."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"Maintenance window"})}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"Start time/Frequency"})}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"Maximum collection duration"})})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"MONDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"22:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"4 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"TUESDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"22:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"4 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"WEDNESDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"22:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"4 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"THURSDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"22:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"4 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"FRIDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"22:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"4 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"SATURDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"06:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"20 hours"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"center"},children:(0,s.jsx)(t.strong,{children:"SUNDAY_WINDOW"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"06:00/Per week"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"20 hours"})]})]})]}),"\n",(0,s.jsx)(t.p,{children:"Automatic statistics collection involves only tables whose statistics are missing or outdated and is performed in an incremental manner. That is, the system collects statistics only on partitions in which data has changed, instead of on the entire table. By default, if the total amount of data that is added, deleted, and modified since the last collection in a partition exceeds 10% of the current table data amount, the statistics of the partition are outdated."}),"\n",(0,s.jsx)(t.h3,{id:"troubleshooting-procedure",children:"Troubleshooting procedure"}),"\n",(0,s.jsx)(t.p,{children:"To check whether automatic statistics collection is successful, perform the following steps:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["Step 1: Execute the following SQL statements based on the types of tenants to check whether automatic collection jobs are normally scheduled for all tenants within the previous day. If so, perform the operation in Step 2. If not, refer to ",(0,s.jsx)(t.a,{href:"#troubleshoot-collection-job-scheduling-failures",children:"Troubleshoot Collection Job Scheduling Failures"}),"."]})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"\n-- Execute the following SQL statement in the sys tenant. If the return result is not empty, the automatic statistics collection jobs of specific tenants are not scheduled as expected. This method is recommended.\n\nSELECT tenant_id AS failed_scheduler_tenant_id\nFROM   oceanbase.__all_tenant t\nWHERE  NOT EXISTS(SELECT 1\n               FROM oceanbase.__all_virtual_task_opt_stat_gather_history h\n               WHERE  TYPE = 1\n               AND start_time > date_sub(now(), interval 1 day)\n               AND h.tenant_id = t.tenant_id);\n\n\n-- Execute the following SQL statement in a MySQL tenant. If the return result is empty, the automatic statistics collection jobs of the tenant are not scheduled as expected.\n\nSELECT *\nFROM   oceanbase.dba_ob_task_opt_stat_gather_history\nWHERE  start_time > date_sub(now(), interval 1 day)\n    AND TYPE = 'AUTO GATHER';\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Step 2: Execute the following SQL statements based on the types of tenants to obtain the list of failed collection jobs within the previous day. If the return result is empty, the statistics are collected as expected. If not, perform the operations in Step 3 to troubleshoot the issue."})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"\n-- Execute the following SQL statement in the sys tenant to query this information of specific or all user tenants. We recommend that you query the information about specific tenants.\n\nSELECT t_opt.tenant_id,\n       t_opt.task_id,\n       task_opt.start_time AS task_start_time,\n       task_opt.end_time   AS task_end_time,\n       d.database_name,\n       t.table_name,\n       t_opt.table_id,\n       t_opt.ret_code,\n       t_opt.start_time,\n       t_opt.end_time,\n       t_opt.memory_used,\n       t_opt.stat_refresh_failed_list,\n       t_opt.properties\nFROM   (\n           SELECT tenant_id,\n                  task_id,\n                  start_time,\n                  end_time,\n                  table_count\n           FROM   oceanbase.__all_virtual_task_opt_stat_gather_history\n           WHERE  type = 1\n--            AND    tenant_id = {tenant_id} -- Specify the IDs of tenants whose information you want to query.\n           AND    start_time > date_sub(Now(), interval 1 day)) task_opt\nJOIN   oceanbase.__all_virtual_table_opt_stat_gather_history t_opt\nJOIN   oceanbase.__all_virtual_table t\nJOIN   oceanbase.__all_virtual_database d\nWHERE  t_opt.ret_code != 0\nAND    task_opt.task_id = t_opt.task_id\nAND    task_opt.tenant_id = t_opt.tenant_id\nAND    t_opt.tenant_id = t.tenant_id\nAND    t_opt.table_id = t.table_id\nAND    t.tenant_id = d.tenant_id\nAND    t.database_id = d.database_id\nAND    t_opt.table_id > 200000;\n\n\n-- Execute the following SQL statement in a MySQL tenant to query this information of the tenant:\n\nSELECT task_opt.task_id,\n       task_opt.start_time AS task_start_time,\n       task_opt.end_time   AS task_end_time,\n       t_opt.owner,\n       t_opt.table_name,\n       t_opt.start_time,\n       t_opt.end_time,\n       t_opt.memory_used,\n       t_opt.stat_refresh_failed_list,\n       t_opt.properties\nFROM   (SELECT task_id,\n            start_time,\n            end_time\n     FROM   oceanbase.dba_ob_task_opt_stat_gather_history\n     WHERE  start_time > Date_sub(Now(), interval 1 day)\n            AND TYPE = 'AUTO GATHER') task_opt\n    join oceanbase.dba_ob_table_opt_stat_gather_history t_opt\n      ON task_opt.task_id = t_opt.task_id\n         AND t_opt.status != 'SUCCESS'\n         AND owner != 'oceanbase';  \n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Step 3: Troubleshoot and resolve the collection failure as follows:"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"(Most common)"})})," If the collection times out and error ret=-4012 is reported because the target table contains more than 100 million rows, refer to ",(0,s.jsx)(t.a,{href:"#troubleshoot-stuck-collection-caused-by-an-ultra-large-table",children:"Troubleshoot Stuck Collection Caused by an Ultra-large Table"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["If the collection fails because a tenant has too many tables requiring statistics collection but the collection window has a limited duration, you need to manually collect the statistics of the tenant during ",(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"off-peak hours"})}),". For more information about collection strategies, see ",(0,s.jsx)(t.a,{href:"https://oceanbase.github.io/docs/user_manual/operation_and_maintenance/operations_and_maintenance/optimizer_statistics/command",children:"Statements for Manual Statistics Collection"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["If an error other than the timeout error is reported, manually collect the statistics of the target table during ",(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"off-peak hours"})}),". For more information, see ",(0,s.jsx)(t.a,{href:"https://oceanbase.github.io/docs/user_manual/operation_and_maintenance/operations_and_maintenance/optimizer_statistics/command",children:"Statements for Manual Statistics Collection"}),". Then, follow up the collection and report the error to the on-duty engineers of the OceanBase community forum."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"troubleshoot-collection-job-scheduling-failures",children:"Troubleshoot Collection Job Scheduling Failures"}),"\n",(0,s.jsx)(t.p,{children:"You can execute the following SQL statements to check whether the automatic collection jobs are normally scheduled based on tenant types:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"sys tenant (with specified user tenant ID):"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- Check whether the jobs in all windows of the target user tenant are normally scheduled and run in order.\n\nSELECT tenant_id,\n       job_name,\n       what,\n       start_date,\n       this_date,\n       last_date,\n       next_date,\n       enabled\nFROM   oceanbase.__all_virtual_tenant_scheduler_job\nWHERE  tenant_id = {tenant_id}\n    AND job_name IN ( 'MONDAY_WINDOW', 'TUESDAY_WINDOW', 'WEDNESDAY_WINDOW',\n                         'THURSDAY_WINDOW',\n                  'FRIDAY_WINDOW', 'SATURDAY_WINDOW', 'SUNDAY_WINDOW' )\n    AND job != 0; \n\n\n-- Check whether the last job of the target user tenant is successful. The result code 0 indicates success.\n\nSELECT *\nFROM OCEANBASE.__ALL_VIRTUAL_TENANT_SCHEDULER_JOB_RUN_DETAIL\nWHERE tenant_id = {tenant_id}\nORDER BY time;\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"MySQL tenant:"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- Check whether the jobs in all windows of the tenant are normally scheduled and run in order.\n\nSELECT job_name,\n       job_action,\n       start_date,\n       last_start_date,\n       next_run_date,\n       enabled\nFROM   oceanbase.dba_scheduler_jobs\nWHERE  job_name IN ( 'MONDAY_WINDOW', 'TUESDAY_WINDOW', 'WEDNESDAY_WINDOW',\n                  'THURSDAY_WINDOW',\n                  'FRIDAY_WINDOW', 'SATURDAY_WINDOW', 'SUNDAY_WINDOW' ); \n\n-- Check whether the last job of the tenant is successful. The result code 0 indicates success.\n\nSELECT *\nFROM OCEANBASE.__ALL_TENANT_SCHEDULER_JOB_RUN_DETAIL\nORDER BY time;\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If the scheduling is abnormal, report the issue to the on-duty engineers of the OceanBase community forum."}),"\n",(0,s.jsx)(t.h2,{id:"troubleshoot-stuck-collection-caused-by-an-ultra-large-table",children:"Troubleshoot Stuck Collection Caused by an Ultra-large Table"}),"\n",(0,s.jsxs)(t.p,{children:["The automatic statistics collection for many tenants fails due to slow collection on an ultra-large table. This issue can be troubleshot by using the method described in ",(0,s.jsx)(t.a,{href:"#troubleshoot-collection-job-execution-failures",children:"Troubleshoot collection job execution failures"}),". If an ultra-large table causes the failure, use the following strategy to fix the issue:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["Step 1: Execute the following SQL statements to query the collection status of the ultra-large table within the previous period of time and check whether each collection on the ultra-large table is time-consuming. For the query in the sys tenant, a non-zero value of the ",(0,s.jsx)(t.code,{children:"ret_code"})," parameter indicates a collection failure. For the query in a user tenant, a NULL value or a value other than 'SUCCESS' of the ",(0,s.jsx)(t.code,{children:"status"})," parameter indicates a collection failure."]})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- sys tenant\n\nSELECT *\nFROM   oceanbase.__all_virtual_table_opt_stat_gather_history\nWHERE  table_id = {table_id}\nORDER  BY start_time; \n-- MySQL tenant\n\nSELECT *\nFROM   oceanbase.dba_ob_table_opt_stat_gather_history\nWHERE  table_name = '{table_name}'\nORDER  BY start_time;\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Step 2: Modify the statistics collection strategies of ultra-large tables. For more information, see"})," ",(0,s.jsx)(t.a,{href:"#modify-the-statistics-collection-strategies-of-ultra-large-tables",children:"Modify the statistics collection strategies of ultra-large tables"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Step 3: After the collection strategies are modified, determine whether to manually collect statistics of the large table again based on the actual situation. When most statistics of the table are outdated and the plans generated for queries that require accessing the table are not optimal, increase the degree of parallelism (DOP) for statistics collection if the system resources are sufficient. In other cases, you can execute the following SQL statement to check whether the automatic statistics collection can be successfully performed based on the modified strategies:"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-plsql",children:"-- MySQL tenant\n-- To ensure stability, this collection does not refresh relevant plans in the plan cache.\ncall dbms_stats.gather_table_stats('database_name','table_name', no_invalidate=>true);              \n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["Step 4: If the issue of stuck collection has frequently occurred for the tenant, you can check whether the statistics on most tables in the tenant are missing or outdated. If so, manually collect the statistics on the tables during ",(0,s.jsx)("font",{color:"red",children:"off-peak hours"}),". For more information, see ",(0,s.jsx)(t.a,{href:"#quickly-query-tables-with-outdated-or-missing-statistics-in-the-current-tenant",children:"Quickly query tables with outdated or missing statistics in the current tenant"})," and ",(0,s.jsx)(t.a,{href:"https://oceanbase.github.io/docs/user_manual/operation_and_maintenance/operations_and_maintenance/optimizer_statistics/command",children:"Statements for Manual Statistics Collection"}),"."]})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["Step 5: Modify the start time of automatic statistics collection jobs. ",(0,s.jsx)("font",{color:"red",children:"We recommend that the collection is performed after the daily compaction during off-peak hours"}),". For more information, see ",(0,s.jsx)(t.a,{href:"#modify-the-scheduling-time-of-automatic-statistics-collection-jobs",children:"Modify the Scheduling Time of Automatic Statistics Collection Jobs"}),"."]})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If you have any questions about the preceding steps or encounter any issues during actual operations, contact the on-duty engineers of the OceanBase community forum."}),"\n",(0,s.jsx)(t.h2,{id:"common-om-methods-of-statistics",children:"Common O&M Methods of Statistics"}),"\n",(0,s.jsx)(t.h3,{id:"disable-and-enable-automatic-statistics-collection",children:"Disable and enable automatic statistics collection"}),"\n",(0,s.jsx)(t.p,{children:"You can execute the following statements to disable or enable automatic statistics collection. Note that you need to re-configure the collection jobs as needed after automatic statistics collection is enabled."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant:\n-- Disable automatic statistics collection:\ncall dbms_scheduler.disable('MONDAY_WINDOW');\ncall dbms_scheduler.disable('TUESDAY_WINDOW');\ncall dbms_scheduler.disable('WEDNESDAY_WINDOW');\ncall dbms_scheduler.disable('THURSDAY_WINDOW');\ncall dbms_scheduler.disable('FRIDAY_WINDOW');\ncall dbms_scheduler.disable('SATURDAY_WINDOW');\ncall dbms_scheduler.disable('SUNDAY_WINDOW');\n\n-- Enable automatic statistics collection:\ncall dbms_scheduler.enable('MONDAY_WINDOW');\ncall dbms_scheduler.enable('TUESDAY_WINDOW');\ncall dbms_scheduler.enable('WEDNESDAY_WINDOW');\ncall dbms_scheduler.enable('THURSDAY_WINDOW');\ncall dbms_scheduler.enable('FRIDAY_WINDOW');\ncall dbms_scheduler.enable('SATURDAY_WINDOW');\ncall dbms_scheduler.enable('SUNDAY_WINDOW');\n"})}),"\n",(0,s.jsx)(t.h3,{id:"quickly-query-tables-with-outdated-or-missing-statistics-in-the-current-tenant",children:"Quickly query tables with outdated or missing statistics in the current tenant"}),"\n",(0,s.jsx)(t.p,{children:"You can execute the following statement to query tables whose statistics are missing or outdated in a user tenant and sort the tables by their data amount:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant\n\nSELECT v2.database_name,\n       v2.table_name,\n       Sum(inserts - deletes) row_cnt\nFROM   oceanbase.dba_tab_modifications v1,\n       (SELECT DISTINCT database_name AS DATABASE_NAME,\n                        table_name    AS table_name\n        FROM   oceanbase.dba_ob_table_stat_stale_info\n        WHERE  is_stale = 'YES'\n               AND database_name != 'oceanbase') v2\nWHERE  v1.table_name = v2.table_name\nGROUP  BY v2.database_name,\n          v2.table_name\nORDER  BY row_cnt; \n"})}),"\n",(0,s.jsx)(t.h3,{id:"modify-the-statistics-collection-strategies-of-ultra-large-tables",children:"Modify the statistics collection strategies of ultra-large tables"}),"\n",(0,s.jsx)(t.p,{children:"The statistics collection on ultra-large tables is time-consuming due to the following reasons:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"The tables contain a large amount of data. Therefore, full table scans take a long time during statistics collection."})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"The histogram collection involves complex computations, which causes extra costs."})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsxs)(t.strong,{children:["By default, statistics and histograms are collected from subpartitions, partitions, and whole tables of large partitioned tables. The cost is equal to 3 \xd7 (full table scan cost + histogram collection cost). ",(0,s.jsx)("font",{color:"red",children:"This issue is optimized only for OceanBase V4.2.2 and later"})]}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"In view of the preceding reasons, you can optimize statistics collection configurations based on your business requirements and the actual situation of tables by using the following methods:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Set an appropriate default DOP for statistics collection. Note that you must schedule the automatic statistics collection job to run during off-peak hours to prevent your business from being affected. For more information, see ",(0,s.jsx)(t.a,{href:"#modify-the-scheduling-time-of-automatic-statistics-collection-jobs",children:"Modify the Scheduling Time of Automatic Statistics Collection Jobs"}),". ",(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"We recommend that you set the DOP to 8 or a smaller value."})})," Here is an example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant:\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'degree', '8');\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Set the default histogram collection method for columns. We recommend that you do not collect histograms on columns in which data is evenly distributed."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant\n\n-- 1. If data is evenly distributed in all columns of the table, you can skip histogram collection on all columns. Here is an example:\n\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'method_opt', 'for all columns size 1');\n\n-- 2. If data is unevenly distributed in a few columns of the table, you can collect histograms on these columns and skip histogram collection on other columns. The following sample statement shows how to collect histograms on the `c1` and `c2` columns and skip histogram collection on the `c3`, `c4`, and `c5` columns:\n\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'method_opt', 'for columns c1 size 254, c2 size 254, c3 size 1, c4 size 1, c5 size 1');\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Set the default statistics collection granularity for partitioned tables. For HASH-partitioned tables and KEY-partitioned tables, you can collect only global statistics or deduce global statistics based on partition-level statistics. Here is an example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant\n\n-- 1. Collect only global statistics:\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'granularity', 'GLOBAL');\n\n-- 2. Deduce global statistics based on partition-level statistics:\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'granularity', 'APPROX_GLOBAL AND PARTITION');\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"Use large-table sampling with caution. When you use large-table sampling to collect statistics, the number of histogram samples becomes very large, which lowers collection efficiency. Large-table sampling is suitable for the collection of basic statistics instead of histograms."})})," Here is an example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- MySQL tenant\n\n-- 1. Skip histogram collection on all columns:\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'method_opt', 'for all columns size 1');\n\n-- 2. Set the sampling ratio to 10%:\ncall dbms_stats.set_table_prefs('database_name', 'table_name', 'estimate_percent', '10');\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If you want to clear or delete a default statistics collection strategy that you specified, specify only the attribute to be deleted. Here is an example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- Delete the \"granularity\" attribute in a MySQL tenant:\n\ncall dbms_stats.delete_table_prefs('database_name', 'table_name', 'granularity');\n"})}),"\n",(0,s.jsx)(t.p,{children:"After you set a statistics collection strategy, you can query whether it has taken effect. Here is an example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- Query the specified \"degree\" attribute in a MySQL tenant:\n\nselect dbms_stats.get_prefs('degree', 'database_name','table_name') from dual;\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You can also lock statistics after you manually collect the statistics on ultra-large tables. For more information, see ",(0,s.jsx)(t.a,{href:"#lock-statistics-to-prevent-statistics-updates",children:"Lock statistics to prevent statistics updates"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"lock-statistics-to-prevent-statistics-updates",children:"Lock statistics to prevent statistics updates"}),"\n",(0,s.jsx)(t.p,{children:"If the overall data distribution of a table does not significantly change and you want to maintain stability of query plans that require accessing the table, you can execute the following statements to lock and unlock the table statistics:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"-- Lock the statistics on a table in a MySQL tenant:\ncall dbms_stats.lock_table_stats('database_name', 'table_name');\n\n-- Unlock the statistics on a table in a MySQL tenant:\ncall dbms_stats.unlock_table_stats('database_name', 'table_name');\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"Note that the locked statistics are not automatically updated. This is suitable for scenarios with slight data changes and insensitive to data values."})})," If you want to recollect the locked statistics, you must unlock the statistics first."]}),"\n",(0,s.jsx)(t.h3,{id:"modify-the-strategies-for-slow-statistics-collection",children:"Modify the strategies for slow statistics collection"}),"\n",(0,s.jsx)(t.p,{children:"If the statistics collection of a table is very slow, you can perform the following operations to modify the collection strategies:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)("font",{color:"red",children:"Disable histogram collection"})}),". Histogram collection is the most time-consuming operation and histograms are not very necessary in many scenarios. You can execute the following statement to skip histogram collection for all columns in the specified table by setting the ",(0,s.jsx)(t.code,{children:"method_opt"})," option to ",(0,s.jsx)(t.code,{children:"for all columns size 1"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"call dbms_stats.set_table_prefs('database_name', \n                                 'table_name', \n                                 'method_opt', \n                                 'for all columns size 1');\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsxs)("font",{color:"red",children:["Increase the DOP by specifying the ",(0,s.jsx)(t.code,{children:"degree"})," option"]})}),". You can increase the DOP of statistics collection during off-peak hours to accelerate the collection."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Specify to deduce global statistics based on partition-level statistics."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["In addition, ",(0,s.jsx)(t.strong,{children:(0,s.jsxs)("font",{color:"red",children:["we recommend that you do not modify the ",(0,s.jsx)(t.code,{children:"estimate_percent"})," option"]})}),". By default, histograms are collected based on the calculation result of a small amount of sample data. If you modify this option, a large amount of data may be sampled. This significantly slows down histogram collection and decreases the accuracy of collected basic statistics."]}),"\n",(0,s.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001718186",children:"Statistical information and row estimation"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://ask.oceanbase.com/",children:"OceanBase community forum"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>l});var s=n(96540);const a={},i=s.createContext(a);function o(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);