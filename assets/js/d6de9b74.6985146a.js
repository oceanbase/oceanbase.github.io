"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[2564],{23295:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>r,contentTitle:()=>d,default:()=>l,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var _=t(74848),a=t(28453);const i={title:"\u79df\u6237\u7ba1\u7406",weight:3},d=void 0,s={id:"user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/tenant_management",title:"\u79df\u6237\u7ba1\u7406",description:"\u67e5\u770b\u79df\u6237\u57fa\u7840\u4fe1\u606f",source:"@site/docs/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/03_tenant_management.md",sourceDirName:"user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql",slug:"/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/tenant_management",permalink:"/docs/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/tenant_management",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/03_tenant_management.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"\u79df\u6237\u7ba1\u7406",weight:3},sidebar:"operation_and_maintenanceSidebar",previous:{title:"\u96c6\u7fa4\u8fd0\u7ef4",permalink:"/docs/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/cluster_operations"},next:{title:"\u7528\u6237\u53ca\u6743\u9650\u7ba1\u7406",permalink:"/docs/user_manual/operation_and_maintenance/operations_and_maintenance/commonly_used_sql/user_and_privilege_management"}},r={},o=[{value:"\u67e5\u770b\u79df\u6237\u57fa\u7840\u4fe1\u606f",id:"\u67e5\u770b\u79df\u6237\u57fa\u7840\u4fe1\u606f",level:2},{value:"\u67e5\u8be2 Unit \u89c4\u683c\u5217\u8868",id:"\u67e5\u8be2-unit-\u89c4\u683c\u5217\u8868",level:2},{value:"\u67e5\u8be2\u8d44\u6e90\u6c60\u5217\u8868",id:"\u67e5\u8be2\u8d44\u6e90\u6c60\u5217\u8868",level:2},{value:"\u67e5\u8be2 Unit \u5217\u8868",id:"\u67e5\u8be2-unit-\u5217\u8868",level:2},{value:"\u67e5\u770b\u79df\u6237\u5df2\u4f7f\u7528\u78c1\u76d8\u8d44\u6e90",id:"\u67e5\u770b\u79df\u6237\u5df2\u4f7f\u7528\u78c1\u76d8\u8d44\u6e90",level:2},{value:"\u67e5\u770b\u79df\u6237\u6570\u636e\u91cf",id:"\u67e5\u770b\u79df\u6237\u6570\u636e\u91cf",level:2},{value:"\u67e5\u770b\u79df\u6237\u8868\u5927\u5c0f\u7edf\u8ba1",id:"\u67e5\u770b\u79df\u6237\u8868\u5927\u5c0f\u7edf\u8ba1",level:2},{value:"\u79df\u6237 partition/leader \u5206\u5e03\u60c5\u51b5",id:"\u79df\u6237-partitionleader-\u5206\u5e03\u60c5\u51b5",level:2},{value:"MySQL \u6a21\u5f0f\u67e5\u8be2\u6570\u636e\u5e93\u5217\u8868",id:"mysql-\u6a21\u5f0f\u67e5\u8be2\u6570\u636e\u5e93\u5217\u8868",level:2},{value:"\u7edf\u8ba1\u79df\u6237\u8868\u6570\u91cf",id:"\u7edf\u8ba1\u79df\u6237\u8868\u6570\u91cf",level:2}];function c(n){const e={code:"code",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...n.components};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(e.h2,{id:"\u67e5\u770b\u79df\u6237\u57fa\u7840\u4fe1\u606f",children:"\u67e5\u770b\u79df\u6237\u57fa\u7840\u4fe1\u606f"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  tenant_id,\n  tenant_name,\n  tenant_type,\n  primary_zone,\n  locality,\n  compatibility_mode,\n  status,\n  0 AS locked,\n  in_recyclebin,\n  timestampdiff(\n    second,\n    create_time,\n    now()\n  ) AS exist_seconds\nFROM\n  dba_ob_tenants\nWHERE\n  tenant_type IN ('SYS', 'USER');\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u8be2-unit-\u89c4\u683c\u5217\u8868",children:"\u67e5\u8be2 Unit \u89c4\u683c\u5217\u8868"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  unit_config_id,\n  name,\n  max_cpu,\n  min_cpu,\n  round(memory_size / 1024 / 1024 / 1024) max_memory_size_gb,\n  round(memory_size / 1024 / 1024 / 1024) min_memory_size_gb,\n  round(log_disk_size / 1024 / 1024 / 1024) log_disk_size_gb,\n  max_iops,\n  min_iops,\n  iops_weight\nFROM\n  dba_ob_unit_configs\nORDER BY\n  unit_config_id;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u8be2\u8d44\u6e90\u6c60\u5217\u8868",children:"\u67e5\u8be2\u8d44\u6e90\u6c60\u5217\u8868"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /* MONITOR_AGENT */\n  p.tenant_id,\n  u.svr_ip,\n  uc.name,\n  uc.max_cpu,\n  uc.min_cpu,\n  round(uc.memory_size / 1024 / 1024 / 1024) AS max_memory_gb,\n  round(uc.log_disk_size / 1024 / 1024 / 1024) AS log_disk_size_gb,\n  uc.max_iops,\n  uc.min_iops\nFROM\n  dba_ob_resource_pools p,\n  dba_ob_unit_configs uc,\n  dba_ob_units u\nWHERE\n  p.unit_config_id = uc.unit_config_id\n  AND u.resource_pool_id = p.resource_pool_id\nORDER BY\n  p.tenant_id,\n  u.svr_ip,\n  uc.name;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u8be2-unit-\u5217\u8868",children:"\u67e5\u8be2 Unit \u5217\u8868"}),"\n",(0,_.jsxs)(e.p,{children:[(0,_.jsx)(e.code,{children:"root@sys"})," \u767b\u9646\u67e5\u8be2\uff0c"]}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  tenant_id,\n  svr_ip,\n  svr_port,\n  unit_id,\n  status,\n  create_time,\n  modify_time,\n  zone,\n  unit_config_id,\n  max_cpu,\n  min_cpu,\n  round(memory_size / 1024 / 1024 / 1024) memory_size_gb,\n  round(log_disk_size / 1024 / 1024 / 1024) log_disk_size_gb,\n  max_iops,\n  min_iops\nFROM\n  dba_ob_units\nORDER BY\n  tenant_id,\n  svr_ip,\n  svr_port,\n  unit_id;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u770b\u79df\u6237\u5df2\u4f7f\u7528\u78c1\u76d8\u8d44\u6e90",children:"\u67e5\u770b\u79df\u6237\u5df2\u4f7f\u7528\u78c1\u76d8\u8d44\u6e90"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  t1.unit_id,\n  t1.svr_ip,\n  t1.svr_port,\n  t3.tenant_id,\n  t3.tenant_name,\n  round(t1.log_disk_size / 1024 / 1024 / 1024) AS log_disk_size_gb,\n  round(t1.log_disk_in_use / 1024 / 1024 / 1024) AS log_disk_in_use_gb,\n  round(t1.data_disk_in_use / 1024 / 1024 / 1024) AS data_disk_in_use_gb\nFROM\n  (\n    SELECT\n      unit_id,\n      svr_ip,\n      svr_port,\n      SUM(log_disk_size) AS log_disk_size,\n      SUM(log_disk_in_use) AS log_disk_in_use,\n      SUM(data_disk_in_use) AS data_disk_in_use\n    FROM\n      gv$ob_units\n    GROUP BY\n      unit_id,\n      svr_ip,\n      svr_port\n  ) t1\n  JOIN dba_ob_units t2 ON t1.unit_id = t2.unit_id\n  AND t1.svr_ip = t2.svr_ip\n  AND t1.svr_port = t2.svr_port\n  JOIN (\n    SELECT\n      tenant_id,\n      tenant_name\n    FROM\n      dba_ob_tenants\n    WHERE\n      tenant_type IN ('SYS', 'USER')\n  ) t3 ON t2.tenant_id = t3.tenant_id\nORDER BY\n  t3.tenant_id,\n  t1.svr_ip,\n  t1.svr_port,\n  t1.unit_id;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u770b\u79df\u6237\u6570\u636e\u91cf",children:"\u67e5\u770b\u79df\u6237\u6570\u636e\u91cf"}),"\n",(0,_.jsxs)(e.p,{children:[(0,_.jsx)(e.code,{children:"root@sys"})," \u767b\u9646\u67e5\u8be2\uff0c"]}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  tenant_id,\n  svr_ip,\n  svr_port,\n  round(SUM(data_size) / 1024 / 1024) data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) required_size_mb\nFROM\n  cdb_ob_tablet_replicas\nWHERE\n  tenant_id = 1002\nGROUP BY\n  tenant_id,\n  svr_ip,\n  svr_port\nORDER BY\n  tenant_id,\n  svr_ip,\n  svr_port;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u7528\u6237\u79df\u6237\u4e0b\uff0c\u6267\u884c\u5982\u4e0b  SQL\uff0c"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  svr_ip,\n  svr_port,\n  round(SUM(data_size) / 1024 / 1024) data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) required_size_mb\nFROM\n  dba_ob_tablet_replicas\nGROUP BY\n  svr_ip,\n  svr_port\nORDER BY\n  svr_ip,\n  svr_port;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u67e5\u770b\u79df\u6237\u8868\u5927\u5c0f\u7edf\u8ba1",children:"\u67e5\u770b\u79df\u6237\u8868\u5927\u5c0f\u7edf\u8ba1"}),"\n",(0,_.jsxs)(e.p,{children:[(0,_.jsx)(e.code,{children:"root@sys"})," \u767b\u9646\u67e5\u8be2\uff0c"]}),"\n",(0,_.jsx)(e.p,{children:"\u7531\u4e8e\u89c6\u56fe\u67e5\u8be2\u6709\u6027\u80fd\u95ee\u9898\uff0c\u6700\u597d\u6307\u5b9a tenant_id \u548c\u5176\u4ed6\u53c2\u6570\u3002"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ READ_CONSISTENCY(WEAK) QUERY_TIMEOUT(50000000) */\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port,\n  c.object_type,\n  round(SUM(data_size) / 1024 / 1024) AS data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) AS required_size_mb\nFROM\n  cdb_ob_table_locations a\n  JOIN (\n    SELECT\n      tenant_id,\n      tablet_id,\n      svr_ip,\n      svr_port,\n      data_size,\n      required_size\n    FROM\n      cdb_ob_tablet_replicas\n  ) b ON a.tenant_id = b.tenant_id\n   AND a.tenant_id = 1002\n--   AND a.database_name = 'ALVIN'\n  AND a.tablet_id = b.tablet_id\n  AND a.svr_ip = b.svr_ip\n  AND a.svr_port = b.svr_port\n  JOIN cdb_objects c ON a.tenant_id = c.con_id\n  AND a.table_id = c.object_id\n  AND c.object_type = 'TABLE'\n--   AND c.object_name = 'test'\nGROUP BY\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port,\n  c.object_type\nORDER BY\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u5982\u6709\u6027\u80fd\u95ee\u9898 (\u4ee5\u4e0b SQL \u5feb 10 \u500d\u4ee5\u4e0a)\uff0c\u53ef\u4ee5\u4e0d\u4f7f\u7528\u89c6\u56fe\u67e5\u8be2\uff0c\u6307\u5b9a tenant_id \u67e5\u8be2\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ READ_CONSISTENCY(WEAK) QUERY_TIMEOUT(50000000) */\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port,\n  round(SUM(data_size) / 1024 / 1024) AS data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) AS required_size_mb\nFROM\n  cdb_ob_table_locations a\n  JOIN (\n    SELECT\n      tenant_id,\n      tablet_id,\n      svr_ip,\n      svr_port,\n      data_size,\n      required_size\n    FROM\n      __all_virtual_tablet_meta_table\n  ) b ON a.tenant_id = b.tenant_id\n  AND a.tenant_id = 1002\n  AND a.tablet_id = b.tablet_id\n  AND a.svr_ip = b.svr_ip\n  AND a.svr_port = b.svr_port\n  JOIN __all_virtual_table c ON a.tenant_id = c.tenant_id\n  AND a.table_id = c.table_id\nGROUP BY\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port\nORDER BY\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u6307\u5b9a tenant_id \u548c database_name\uff0c\u6309 table \u5927\u5c0f\u6392\u5e8f\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ READ_CONSISTENCY(WEAK) QUERY_TIMEOUT(50000000) */\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port,\n  c.object_type,\n  c.object_name,\n  round(SUM(data_size) / 1024 / 1024) AS data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) AS required_size_mb\nFROM\n  cdb_ob_table_locations a\n  JOIN (\n    SELECT\n      tenant_id,\n      tablet_id,\n      svr_ip,\n      svr_port,\n      data_size,\n      required_size\n    FROM\n      cdb_ob_tablet_replicas\n  ) b ON a.tenant_id = b.tenant_id\n  AND a.tenant_id = 1012\n  AND a.database_name = 'ALVIN'\n  AND a.tablet_id = b.tablet_id\n  AND a.svr_ip = b.svr_ip\n  AND a.svr_port = b.svr_port\n  JOIN cdb_objects c ON a.tenant_id = c.con_id\n  AND a.table_id = c.object_id\n  AND c.object_type = 'TABLE'\n--   AND c.object_name = 'test'\nGROUP BY\n  a.tenant_id,\n  a.svr_ip,\n  a.svr_port,\n  c.object_type,\n  c.object_name\nORDER BY\n  required_size_mb DESC\nLIMIT\n  100;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u7528\u6237\u79df\u6237\u4e0b\uff0c\u6267\u884c\u5982\u4e0b  SQL\uff0c"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ READ_CONSISTENCY(WEAK) QUERY_TIMEOUT(50000000) */\n  a.svr_ip,\n  a.svr_port,\n  a.database_name,\n  c.object_type,\n  c.object_name,\n  round(SUM(data_size) / 1024 / 1024) AS data_size_mb,\n  round(SUM(required_size) / 1024 / 1024) AS required_size_mb\nFROM\n  dba_ob_table_locations a\n  JOIN (\n    SELECT\n      tablet_id,\n      svr_ip,\n      svr_port,\n      data_size,\n      required_size\n    FROM\n      dba_ob_tablet_replicas\n  ) b ON a.tablet_id = b.tablet_id\n  AND a.database_name = 'SYS'\n  AND a.svr_ip = b.svr_ip\n  AND a.svr_port = b.svr_port\n  JOIN dba_objects c ON a.table_id = c.object_id\n  AND c.object_type = 'TABLE'\n  AND c.object_name = 'TEST'\nGROUP BY\n  a.svr_ip,\n  a.svr_port,\n  a.database_name,\n  c.object_type,\n  c.object_name\nORDER BY\n  required_size_mb DESC;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u79df\u6237-partitionleader-\u5206\u5e03\u60c5\u51b5",children:"\u79df\u6237 partition/leader \u5206\u5e03\u60c5\u51b5"}),"\n",(0,_.jsxs)(e.p,{children:[(0,_.jsx)(e.code,{children:"root@sys"})," \u767b\u9646\u67e5\u8be2\uff0c"]}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  zone,\n  svr_ip,\n  role,\n  COUNT(1) cnt\nFROM\n  cdb_ob_table_locations\nWHERE\n  tenant_id = 1012\nGROUP BY\n  svr_ip,\n  role\nORDER BY\n  1,\n  3 DESC;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u6307\u5b9a tenant_id, database_name, object_name\uff0c\u67e5\u8be2 leader\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  *\nFROM\n  cdb_ob_table_locations a\nWHERE\n  a.tenant_id = 1012\n  AND a.database_name = 'ALVIN'\n  AND (a.tenant_id, a.table_id) IN (\n    SELECT\n      c.con_id,\n      c.object_id\n    FROM\n      cdb_objects c\n    WHERE\n      c.con_id = a.tenant_id\n      AND c.object_type = 'TABLE'\n      AND c.object_name = 'test'\n  )\nLIMIT\n  100;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u6307\u5b9a tenant_id, database_name, object_name\uff0c\u67e5\u8be2 tablet replica\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  *\nFROM\n  cdb_ob_tablet_replicas r\nWHERE\n  (r.tenant_id, r.tablet_id) IN (\n    SELECT\n      a.tenant_id,\n      a.tablet_id\n    FROM\n      cdb_ob_table_locations a\n    WHERE\n      a.tenant_id = 1012\n      AND a.database_name = 'ALVIN'\n      AND (a.tenant_id, a.table_id) IN (\n        SELECT\n          c.con_id,\n          c.object_id\n        FROM\n          cdb_objects c\n        WHERE\n          c.con_id = a.tenant_id\n          AND c.object_type = 'TABLE'\n          AND c.object_name = 'test'\n      )\n  )\nLIMIT\n  100;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"mysql-\u6a21\u5f0f\u67e5\u8be2\u6570\u636e\u5e93\u5217\u8868",children:"MySQL \u6a21\u5f0f\u67e5\u8be2\u6570\u636e\u5e93\u5217\u8868"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  o.created AS gmt_create,\n  o.object_id AS database_id,\n  d.database_name,\n  c.id AS collation_type,\n  c.character_set_name,\n  c.collation_name,\n  NULL AS primary_zone,\n  0 AS read_only\nFROM\n  dba_ob_databases d\n  JOIN dba_objects o ON o.object_type = 'DATABASE'\n  JOIN information_schema.collations c ON d.database_name = o.object_name\n  AND d.collation = c.collation_name;\n"})}),"\n",(0,_.jsx)(e.h2,{id:"\u7edf\u8ba1\u79df\u6237\u8868\u6570\u91cf",children:"\u7edf\u8ba1\u79df\u6237\u8868\u6570\u91cf"}),"\n",(0,_.jsx)(e.p,{children:"\u67e5\u8be2\u975e META \u79df\u6237\u7684\u8868\u6570\u91cf\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ MONITOR_AGENT QUERY_TIMEOUT(100000000) */\n  t.tenant_id,\n  c.owner,\n  COUNT(*) AS cnt\nFROM\n  cdb_tables c\n  JOIN dba_ob_tenants t ON c.con_id = t.tenant_id\n  AND tenant_type IN ('SYS', 'USER')\n  AND c.owner NOT IN ('oceanbase', 'mysql')\nGROUP BY\n  t.tenant_id,\n  c.owner\nORDER BY\n  t.tenant_id,\n  c.owner;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u67e5\u8be2\u975e META \u79df\u6237\u7684\u8868\u6570\u91cf\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ MONITOR_AGENT QUERY_TIMEOUT(100000000) */\n  t.tenant_id,\n  COUNT(*) AS cnt\nFROM\n  cdb_tables c\n  JOIN dba_ob_tenants t ON c.con_id = t.tenant_id\n  AND tenant_type IN ('SYS', 'USER')\nGROUP BY\n  t.tenant_id\nORDER BY\n  t.tenant_id;\n"})}),"\n",(0,_.jsx)(e.p,{children:"\u67e5\u8be2\u6240\u6709\u79df\u6237\u7684\uff1a"}),"\n",(0,_.jsx)(e.pre,{children:(0,_.jsx)(e.code,{children:"SELECT\n  /*+ MONITOR_AGENT QUERY_TIMEOUT(100000000) */\n  con_id tenant_id,\n  COUNT(*) AS cnt\nFROM\n  cdb_tables\nGROUP BY\n  con_id\nORDER BY\n  con_id;\n"})})]})}function l(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,_.jsx)(e,{...n,children:(0,_.jsx)(c,{...n})}):c(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>d,x:()=>s});var _=t(96540);const a={},i=_.createContext(a);function d(n){const e=_.useContext(i);return _.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:d(n.components),_.createElement(i.Provider,{value:e},n.children)}}}]);