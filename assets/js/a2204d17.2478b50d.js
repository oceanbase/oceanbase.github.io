"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[7428],{54272:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>r,contentTitle:()=>o,default:()=>h,frontMatter:()=>n,metadata:()=>c,toc:()=>l});var a=s(74848),i=s(28453);const n={title:"Best Practices for Statistics Collection",weight:2},o=void 0,c={id:"user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/best_practices",title:"Best Practices for Statistics Collection",description:"Note: At present, OceanBase Advanced Tutorial for DBAs applies only to OceanBase Database Community Edition V4.x. Features of Oracle tenants of OceanBase Database Enterprise Edition are not described in this topic. For more information about the differences between the two editions, see Differences between Enterprise Edition and Community Edition.",source:"@site/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/02_best_practices.md",sourceDirName:"user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics",slug:"/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/best_practices",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/best_practices",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/02_best_practices.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Best Practices for Statistics Collection",weight:2},sidebar:"operation_and_maintenanceEnglishSidebar",previous:{title:"Statistics O&M Manual",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/operations_and_maintenance"},next:{title:"Statements for Manual Statistics Collection",permalink:"/docs/user_manual/operation_and_maintenance/en-US/operations_and_maintenance/optimizer_statistics/command"}},r={},l=[{value:"Purpose of Statistics Collection",id:"purpose-of-statistics-collection",level:2},{value:"Default Statistics Collection Strategies",id:"default-statistics-collection-strategies",level:2},{value:"Configure Statistics Collection Strategies",id:"configure-statistics-collection-strategies",level:2},{value:"Business peak hours overlap statistics maintenance windows",id:"business-peak-hours-overlap-statistics-maintenance-windows",level:3},{value:"Statistics collection fails to complete due to ultra-large tables",id:"statistics-collection-fails-to-complete-due-to-ultra-large-tables",level:3},{value:"Table statistics are missing for queries initiated immediately after batch data import into a table",id:"table-statistics-are-missing-for-queries-initiated-immediately-after-batch-data-import-into-a-table",level:3},{value:"Partition statistics are missing for queries initiated on the same day as the data import into a partition pre-created by date",id:"partition-statistics-are-missing-for-queries-initiated-on-the-same-day-as-the-data-import-into-a-partition-pre-created-by-date",level:3}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsxs)(t.p,{children:["Note: At present, ",(0,a.jsx)(t.em,{children:"OceanBase Advanced Tutorial for DBAs"})," applies only to OceanBase Database Community Edition V4.x. Features of Oracle tenants of OceanBase Database Enterprise Edition are not described in this topic. For more information about the differences between the two editions, see ",(0,a.jsx)(t.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001714481",children:"Differences between Enterprise Edition and Community Edition"}),"."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"purpose-of-statistics-collection",children:"Purpose of Statistics Collection"}),"\n",(0,a.jsx)(t.p,{children:"Before the optimizer generates and selects the optimal execution plan, it evaluates and compares the execution cost of each available plan. Therefore, it is crucial to increase the accuracy of cost evaluation."}),"\n",(0,a.jsx)(t.p,{children:"The optimizer evaluates the costs of execution plans based on the cost model and the number of rows estimated for each operator. In this process, statistics play a key role. Accurate statistics improve row estimation for operators, which allows the optimizer to estimate costs of execution plans and select the optimal plan in a more efficient manner."}),"\n",(0,a.jsx)(t.p,{children:"Therefore, the accuracy of statistics must be guaranteed."}),"\n",(0,a.jsx)(t.h2,{id:"default-statistics-collection-strategies",children:"Default Statistics Collection Strategies"}),"\n",(0,a.jsx)(t.p,{children:"By default, the system starts to collect statistics from 22:00 on each workday and from 06:00 on weekends. The collection lasts at most 4 hours on workdays and 20 hours on weekends. Each collection duration is called a statistics maintenance window."}),"\n",(0,a.jsxs)(t.p,{children:["In each statistics maintenance window, the optimizer re-collects all outdated statistics on tables or partitions. By default, the statistics on a table or partition are outdated if no statistics on the table or partition are collected or more than ",(0,a.jsx)(t.strong,{children:"10%"})," of rows in the table or partition have been added, deleted, or modified since the last collection. The following table describes the default statistics collection strategies."]}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Preference name"})}),(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Description"})}),(0,a.jsx)(t.th,{children:(0,a.jsx)(t.strong,{children:"Default value"})})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:"degree"}),(0,a.jsx)(t.td,{children:"The degree of parallelism (DOP)."}),(0,a.jsx)(t.td,{children:"1, which indicates single-thread scanning."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:"method_opt"}),(0,a.jsx)(t.td,{children:"The strategy used to collect column-level statistics."}),(0,a.jsx)(t.td,{children:"Collect the statistics on all columns and the histograms of columns with data skew used in WHERE conditions."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:"granularity"}),(0,a.jsx)(t.td,{children:"The granularity of the collection."}),(0,a.jsx)(t.td,{children:"Collect partition-level statistics and deduce global statistics based on the collected partition-level statistics. For non-partitioned tables, global statistics are directly collected."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:"estimate_percent"}),(0,a.jsx)(t.td,{children:"The sampling ratio."}),(0,a.jsx)(t.td,{children:"Collect statistics through a full table scan without sampling."})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:"block_sample"}),(0,a.jsx)(t.td,{children:"Specifies whether to perform block sampling."}),(0,a.jsx)(t.td,{children:"Perform row sampling instead of block sampling."})]})]})]}),"\n",(0,a.jsx)(t.h2,{id:"configure-statistics-collection-strategies",children:"Configure Statistics Collection Strategies"}),"\n",(0,a.jsx)(t.p,{children:"The default statistics collection strategies are applicable to most tables. In certain scenarios, you may need to modify the collection strategies based on your business characteristics. This section describes some common scenarios and corresponding collection strategies."}),"\n",(0,a.jsx)(t.h3,{id:"business-peak-hours-overlap-statistics-maintenance-windows",children:"Business peak hours overlap statistics maintenance windows"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.strong,{children:(0,a.jsx)("font",{color:"red",children:"The default settings of statistics maintenance windows in OceanBase Database follow those in Oracle. However, many domestic business applications still run after 22:00 on working days. If statistics collection starts at 22:00, the SQL statements for statistics collection may preempt resources with business SQL statements, affecting business performance. In this case, you can modify the start time of a statistics maintenance window to avoid overlap with business peak hours. "})})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"-- For example, it is 11:00 on Thursday, March 7, 2024.\n-- You can execute the following statements to start statistics collection at 02:00 every day from Friday:\n\ncall dbms_scheduler.set_attribute(\n    'FRIDAY_WINDOW', 'NEXT_DATE', '2024-03-08 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'SATURDAY_WINDOW', 'NEXT_DATE', '2024-03-09 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'SUNDAY_WINDOW', 'NEXT_DATE', '2024-03-10 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'MONDAY_WINDOW', 'NEXT_DATE', '2024-03-11 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'TUESDAY_WINDOW', 'NEXT_DATE', '2024-03-12 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'WEDNESDAY_WINDOW', 'NEXT_DATE', '2024-03-13 02:00:00');\n\ncall dbms_scheduler.set_attribute(\n    'THURSDAY_WINDOW', 'NEXT_DATE', '2024-03-14 02:00:00');\n\n"})}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"Note: The preceding statements apply only to OceanBase Database tenants in MySQL mode."}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"statistics-collection-fails-to-complete-due-to-ultra-large-tables",children:"Statistics collection fails to complete due to ultra-large tables"}),"\n",(0,a.jsx)(t.p,{children:"When the default statistics collection strategies are used, the system performs a full table scan on tables or partitions whose statistics are to be collected by using a single thread. If a table or partition contains a large amount of data or occupies much disk space, the statistics collection of the table or partition takes a long period of time, which affects that of other tables or even incurs a timeout error."}),"\n",(0,a.jsx)(t.p,{children:"If a table in your business contains more than 100 million rows or occupies more than 20 GB of disk space, we recommend that you configure the statistics collection strategies by using the following methods:"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Skip large objects."}),"\n",(0,a.jsx)(t.p,{children:"In MySQL mode, statistics on LONGTEXT columns are collected by default. If the LONGTEXT columns store large objects (LOBs), the statistics are collected at a slow speed."}),"\n",(0,a.jsx)(t.p,{children:"In the following example, the fourth parameter specifies the columns whose statistics are to be collected. You need to specify all columns except LOB columns."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"call dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'method_opt',\n  'for columns col1,col2,col3,... size auto');\n"})}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Increase the DOP or configure block sampling."}),"\n",(0,a.jsx)(t.p,{children:"If you increase the DOP, more concurrent threads are used to collect statistics. This way, you can achieve quick collection by consuming more resources."}),"\n",(0,a.jsx)(t.p,{children:"Alternatively, you can configure block sampling to reduce the amount of data to be processed during statistics collection."}),"\n",(0,a.jsx)(t.p,{children:"Both methods improve the statistics collection efficiency. The first method trades off resources for statistics accuracy, whereas the second method trades off statistics accuracy for resource availability."}),"\n",(0,a.jsx)(t.p,{children:"You can select a method based on your business requirements."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"-- Configure the DOP of statistics collection.\ncall dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'degree',\n  '4');\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"-- Enable block sampling.\ncall dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'block_sample',\n  'True');\n\n-- Configure a sampling ratio based on the data size of the table. In most cases, you can know the data characteristics of a table after you collect statistics of tens of millions of rows from the table.\ncall dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'estimate_percent',\n  '0.1');\n"})}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Do not collect global statistics on partitioned tables. In the following example, the fourth parameter specifies the level of statistics to be collected. For a partitioned table, you can configure to collect statistics of only partitions. For a subpartitioned table, you can configure to collect statistics of only subpartitions. Note that if you use this strategy, you must delete global statistics for partitioned tables, and delete global and partition-level statistics for subpartitioned tables."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"-- Partitioned tables\ncall dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'granularity',\n  'PARTITION');\n\n-- Subpartitioned tables\ncall dbms_stats.set_table_prefs(\n  'databse_name',\n  'table_name',\n  'granularity',\n  'SUBPARTITION');\n"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"table-statistics-are-missing-for-queries-initiated-immediately-after-batch-data-import-into-a-table",children:"Table statistics are missing for queries initiated immediately after batch data import into a table"}),"\n",(0,a.jsx)(t.p,{children:"By default, statistics are updated only after automatic statistics collection, which is scheduled periodically."}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"OceanBase Database V4.2.4 and versions later than V4.2.5 provide the asynchronous statistics collection capability to address this issue."}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"If a large amount of data is imported into an empty table or small table, as often happens in batch processing scenarios, and the table is then immediately queried, the optimizer may generate a poor plan due to missing or severely outdated statistics."}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.strong,{children:(0,a.jsx)("font",{color:"red",children:'In this case, we recommend that you manually collect the statistics and then perform queries after the data import. If an excessively large amount of data is imported, you can modify the manual collection strategies. For more information, see the "Statistics collection fails to complete due to ultra-large tables" section of this topic. '})})}),"\n",(0,a.jsx)(t.h3,{id:"partition-statistics-are-missing-for-queries-initiated-on-the-same-day-as-the-data-import-into-a-partition-pre-created-by-date",children:"Partition statistics are missing for queries initiated on the same day as the data import into a partition pre-created by date"}),"\n",(0,a.jsx)(t.p,{children:"For a table in which partitions are pre-created by date, the optimizer may fail to collect statistics on some pre-created partitions because the partitions contain no data."}),"\n",(0,a.jsx)(t.p,{children:"If data is imported into such a partition and the imported data is queried on the same day, the optimizer may generate a poor plan due to severely outdated statistics."}),"\n",(0,a.jsx)(t.p,{children:"In this case, we recommend that you manually collect statistics on the partition on the same day after the data import."}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsx)(t.p,{children:"OceanBase Database V4.2.4 and versions later than V4.2.5 provide the asynchronous statistics collection capability to address this issue."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,t,s)=>{s.d(t,{R:()=>o,x:()=>c});var a=s(96540);const i={},n=a.createContext(i);function o(e){const t=a.useContext(n);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(n.Provider,{value:t},e.children)}}}]);