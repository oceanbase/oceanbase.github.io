"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[2417],{68003:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>o,frontMatter:()=>d,metadata:()=>c,toc:()=>_});var s=t(74848),i=t(28453);const d={title:"\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898",weight:14},a="\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898",c={id:"operation_maintenance/how_to_find_traceid",title:"\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898",description:"\u5927\u5bb6\u5728\u4f7f\u7528\u6570\u636e\u5e93\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u9047\u5230\u6162sql\uff0c\u6216\u8005\u6267\u884c\u9519\u8bef\u7684sql\uff0c\u6709\u4e9bsql\u662f\u5f88\u5bb9\u6613\u5224\u65ad\u51fa\u6765\u9519\u8bef\uff0c\u4ee5\u53casql\u8fd0\u884c\u6bd4\u8f83\u6162\u7684\u539f\u56e0\uff0c\u4f46\u662f\u6709\u4e9bsql\u5c31\u5f88\u96be\u5224\u65ad\u51fa\u6765\uff0c\u5982\u679c\u9047\u5230\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u8be5\u600e\u4e48\u5904\u7406\uff0c\u600e\u4e48\u5224\u65adSQL\u51fa\u9519\u539f\u56e0\uff0c\u4ee5\u53ca\u662fSQL\u9700\u8981\u4f18\u5316\uff0c\u6570\u636e\u5e93\u672c\u8eab\u914d\u7f6e\u662f\u5426\u8bbe\u7f6e\u597d\u7b49\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u8ddf\u5927\u5bb6\u7b80\u5355\u4ecb\u7ecd\u4e0b\uff0c\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898\u3002\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b\u4e00\u6761SQL\uff0c\u5728\u8fdb\u5165OceanBase\u6570\u636e\u5e93\u4e2d\u6267\u884c\u65f6\u90fd\u7ecf\u5386\u4e86\u54ea\u4e9b\u6a21\u5757\u3002",source:"@site/docs/operation_maintenance/how_to_find_traceid.md",sourceDirName:"operation_maintenance",slug:"/operation_maintenance/how_to_find_traceid",permalink:"/docs/operation_maintenance/how_to_find_traceid",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/operation_maintenance/how_to_find_traceid.md",tags:[],version:"current",frontMatter:{title:"\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898",weight:14},sidebar:"legacySidebar",previous:{title:"\u901a\u8fc7Prometheus\u76d1\u63a7\u6570\u636e\u5e93\uff08\u624b\u52a8\uff09",permalink:"/docs/operation_maintenance/hand_deploy_prometheus"},next:{title:"OceanBase\u5982\u4f55\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb",permalink:"/docs/operation_maintenance/how_to_split_read_write"}},r={},_=[{value:"<strong>\u8bbf\u95ee\u8def\u5f84</strong>",id:"\u8bbf\u95ee\u8def\u5f84",level:2},{value:"<strong>SQL\u9519\u8bef</strong>",id:"sql\u9519\u8bef",level:2},{value:"<strong>\u6162SQL</strong>",id:"\u6162sql",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dsql\u95ee\u9898",children:(0,s.jsx)(n.strong,{children:"\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898"})}),"\n",(0,s.jsx)(n.p,{children:"\u5927\u5bb6\u5728\u4f7f\u7528\u6570\u636e\u5e93\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u9047\u5230\u6162sql\uff0c\u6216\u8005\u6267\u884c\u9519\u8bef\u7684sql\uff0c\u6709\u4e9bsql\u662f\u5f88\u5bb9\u6613\u5224\u65ad\u51fa\u6765\u9519\u8bef\uff0c\u4ee5\u53casql\u8fd0\u884c\u6bd4\u8f83\u6162\u7684\u539f\u56e0\uff0c\u4f46\u662f\u6709\u4e9bsql\u5c31\u5f88\u96be\u5224\u65ad\u51fa\u6765\uff0c\u5982\u679c\u9047\u5230\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u8be5\u600e\u4e48\u5904\u7406\uff0c\u600e\u4e48\u5224\u65adSQL\u51fa\u9519\u539f\u56e0\uff0c\u4ee5\u53ca\u662fSQL\u9700\u8981\u4f18\u5316\uff0c\u6570\u636e\u5e93\u672c\u8eab\u914d\u7f6e\u662f\u5426\u8bbe\u7f6e\u597d\u7b49\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u8ddf\u5927\u5bb6\u7b80\u5355\u4ecb\u7ecd\u4e0b\uff0c\u5982\u4f55\u5feb\u901f\u5b9a\u4f4dSQL\u95ee\u9898\u3002\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b\u4e00\u6761SQL\uff0c\u5728\u8fdb\u5165OceanBase\u6570\u636e\u5e93\u4e2d\u6267\u884c\u65f6\u90fd\u7ecf\u5386\u4e86\u54ea\u4e9b\u6a21\u5757\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u8bbf\u95ee\u8def\u5f84",children:(0,s.jsx)(n.strong,{children:"\u8bbf\u95ee\u8def\u5f84"})}),"\n",(0,s.jsxs)(n.p,{children:["\u9996\u5148\u6211\u4eec\u4eceSQL\u7684\u8bbf\u95ee\u8def\u5f84\u5f00\u59cb\u4ecb\u7ecd\uff0c\u4e00\u6761SQL\u4ece\u5e94\u7528\u53d1\u51fa\u4e4b\u540e\uff0c\u4e00\u822c\u4f1a\u7ecf\u8fc7\u8d1f\u8f7d\u5747\u8861\uff08\u6839\u636e\u60c5\u51b5\u9009\u62e9\u662f\u5426\u9700\u8981\uff09\uff0c\u7136\u540e\u5230OBProxy\uff0c\u7136\u540e\u518d\u5230OBServer\u3002\u5927\u6982\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a\n",(0,s.jsx)(n.img,{alt:"image.png",src:t(72382).A+"",width:"1628",height:"1202"}),"\nOBProxy\u4e3b\u8981\u8d77\u5230\u4e00\u4e2a\u8def\u7531\u8f6c\u53d1\u7684\u4f5c\u7528\uff0c\u4ee5\u53ca\u5feb\u901f\u89e3\u6790\uff0c\u6839\u636eOceanBase\u6570\u636e\u5e93\u4e2d\u6570\u636e\u526f\u672c\u5206\u5e03\u60c5\u51b5\uff0c\u76f4\u63a5\u5c06\u8bf7\u6c42\u5feb\u901f\u53d1\u9001\u5230\u5bf9\u5e94\u7684OBServer\u4e0a\u3002\nSQL\u5728\u8fdb\u5165OBServer\u4e4b\u540e\uff0c\u8fd8\u4f1a\u7ecf\u5386\u6570\u636e\u5e93\u5185\u90e8\u5f88\u591a\u6a21\u5757\uff0c\u5177\u4f53\u5982\u4e0b\uff1a\n",(0,s.jsx)(n.img,{alt:"image.png",src:t(39733).A+"",width:"465",height:"591"})]}),"\n",(0,s.jsxs)(n.p,{children:["SQL\u7684\u5728\u6570\u636e\u5e93\u5185\u90e8\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u8fd9\u4e9b\u6a21\u5757\u5177\u4f53\u7684\u542b\u4e49\uff0c\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51\u6587\u6863\uff1a",(0,s.jsx)(n.a,{href:"https://www.oceanbase.com/docs/common-oceanbase-database-1000000000033661",children:"SQL \u8bf7\u6c42\u6267\u884c\u6d41\u7a0b"}),"\uff0c\u5728\u6574\u4e2aSQL\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u9996\u5148\u6839\u636eSQL\u7684ip\u3001port\u3001\u81ea\u589e\u5e8f\u5217\u53f7\u7b49\u4fe1\u606f\u751f\u6210\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684trace_id\uff0c\u540e\u7eed\u7684sql\u8ddf\u8e2a\uff0c\u6211\u4eec\u90fd\u4f7f\u7528\u8fd9\u4e2atrace_id\u6765\u5bf9sql\u8fdb\u884c\u5b9a\u4f4d\u8ffd\u8e2a\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"sql\u9519\u8bef",children:(0,s.jsx)(n.strong,{children:"SQL\u9519\u8bef"})}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u79cd\u95ee\u9898\u4e00\u822c\u90fd\u6bd4\u8f83\u597d\u5904\u7406\uff0c\u5927\u591a\u90fd\u662fsql\u5199\u7684\u683c\u5f0f\u4e0d\u5bf9\uff0c\u6216\u8005\u5e93\u3001\u8868\u3001\u5217\u540d\u7b49\u4e0d\u5b58\u5728\uff0c\u6216\u8005OceanBase\u8bed\u6cd5\u4e0d\u652f\u6301\u7b49\uff0c\u4e00\u822c\u60c5\u51b5\uff0c\u6839\u636e\u8fd4\u56de\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5c31\u5927\u81f4\u53ef\u4ee5\u5224\u65ad\u51fa\u9519\u8bef\u539f\u56e0\u3002\n\u4f46\u4e5f\u6709\u4e00\u4e9b\u5f88\u9690\u853d\u7684\u9519\u8bef\uff0c\u4e00\u65f6\u5f88\u96be\u5224\u65ad\u51fa\u5177\u4f53\u662f\u54ea\u91cc\u9519\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u501f\u52a9\u9519\u8bef\u65e5\u5fd7\u6765\u5e2e\u52a9\u6211\u4eec\u8fdb\u884c\u5224\u65ad\u4e86\uff0c\u8fd9\u91cc\u5c31\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8fd9\u662f\u5728\u4e00\u4e2a\u7528\u6237\u90a3\u91cc\u5b9e\u5b9e\u5728\u5728\u9047\u5230\u7684\u95ee\u9898\uff0c\u7528\u6237\u7684\u573a\u666f\u6bd4\u8f83\u590d\u6742\uff0c\u62ffOceanBase\u7528\u6765\u505a\u6570\u636e\u7684\u6e05\u6d17\uff0c\u5c06\u591a\u5f20\u8868\u8fdb\u884c\u5173\u8054\u8ba1\u7b97\uff0c\u7136\u540e\u5c06\u6570\u636e\u5199\u5165\u5230\u7ed3\u679c\u8868\u4e2d\uff0c\u800c\u5728\u6267\u884c\u5176\u4e2d\u4e00\u6761SQL\u8fc7\u7a0b\u4e2d\uff0c\u6536\u5230\u4e86\u8fd9\u6837\u4e00\u4e2a\u62a5\u9519\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"ERROR 1292 (22007): Incorrect value \n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5f53\u65f6\u7528\u6237\u6536\u5230\u8fd9\u4e2a\u62a5\u9519\u540e\u5f88\u832b\u7136\uff0c\u56e0\u4e3a\u7528\u6237\u7684SQL\u957f\u8fbe200\u591a\u884c\uff0c\u5e76\u4e14\u6709\u591a\u5c42\u5d4c\u5957\u5b50\u67e5\u8be2\u548c\u591a\u5f20\u8868\u5173\u8054\u67e5\u8be2\uff0c\u6240\u4ee5\u4e00\u65f6\u95f4\u5f88\u96be\u5224\u65ad\u51fa\u6765\u662f\u54ea\u91cc\u51fa\u73b0\u4e86\u9519\u8bef\uff0cSQL\u5927\u81f4\u5982\u4e0b\uff08\u8131\u654f\u540e\uff09\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"REPLACE INTO abc.table1(\n  m_id,\n  st_id,\n  con_id,\n  `date`,\n  t_ord,\n  t_role,\n  tag,\n  con_pri,\n  con_qu,\n  con_in,\n  update_time\n)\nSELECT \n\ttmp5.m_id,\n\ttmp5.st_id,\n\ttmp5.con_id,\n\ttmp5.`date`,\n\ttmp5.t_ord_96,\n\ttmp5.t_role,\n\ttmp5.tag,\n\tcast(sum(tmp5.con_pri) as decimal(20,6)) as con_pri,\n\tcast(sum(tmp5.con_qu) as decimal(20,6)) as con_qu,\n\tcast(sum(tmp5.con_in) as decimal(20,6)) as con_in,\n\tcurrent_timestamp\nFROM \n\t(\n    SELECT \n    tmp4.m_id,\n    tmp4.st_id,\n    tmp4.con_id,\n    tmp4.`date`,\n    tmp4.t_ord,\n    dstl2.t_ord_96,\n    tmp4.t_role,\n    tmp4.tag,\n    case\n    when tmp4.t_ord = dstl2.t_ord_96 then con_pri\n    else 0\n    end as con_pri,\n    case\n    when tmp4.t_ord = dstl2.t_ord_96 then con_qu\n    else 0\n    end as con_qu,\n    case\n    when tmp4.t_ord = dstl2.t_ord_96 then con_in\n    else 0\n    end as con_in\n    FROM \n    (\n      SELECT\n      tmp3.m_id,\n      tmp3.st_id,\n      tmp3.con_id,\n      tmp3.`date`,\n      tmp3.t_ord_96 as t_ord,\n      tmp3.t_role,\n      tmp3.tag,\n      tmp3.con_pri,\n      cast(tmp3.con_qu as decimal(20,6)) as con_qu,\n      cast(tmp3.con_qu * tmp3.con_pri as decimal(20,6)) as con_in\n      FROM\n      (\n        SELECT \n        tmp2.m_id,\n        tmp2.st_id,\n        tmp2.con_id,\n        tmp2.`date`,\n        tmp2.t_ord_96,\n        case\n        when tmp2.con_name like '%xxx%' then 1\n        when tmp2.con_name like '%x%' then 2\n        when tmp2.con_name like '%xx%' then 3\n        else\n        case\n        when tmp2.contract_type_name like '%xx%' then 4\n        else 5\n        end\n        end as tag,\n        case \n        when tmp2.con_name like '%xxxxx%' then tmp2.vendee_price\n        else tmp2.sale_price\n        end as con_pri,\n        case \n        when tmp2.con_name like '%xxxxx%' then tmp2.vendee_energy\n        else tmp2.sale_energy\n        end as con_qu,\n        tmp2.t_role\n        FROM\n        (\n          select \n          tmp.m_id,\n          tmp.st_id,\n          tmp.st_name,\n          tmp.member_id,\n          tmp.con_id,\n          tmp.con_name,\n          dd.`date`,\n          tmp.t_ord_96,\n          tmp.sale_energy / (datediff(tmp.timepart_endtime, tmp.timepart_starttime) + 1) / tmp.re as sale_energy,\n          tmp.sale_price,\n          tmp.vendee_energy / (datediff(tmp.timepart_endtime, tmp.timepart_starttime) + 1) / tmp.re as vendee_energy,\n          tmp.vendee_price,\n          tmp.timepart_starttime,\n          tmp.timepart_endtime,\n          tmp.seller_member_name,\n          tmp.contract_type_name,\n          tmp.t_role\n          from\n          (\n            select \n            tmp1.*,\n            dstl.t_ord_96,\n            count(1) over(PARTITION by member_id, con_id, time_division_range, timepart_endtime, timepart_starttime) as re\n            from \n            (\n              select \n              distinct \n              spcdp.m_id,\n              ds.st_id,\n              ds.st_name,\n              spcdp.member_id, \n              spcdp.con_id,\n              dc.con_name,\n              spcdp.sale_energy, \n              spcdp.sale_price, \n              spcdp.vendee_energy, \n              spcdp.vendee_price, \n              spcdp.time_division_code,\n              spcdp.time_division_name,\n              case\n              when dc.con_name like '%xx%' then \n              case \n              when substr(date_add(cast(concat('2022-10-01 ', right(spcdp.time_division_range, 5), ':00') as datetime), interval 1 hour), 12, 5) = '00:00' then concat(left(spcdp.time_division_range, 6), '24:00')\n              else concat(left(spcdp.time_division_range, 6), substr(date_add(cast(concat('2022-10-01 ', right(spcdp.time_division_range, 5), ':00') as datetime), interval 1 hour), 12, 5))\n              end\n              else spcdp.time_division_range\n              end as time_division_range, \n              spcdp.timepart_endtime,\n              spcdp.timepart_starttime,\n              dc.seller_member_name,\n              dc.contract_type_name,\n              case \n              when locate('x',dc.con_name) > 0 then 1\n              when locate('x',dc.con_name) > 0 then 2\n              else if(dc.con_qu>0,2,1)\n              end as t_role\n              from \n              (select distinct m_id, member_id, con_id, sale_energy, sale_price, vendee_energy, vendee_price, time_division_code, time_division_name, time_division_range, timepart_endtime, timepart_starttime from \n               select \n               DISTINCT\n               if(spcdp.m_id is null,spcdpa.m_id,spcdp.m_id) as m_id,\n               if(spcdp.member_id is null,spcdpa.member_id,spcdp.member_id) as member_id,\n               if(spcdp.con_id is null,spcdpa.con_id,spcdp.con_id) as con_id,\n               if(spcdp.sale_energy is null,spcdpa.sale_energy,spcdp.sale_energy) as sale_energy,\n               if(spcdp.sale_price is null,spcdpa.sale_price,spcdp.sale_price) as sale_price,\n               if(spcdp.vendee_energy is null,spcdpa.vendee_energy,spcdp.vendee_energy) as vendee_energy,\t\n               if(spcdp.vendee_price is null,spcdpa.vendee_price,spcdp.vendee_price) as vendee_price,\n               if(spcdp.time_division_code is null,spcdpa.time_division_code,spcdp.time_division_code) as time_division_code,\n               if(spcdp.time_division_name is null,spcdpa.time_division_name,spcdp.time_division_name) as time_division_name,\n               if(spcdp.time_division_range is null,spcdpa.time_division_range,spcdp.time_division_range) as time_division_range,\n               if(spcdp.timepart_endtime is null,spcdpa.timepart_endtime,spcdp.timepart_endtime) as timepart_endtime,\n               if(spcdp.timepart_starttime is null,spcdpa.timepart_starttime,spcdp.timepart_starttime) as timepart_starttime,\n               if(spcdp.creator is null,spcdpa.creator,spcdp.creator) as creator,\n               if(spcdp.creation_time is null,spcdpa.creation_time,spcdp.creation_time) as creation_time,\n               if(spcdp.modifier is null,spcdpa.modifier,spcdp.modifier) as modifier,\n               if(spcdp.modification_time is null,spcdpa.modification_time,spcdp.modification_time) as modification_time\n               from\n               (\n                 select * from ods.table2 where modification_time >= date_format(date_sub(current_date, interval 1 day), '%Y-%m-%d %T')\n               ) spcdp  \n               full join \n               (\n                 select * from ods.table2_xxx where modification_time >= date_format(date_sub(current_date, interval 1 day), '%Y-%m-%d %T')\n               ) spcdpa  \n               on spcdp.m_id = spcdpa.m_id and spcdp.member_id = spcdpa.member_id and spcdp.con_id = spcdpa.con_id\n               and spcdp.time_division_code = spcdpa.time_division_code and spcdp.timepart_starttime = spcdpa.timepart_starttime\n               and spcdp.timepart_endtime = spcdpa.timepart_endtime\n              )\n              where m_id = 'PXBGS' and time_division_range <> '') spcdp\n            inner join (select * from abc.table3 where service_provider_id = 1) ds on spcdp.member_id = ds.counterparty_code\n            inner join (select * from abc.table4 where is_deleted <> 1) dc on spcdp.con_id = dc.con_id and ds.st_id = dc.st_id \n            and date(spcdp.timepart_starttime) between dc.contract_start_date and dc.contract_end_date\n          ) tmp1\n          left join \n          (\n            select\n            t_ord_96,\n            CASE \n            when end_time_96 = '00:00:00' then '24:00'\n            else left(end_time_96, 5)\n            END as end_time_96\n            from \n            abc.dim_spot_time_list\n          ) dstl on dstl.end_time_96 > left(tmp1.time_division_range, 5) and dstl.end_time_96 <= right(tmp1.time_division_range, 5)\n        ) as tmp\n        left join abc.dim_date dd on dd.`date` BETWEEN date(tmp.timepart_starttime) and date(timepart_endtime)\n      ) as tmp2\n    ) as tmp3\n    where tmp3.t_ord_96 is not null and tmp3.con_id <> 'xxxxxxxxxxxx' \n  ) as tmp4\n\t\tleft join abc.dim_spot_time_list dstl2 on 1 = 1\n\t) as tmp5\n\tgroup by tmp5.m_id, tmp5.st_id, tmp5.con_id, tmp5.`date`, tmp5.t_ord_96, tmp5.t_role, tmp5.tag;\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ece\u8fd9\u4e2aSQL\u6587\u672c\u6765\u770b\uff0c\u6574\u4f53\u8fd8\u662f\u6bd4\u8f83\u590d\u6742\uff0c\u60f3\u5feb\u901f\u627e\u5230\u95ee\u9898\u6839\u56e0\u8fd8\u662f\u6bd4\u8f83\u56f0\u96be\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u6211\u4eec\u6839\u636eSQL\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684trace_id\uff0c\u6765\u4e00\u6b65\u6b65\u8ffd\u8e2a\u95ee\u9898\u7684\u6839\u56e0\u3002\n\u8fd9\u91cc\u5148\u8bf4\u7ed3\u8bba\uff0c\u901a\u8fc7\u5bf9\u65e5\u5fd7\u8fc7\u6ee4\u6392\u67e5\uff0c\u6211\u4eec\u53d1\u73b0\u662f\u5b57\u6bb5\u7c7b\u578b\u5f3a\u8f6c\uff0c\u5bfc\u81f4\u8f6c\u51fa\u6765\u7684\u65e5\u671f\u5b57\u6bb5\u662f\u65e0\u6548\u7684\uff0c\u6240\u4ee5\u62a5\u9664\u4e86\u8fd9\u4e2a\u9519\u8bef\uff0c\u5f53\u65f6\u83b7\u53d6\u5230\u7684\u65e5\u5fd7\u5982\u4e0b\uff08\u90e8\u5206\u622a\u53d6\uff09\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-markdown",children:'[2023-07-19 14:24:27.757645] WARN  [LIB.TIME] str_to_ob_time_with_date (ob_time_convert.cpp:1938) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=16] datetime is invalid or out of range(ret=-4219, str=2022-10-01 24:00:00, ob_time={mode_:3, parts:[2022, 10, 1, 24, 0, 0, 0, 0, 0, 0, 0], tz_name:"", tzd_abbr:"", time_zone_id:-1, transition_type_id:-1, is_tz_name_valid:false}, date_sql_mode={allow_invalid_dates:0, no_zero_date:0}, lbt()=0xb553efb 0xb4b501f 0xb4a0a96 0xb4a0731 0x80360d3 0x807ed03 0x8098f84 0x61dc801 0x8098f84 0x804c103 0x8098f84 0x7e3b29f 0x8098f84 0x686dcc7 0x8098f84 0x6669ef4 0x8098f84 0x7373827 0x7373e77 0x74e80f3 0x755c04b 0x756110c 0x7563293 0x737face 0x6eb659d 0x6eb7931 0x6ebf317 0x737face 0x743726d 0x737face 0x69a057d 0x737face 0x69ed74b 0x699f2b4 0x69df421 0x39cbc45 0x7a5d60f 0x7a5cd06 0x7a5b37d 0x7a94139 0x7a48812 0x7a2b8cb 0x7a2a815 0x3bbaed5 0x392f401 0x4602029 0x39277e4 0x46025c7 0xb5380c7 0xb53303a 0x7f1759d17ea5 0x7f1759a40b0d)\n[2023-07-19 14:24:27.757663] WARN  [LIB.TIME] str_to_datetime (ob_time_convert.cpp:398) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=18] failed to convert string to datetime(ret=-4219)\n[2023-07-19 14:24:27.757667] WARN  [SQL] common_string_datetime (ob_datum_cast.cpp:1104) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=4] str_to_datetime failed(ret=-4219, in_str=2022-10-01 24:00:00)\n[2023-07-19 14:24:27.757671] WARN  [SQL] string_datetime (ob_datum_cast.cpp:2406) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=3] fail to exec common_string_datetime(expr, ObString(child_res->len_, child_res->ptr_), ctx, res_datum)(ret=-4219)\n[2023-07-19 14:24:27.757673] WARN  [SQL] anytype_anytype_explicit (ob_datum_cast.cpp:6263) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=3] inner cast failed(ret=-4219)\n[2023-07-19 14:24:27.757676] WARN  [SQL] eval_param_value (ob_expr.h:944) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=2] evaluate parameter failed(ret=-4219, param_index=0)\n[2023-07-19 14:24:27.757679] WARN  [SQL.ENG] calc_date_adjust (ob_expr_date_add.cpp:144) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=2] eval param value failed\n[2023-07-19 14:24:27.757682] WARN  [SQL] datetime_string (ob_datum_cast.cpp:3524) [7526][T1004_TNT_L0_G0][T1004][YB42AC116182-00060043C87B7F7D-0-0] [lt=2] eval arg failed(ret=-4219, ctx={batch_idx:8, batch_size:136, max_batch_size:256, frames_:0x7f12f57f0f90})\n........\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u4ece\u65e5\u5fd7\u7684\u7b2c\u4e00\u884c\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230datetime is invalid or out of range\u7684\u62a5\u9519\uff0c\u5728\u8fd9\u91cc\u5c31\u57fa\u672c\u53ef\u4ee5\u5224\u65ad\u662fdatetime\u7c7b\u578b\u6709\u95ee\u9898\uff0c\u7b2c\u4e8c\u884c\u7684\u63d0\u793a\u5219\u66f4\u660e\u663e\uff1afailed to convert string to datetime\uff0c\u6240\u4ee5\u6211\u4eec\u5f88\u5feb\u5c31\u53ef\u4ee5\u5b9a\u4f4d\u5230\u662f\u5728\u505astring\u8f6cdatetime\u7c7b\u578b\u7684\u65f6\u5019\uff0c\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u901a\u8fc7\u56de\u770bSQL\u53ef\u4ee5\u627e\u5230\uff0c\u6709\u4e24\u5904\u4f7f\u7528cast\u51fd\u6570\u6765\u505a\u5b57\u7b26\u4e32\u7c7b\u578b\u8f6c\u65f6\u95f4\u7c7b\u578b\u7684\u8f6c\u6362\uff0c\u7136\u540e\u6839\u636e\u7528\u6237\u63d0\u4f9b\u7684\u8868\u6570\u636e\uff0c\u6211\u4eec\u5bf9\u95ee\u9898\u8fdb\u884c\u590d\u73b0\uff0c\u786e\u4fe1\u5c31\u662f\u8fd9\u91cc\u7684\u9519\u8bef\u3002SQL\u4e2d\u7c7b\u578b\u8f6c\u6362\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"cast(concat('2022-10-01 ', right(spcdp.time_division_range, 5), ':00') as datetime)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u90a3\u6211\u4eec\u662f\u600e\u4e48\u5feb\u901f\u627e\u5230\u8fd9\u6761\u65e5\u5fd7\u7684\u5462\uff0c\u4e0b\u9762\u6211\u628a\u95ee\u9898\u7b80\u5316\uff0c\u91cd\u65b0\u590d\u73b0\u62a5\u9519\u73b0\u573a\uff0c\u770b\u4e0b\u662f\u600e\u4e48\u4e00\u6b65\u6b65\u627e\u5230\u5173\u952e\u65e5\u5fd7\uff0c\u53d1\u73b0\u95ee\u9898\u7684\u3002\u5177\u4f53\u5982\u4e0b\uff0c\u7b80\u5355\u521b\u5efa\u4e24\u5f20\u8868:\nt1\u8868\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `t1` (\n  `a_id` int(11) DEFAULT NULL,\n  `a_name` varchar(10) DEFAULT NULL,\n  `a_time` varchar(10) DEFAULT NULL\n)\n"})}),"\n",(0,s.jsx)(n.p,{children:"t2\u8868\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `t2` (\n  `t_id` int(11) DEFAULT NULL,\n  `t_name` varchar(10) DEFAULT NULL,\n  `t_time` datetime DEFAULT NULL\n)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5176\u4e2dt2\u8868\uff0c\u662f\u76ee\u6807\u5199\u5165\u8868\uff0ct1\u8868\u662f\u6e90\u6570\u636e\u8868\uff0ct1\u8868\u548ct2\u8868\u533a\u522b\u4e3b\u8981\u662f\u7b2c\u4e09\u4e2a\u5b57\u6bb5\u7684\u7c7b\u578b\u4e0d\u4e00\u6837\uff0c\u4e00\u4e2a\u662fvarchar\uff0c\u4e00\u4e2a\u662fdatetime\u7c7b\u578b\uff0c\u6e90\u6570\u636e\u8868t1\u4e2d\u6570\u636e\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> select * from t1;\n+------+--------+--------+\n| a_id | a_name | a_time |\n+------+--------+--------+\n|    1 | test   | 24:00  |\n+------+--------+--------+\n1 row in set (0.011 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6a21\u62df\u6570\u636e\u6e05\u6d17\u5e76\u5199\u5165"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> insert into t2 select a_id, a_name,cast(concat('2022-10-10 ', right(tb.a_time,5), ':00') as datetime) from t1 tb;\nERROR 1292 (22007): Incorrect value\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u51fa\u73b0\u4e86\u7c7b\u4f3c\u7684\u62a5\u9519\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u9700\u8981\u53bb\u65e5\u5fd7\u91cc\u5b9a\u4f4d\u5230\u8fd9\u4e2a\u62a5\u9519\uff0c\u56e0\u4e3aOceanBase\u7684\u65e5\u5fd7\u6253\u5370\u6bd4\u8f83\u591a\uff0c\u5982\u679c\u76f4\u63a5\u53bb\u627e\u662f\u5f88\u96be\u5feb\u901f\u5b9a\u4f4d\u5230\u8ddf\u8fd9\u6761SQL\u76f8\u5173\u7684\u65e5\u5fd7\uff0c\u8fd9\u91cc\u5c31\u9700\u8981\u7528\u5230trace_id\u3002\u524d\u9762\u6211\u4eec\u8bf4\u5230\u6bcf\u6761SQL\u8fdb\u5165\u5230\u6570\u636e\u5e93\uff0c\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u552f\u4e00\u7684trace_id\uff0c\u90a3\u8fd9\u4e2atrace_id\u662f\u600e\u4e48\u83b7\u53d6\u5462\uff0c\u8fd9\u91cc\u6709\u51e0\u79cd\u65b9\u5f0f\uff1a\n\u65b9\u5f0f\u4e00\uff1a\n\u5728SQL\u6267\u884c\u5b8c\u6210\u4e4b\u540e\uff0c\u901a\u8fc7select last_trace_id();\u83b7\u53d6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> select last_trace_id();\n+-----------------------------------+\n| last_trace_id()                   |\n+-----------------------------------+\n| YB42AC18FF11-0005FE3D398CC982-0-0 |\n+-----------------------------------+\n1 row in set (0.001 sec)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u65b9\u5f0f\u4e8c\uff1a\n\u901a\u8fc7\u67e5\u8be2 GV$OB_SQL_AUDIT \u5ba1\u8ba1\u89c6\u56fe\u67e5\u8be2\u83b7\u53d6\uff0c\u6839\u636equery_sql\u5b57\u6bb5\u8fc7\u6ee4\u67e5\u8be2\u7684\u5173\u952e\u5b57\uff0c\u83b7\u53d6\u5bf9\u5e94\u7684trace_id\uff0c\u5173\u4e8e\u5ba1\u8ba1\u89c6\u56fe\u7684\u5404\u5b57\u6bb5\u542b\u4e49\uff0c\u53ef\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1a",(0,s.jsx)(n.a,{href:"https://www.oceanbase.com/docs/common-oceanbase-database-1000000000035692",children:"GV$OB_SQL_AUDIT"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> select SVR_IP,SVR_PORT,TRACE_ID,,TENANT_NAME,SQL_ID,QUERY_SQL \n    ->     from oceanbase.gv$ob_sql_audit\n    ->     where query_sql like \"%right(tb.a_time,5)%\"\\G;\n*************************** 1. row ***************************\n                         SVR_IP: 172.xx.xx.17\n                       SVR_PORT: 2882\n                       TRACE_ID: YB42AC18FF11-0005FE3D398CC982-0-0\n                    TENANT_NAME: obtest\n                         SQL_ID: D8F4A48653895C3AAACE903CA04EDD21\n                      QUERY_SQL: insert into t2 select a_id, a_name,cast(concat('2022-10-10 ', right(tb.a_time,5), ':00') as datetime) from t1 tb\n1 rows in set (0.224 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u65b9\u5f0f\u4e09\uff1a\n\u5f00\u542fenable_rich_error_msg\u53c2\u6570\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u662f\u96c6\u7fa4\u7ea7\u522b\u7684\uff0c\u9700\u8981\u5728sys\u79df\u6237\u4e0b\u5f00\u542f\n\u5f00\u542f\u65b9\u5f0f\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"alter system set enable_rich_error_msg=true;\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u5f00\u542f\u4e4b\u540e\uff0c\u5982\u679cSQL\u6267\u884c\u62a5\u9519\uff0c\u4f1a\u81ea\u52a8\u8fd4\u56detrace_id\u548cip\u4fe1\u606f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> insert into t2 select a_id, a_name,cast(concat('2022-10-10 ', right(tb.a_time,5), ':00') as datetime) from t1 tb;\nERROR 1292 (22007): Incorrect value\n[172.xx.xx.17:2882] [2023-08-03 20:42:36.361996] [YB42AC18FF11-0005FE3D398CC986-0-0]\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0a\u4e09\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u91c7\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u65b9\u5f0f\u4e00\u53ea\u80fd\u83b7\u53d6\u5230trace_id\uff0c\u4f46\u662f\u83b7\u53d6\u4e0d\u5230OBServer\u7684IP\u4fe1\u606f\uff0c\u56e0\u4e3aOceanBase\u4e3a\u5206\u5e03\u5f0f\u6570\u636e\u5e93\uff0c\u4e00\u5957\u96c6\u7fa4\u4e00\u822c\u4f1a\u6709\u591a\u4e2aOBServer\u8282\u70b9\uff0c\u5982\u679c\u6ca1\u6709IP\u4fe1\u606f\uff0c\u6211\u4eec\u5f88\u96be\u5f97\u77e5\u8fd9\u6761SQL\u662f\u5728\u54ea\u4e2aOBServer\u8282\u70b9\u4e0a\u6267\u884c\u7684\u3002\u6240\u4ee5\u662f\u9700\u8981\u8fd9\u4e2aIP\u4fe1\u606f\u65b9\u4fbf\u6211\u4eec\u62ff\u7740trace_id\u76f4\u63a5\u53bb\u673a\u5668\u4e0a\u8fc7\u6ee4\u65e5\u5fd7\u3002\u65b9\u5f0f\u4e09\u9700\u8981\u5f00\u542f\u96c6\u7fa4\u7ea7\u522b\u7684\u53c2\u6570\uff0c\u6709\u7684\u79df\u6237\u5e76\u4e0d\u4e00\u5b9a\u9700\u8981\u8fd9\u4e2a\uff0c\u5e76\u4e14\u5c55\u793a\u4fe1\u606f\u76f8\u5bf9\u8f83\u5c11\u3002\n\u901a\u8fc7\u83b7\u53d6\u5230\u7684trace_id\uff0c\u4ee5\u53caSVR_IP\u4fe1\u606f\uff0c\u6211\u4eec\u76f4\u63a5\u5230172.xx.xx.17\u8fd9\u53f0\u673a\u5668\u7684/home/admin/oceanbase/log\u76ee\u5f55\u4e0b\uff0c\u8fc7\u6ee4observer.log\uff0c\u5f97\u5230\u5982\u4e0b\u65e5\u5fd7\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-markdown",children:'[root@ob1 log]# grep "YB42AC18FF11-0005FE3D398CC982-0-0" observer.log\n[2023-08-03 20:36:01.943682] WDIAG [LIB.TIME] str_to_ob_time_with_date (ob_time_convert.cpp:1948) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=14][errcode=-4219] datetime is invalid or out of range(ret=-4219, str=2022-10-10 24:00:00, ob_time={mode_:3, parts:[2022, 10, 10, 24, 0, 0, 0, 0, 0, 0, 0], tz_name:"", tzd_abbr:"", time_zone_id:-1, transition_type_id:-1, is_tz_name_valid:false}, date_sql_mode={allow_invalid_dates:0, no_zero_date:0}, lbt()=0xf0bba8c 0xec2b439 0xec175b5 0xec17245 0xb24a08c 0xb2c0cb8 0x41329cc 0xb23d520 0xb2d4359 0x3fbefb0 0xa55f81d 0x3fbe901 0x411b7eb 0x9f87f2e 0x411b290 0x3fb8c7d 0x3ffbe9a 0x7f29409 0x3fb334e 0x3fb0562 0x3fabed9 0x3fa9d9a 0x3fa6768 0x6a0ad14 0xf3666c7 0xf35faca 0x7fc02405fea5 0x7fc023d88b0d)\n[2023-08-03 20:36:01.943700] WDIAG [LIB.TIME] str_to_datetime (ob_time_convert.cpp:397) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=19][errcode=-4219] failed to convert string to datetime(ret=-4219)\n[2023-08-03 20:36:01.943705] WDIAG [SQL] common_string_datetime (ob_datum_cast.cpp:1190) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=4][errcode=-4219] str_to_datetime failed(ret=-4219, in_str=2022-10-10 24:00:00)\n[2023-08-03 20:36:01.943709] WDIAG [SQL] string_datetime (ob_datum_cast.cpp:2838) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=4][errcode=-4219] fail to exec common_string_datetime(expr, ObString(child_res->len_, child_res->ptr_), ctx, res_datum)(ret=-4219)\n[2023-08-03 20:36:01.943712] WDIAG [SQL] anytype_anytype_explicit (ob_datum_cast.cpp:8389) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=3][errcode=-4219] inner cast failed(ret=-4219)\n[2023-08-03 20:36:01.943715] WDIAG [SQL] cast_eval_arg_batch (ob_datum_cast.cpp:2306) [24791][T1012_L0_G0][T1012][YB42AC18FF11-0005FE3D398CC982-0-0] [lt=3][errcode=-4219] fail to eval one row(ret=-4219, i=0)\n.......\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u4ece\u65e5\u5fd7\u7684\u524d\u4e24\u884c\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u6b21\u7684\u62a5\u9519\uff0c\u548c\u7528\u6237\u65e5\u5fd7\u4e2d\u8fc7\u6ee4\u51fa\u6765\u7684\u62a5\u9519\u662f\u4e00\u6837\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u5c31\u53ef\u4ee5\u5224\u65ad\u662f\u8fd9\u91cc\u7684cast\u8f6c\u6362\u51fa\u73b0\u4e86\u9519\u8bef\u3002\n\u8fd9\u91cc\u4e3a\u4ec0\u4e48\u8fd9\u6837\u8f6c\u6362\u662f\u4e0d\u884c\u7684\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728t1\u8868\u4e2d\uff0ca_time\u5b57\u6bb5\u662fvarchar\u7c7b\u578b\uff0c\u5177\u4f53\u6570\u503c\u662f 24:00 \uff0c\u901a\u8fc7concat('2022-10-10 ', right(tb.a_time,5), ':00') \u62fc\u63a5\u4e4b\u540e\uff0c\u7ec4\u6210\u7684\u5b57\u7b26\u4e32\u662f \"2022-10-10 24:00:00\" \uff0c\u4e4d\u4e00\u770b\u8c8c\u4f3c\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u4e3a\u4ec0\u4e48\u4f1a\u8f6c\u6362\u5931\u8d25\uff1f\u5b9e\u9645\u6211\u4eec\u7ec6\u5fc3\u89c2\u5bdf\u5c31\u4f1a\u53d1\u73b0\uff0c2022-10-10 24:00:00 \u5728\u8ba1\u7b97\u673a\u4e2d\u662f\u4e00\u4e2a\u975e\u6cd5\u65f6\u95f4\uff0c2022-10-10 24:00:00 \u5176\u5b9e\u5df2\u7ecf\u5230 2022-10-11 00:00:00\uff0c\u6240\u4ee5\u8fd9\u5757\u6211\u4eec\u5efa\u8bae\u7528\u6237\u5bf9\u8fd9\u4e2a\u5b57\u7b26\u4e32\u505a\u4e0b\u4fee\u6539\uff0c\u4e0d\u8981\u4f7f\u752824:00:00\u3002\n\u4fee\u6539\u4e4b\u540e\u6211\u4eec\u518d\u6765\u770b\u4e00\u4e0b\u6267\u884c\u60c5\u51b5\u3002\n\u9996\u5148t1\u8868\u5185\u5bb9"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> select * from t1;\n+------+--------+--------+\n| a_id | a_name | a_time |\n+------+--------+--------+\n|    1 | test   | 00:00  |\n+------+--------+--------+\n1 row in set (0.001 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u518d\u6b21\u6267\u884c\u5199\u5165"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> insert into t2 select a_id, a_name,cast(concat('2022-10-11 ', right(tb.a_time,5), ':00') as datetime) from t1 tb;\nQuery OK, 1 row affected (0.003 sec)\n\nobclient [test]> select * from t2;\n+------+--------+---------------------+\n| t_id | t_name | t_time              |\n+------+--------+---------------------+\n|    1 | test   | 2022-10-11 00:00:00 |\n+------+--------+---------------------+\n1 row in set (0.001 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u6267\u884c\u5199\u5165\u6210\u529f\uff0c\u95ee\u9898\u5f97\u4ee5\u89e3\u51b3\u3002\n\u5728\u5b9e\u9645\u751f\u4ea7\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u8fd8\u4f1a\u9047\u5230\u5176\u4ed6\u5f88\u591a\u7c7b\u578b\u7684\u9519\u8bef\uff0c\u5927\u591a\u90fd\u662f\u53ef\u4ee5\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5feb\u901f\u5b9a\u4f4d\u548c\u89e3\u51b3\u95ee\u9898\u3002\u53e6\u5916\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\uff0c\u5c31\u662f\u6211\u4eec\u9047\u5230\u4e86\u6162SQL\uff0c\u5bfc\u81f4\u6574\u4e2a\u6570\u636e\u5e93\u7cfb\u7edf\u53d8\u5361\uff0c\u4e5f\u5f71\u54cd\u5230\u5176\u4ed6SQL\u7684\u6267\u884c\u3002\u4e0b\u9762\u5c31\u6765\u770b\u4e0b\u5982\u4f55\u5feb\u901f\u5b9a\u4f4d\u6162SQL\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u6162sql",children:(0,s.jsx)(n.strong,{children:"\u6162SQL"})}),"\n",(0,s.jsx)(n.p,{children:"\u6162SQL\u5bf9\u4e8eDBA\u6765\u8bf4\uff0c\u4e00\u76f4\u662f\u4e00\u4e2a\u6bd4\u8f83\u5934\u75bc\u7684\u5730\u65b9\uff0c\u5f53\u9047\u5230\u6162SQL\u7684\u65f6\u5019\uff0c\u603b\u662f\u9700\u8981\u60f3\u5404\u79cd\u529e\u6cd5\u53bb\u4f18\u5316\u6162SQL\uff0c\u5982\u679c\u4e0d\u5feb\u901f\u4f18\u5316\uff0c\u5c31\u4f1a\u5f15\u53d1\u4e00\u7cfb\u5217\u95ee\u9898\uff0c\u90a3\u4e48\u5728OceanBase\u4e2d\u6211\u4eec\u5982\u4f55\u5224\u65ad\u662f\u6162SQL\uff0c\u4ee5\u53ca\u5982\u4f55\u53d1\u73b0\u6162SQL\u5462\u3002\nOceanBase\u4e2d\u6709\u4e00\u4e2a\u53c2\u6570 trace_log_slow_query_watermark \u7528\u6765\u8bbe\u7f6e\u6162SQL\u7684\u9608\u503c\uff0c\u5f53SQL\u7684\u6267\u884c\u8d85\u8fc7\u8fd9\u4e2a\u9608\u503c\uff0c\u90a3\u4e48OceanBase\u5c31\u4f1a\u8ba4\u4e3a\u8fd9\u662f\u4e00\u6761\u6162SQL\uff0c\u7136\u540e\u88ab\u8bb0\u5f55\uff0c\u8fd9\u4e2a\u503c\u9ed8\u8ba4\u662f 1 \u79d2\u3002"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u5c5e\u6027"}),(0,s.jsx)(n.th,{children:"\u63cf\u8ff0"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u53c2\u6570\u7c7b\u578b"}),(0,s.jsx)(n.td,{children:"\u65f6\u95f4\u7c7b\u578b"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u9ed8\u8ba4\u503c"}),(0,s.jsx)(n.td,{children:"1s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u53d6\u503c\u8303\u56f4"}),(0,s.jsx)(n.td,{children:"[1ms\uff0c +\u221e)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u662f\u5426\u91cd\u542f OBServer \u751f\u6548"}),(0,s.jsx)(n.td,{children:"\u5426"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"\u90a3\u4e48\uff0c\u8fd9\u4e9b\u6162SQL\u4fe1\u606f\u5177\u4f53\u8bb0\u5f55\u5728\u54ea\u4e9b\u5730\u65b9\u5462\uff0c\u6211\u4eec\u5982\u4f55\u5feb\u901f\u627e\u5230\u5b83\u5462\uff1f\n\u65b9\u5f0f\u4e00\uff1a\n\u9996\u5148\uff0c\u6211\u4eec\u524d\u9762\u63d0\u5230\u6240\u6709\u7684SQL\u7684\u6267\u884c\u90fd\u4f1a\u8bb0\u5f55\u5728observer.log\u7684\u65e5\u5fd7\u91cc\uff0c\u6162SQL\u4e5f\u4e0d\u4f8b\u5916\uff0c\u5728observer.log\u65e5\u5fd7\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u8fc7\u6ee4 slow query \u5173\u952e\u5b57\uff0c\u5c31\u80fd\u83b7\u53d6\u5230\u6267\u884c\u8d85\u8fc7 1 \u79d2\u7684\u6162SQL\uff0c\u4f8b\u5982\u4e0b\u9762\u8fd9\u6761\u65e5\u5fd7"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-markdown",children:'[root@ob1 log]# grep "slow query" observer.log\n[2023-08-04 11:05:36.254730] TRACE [TRACE] after_process (obmp_base.cpp:142) [14092][T1_L0_G0][T1][YB42AC18FF11-0005FE3E568CA6E9-0-0] [lt=14] \n[slow query](TRACE=begin_ts=1691118333740472 2023-08-04 03:05:33.740472|[process_begin] u=0 in_queue_time:15, receive_ts:1691118333740456, enqueue_ts:1691118333740457\n|[start_sql] u=0 addr:{ip:"127.0.0.1", port:23382}|[query_begin] u=1 trace_id:YB42AC18FF11-0005FE3E568CA6E9-0-0|[before_processor_run] u=3 \n|[session] u=2 sid:3221725883, tenant_id:1|[calc_partition_location_begin] u=48 |[plc_serialize_begin] u=4 |[plc_serialize_end] u=5 \n|[tl_calc_part_id_end] u=36 |[get_location_cache_begin] u=0 |[calc_partition_location_end] u=2 |[get_plan_type_end] u=1 |[pc_choose_plan] u=2 \n|[check_priv] u=4 |[plan_id] u=1 plan_id:18101|[do_open_plan_begin] u=2 plan_id:18101|[sql_start_stmt_begin] u=0 |[sql_start_stmt_end] u=0 \n|[exec_plan_begin] u=0 |[exec_plan_end] u=4 |[do_open_plan_end] u=0 |[get_row] u=1672 |[close_plan_begin] u=2512423 |[start_end_stmt] u=14 \n|[end_stmt] u=0 |[close_plan_end] u=0 |[affected_rows] u=1 affected_rows:-1|[store_found_rows] u=0 found_rows:0, return_rows:296\n|[auto_end_plan_begin] > u=0 |[auto_end_plan_end] u=2 |[query_end] u=19 |[process_end] u=10 run_ts:1691118333740476|total_timeu=2514256)\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u6761\u65e5\u5fd7\u5176\u5b9e\u8bb0\u5f55\u4e86\u5f88\u591a\u4fe1\u606f\uff0c\u5305\u62ecSQL\u7684trace_id\uff0c\u4ee5\u53ca\u6267\u884c\u603b\u65f6\u95f4total_time\u548c\u5404\u4e2a\u6a21\u5757\u7684\u6267\u884c\u65f6\u95f4\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u65b9\u5f0f\u4e8c\uff1a\n\u5728OBProxy\u7684\u65e5\u5fd7\u76ee\u5f55\u91cc\uff0c\u4e13\u95e8\u6709\u4e00\u4e2a obproxy_slow.log \u7684\u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65e5\u5fd7\u4e5f\u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u6162SQL\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u8fd9\u4e2a\u65e5\u5fd7\uff0c\u53d1\u73b0\u6267\u884c\u6162\u7684SQL"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-markdown",children:"2023-08-01 17:44:51.779606,odp,,,,obcluster:obtest:oceanbase,OB_MYSQL,,,OB_MYSQL_COM_QUERY,SELECT,success,,select /*+ ob_querytimeout(10000000000) */ sleep(5),5000864us,120us,0us,5000571us,Y0-00007FCC9D7BC3A0,YB42AC18FF13-0005FE3D2CBF2C76-0-0,,,0,172.xx.xx.19:2881\n2023-08-03 14:30:47.370874,odp,,,,obcluster:obtest:test,OB_MYSQL,,,OB_MYSQL_COM_QUERY,SELECT,success,,select sleep(1),1011179us,86us,0us,1010966us,Y0-00007FCC9DBBD320,YB42AC18FF13-0005FE3D2CBF2CE3-0-0,,,0,172.xx.xx.19:2881\n2023-08-03 16:41:08.255751,odp,,,,obcluster:obtest:test,OB_MYSQL,,,OB_MYSQL_COM_QUERY,DROP,success,,drop table chat_req_records,620960us,113us,0us,620687us,Y0-00007FCC9D7BD3E0,,,,0,172.xx.xx.19:2881\n"})}),"\n",(0,s.jsx)(n.p,{children:"obproxy\u7684\u6162SQL\u65e5\u5fd7\u4e2d\u603b\u5171\u670924\u4e2a\u5b57\u6bb5\uff0c\u6839\u636e\u8fd9\u4e9b\u5b57\u6bb5\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u83b7\u53d6\u5230\u4e00\u4e9b\u4fe1\u606f\uff0c\u6709\u4e9b\u5b57\u6bb5\u4e3a\u6682\u65f6\u7559\u7a7a\uff0c\u8fd9\u4e9b\u5b57\u6bb5\u4f9d\u6b21\u662f"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u65e5\u5fd7\u6253\u5370\u65f6\u95f4"}),(0,s.jsx)(n.th,{children:"2023-08-01 17:44:51.779606,"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5f53\u524d\u5e94\u7528\u540d"}),(0,s.jsx)(n.td,{children:"odp"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"TraceId"}),(0,s.jsx)(n.td,{children:"YB42AC18FF13-0005FE3D2CBF2C76-0-0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"RpcId"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u903b\u8f91\u6570\u636e\u6e90\u540d\u79f0\xa0"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:["\u7269\u7406\u5e93\u4fe1\u606f\uff08cluster:tenant",":database","\uff09"]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u6570\u636e\u5e93\u7c7b\u578b\uff08OB/RDS\uff09"}),(0,s.jsxs)(n.td,{children:["obcluster:obtest",":oceanbase"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u903b\u8f91\u8868\u540d"}),(0,s.jsx)(n.td,{children:"OB_MYSQL"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u7269\u7406\u8868\u540d"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SQL \u547d\u4ee4\uff08COM_QUERY\u3001COM_STMT_PREPARE\u7b49\uff09"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SQL \u7c7b\u578b\uff08CRUD\uff09"}),(0,s.jsx)(n.td,{children:"SELECT"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u6267\u884c\u7ed3\u679c\uff08success/failed\uff09"}),(0,s.jsx)(n.td,{children:"success"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u9519\u8bef\u7801\uff08succ\u65f6\u4e3a\u7a7a\uff09"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SQL"}),(0,s.jsx)(n.td,{children:"select /*+ ob_querytimeout(10000000000) */ sleep(5)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u6267\u884c\u603b\u8017\u65f6\uff08ms\uff0c\u5305\u62ec\u5185\u90e8 SQL \u6267\u884c\u8017\u65f6\uff09"}),(0,s.jsx)(n.td,{children:"5000864us"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u9884\u6267\u884c\u65f6\u95f4"}),(0,s.jsx)(n.td,{children:"120us"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u94fe\u63a5\u5efa\u7acb\u65f6\u95f4"}),(0,s.jsx)(n.td,{children:"0us"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u6570\u636e\u5e93\u6267\u884c\u65f6\u95f4"}),(0,s.jsx)(n.td,{children:"5000571us"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5f53\u524d\u7ebf\u7a0b\u540d\uff08odp\u7684\u5185\u90e8\u7ebf\u7a0bID\uff09"}),(0,s.jsx)(n.td,{children:"Y0-00007FCC9D7BC3A0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u7cfb\u7edf\u7a7f\u900f\u6570\u636e\uff08\u7cfb\u7edf\u707e\u5907\u4fe1\u606f\u7b49\uff09"}),(0,s.jsx)(n.td,{children:"YB42AC18FF13-0005FE3D2CBF2C76-0-0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u7a7f\u900f\u6570\u636e"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"DBKey \u540d\u79f0"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u662f\u5426\u4f7f\u7528 BeyondTrust\uff08version>= 2.0.20 1 \u662f\uff0c0 \u5426\uff09"}),(0,s.jsx)(n.td,{children:"0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u540e\u7aef Server IP"}),(0,s.jsx)(n.td,{children:"172.xx.xx.19:2881"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"\u65b9\u5f0f\u4e09\uff1a\n\u5982\u679c\u7cfb\u7edf\u5f53\u524d\u65f6\u6bb5\u5c31\u5f88\u6162\uff0c\u53ef\u4ee5\u67e5\u8be2\u6b63\u5728\u6267\u884c\u7684\u6bd4\u8f83\u6162\u7684SQL\uff0c\u901a\u8fc7\u89c6\u56fe __all_virtual_processlist \u6839\u636e time \u5b57\u6bb5\u6392\u5e8f\uff0c\u83b7\u53d6\u5f53\u524d\u7cfb\u7edf\u4e2d\uff0c\u6b63\u5728\u6267\u884c\u7684\u6162SQL\u3002\n\u67e5\u8be2SQL\u5982\u4e0b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT USER,\n   tenant,\n   sql_id,\n   concat(time, 's') as time,\n   info,\n   svr_ip,\n   svr_port,\n   trace_id\nFROM __all_virtual_processlist\nWHERE STATE = 'ACTIVE'\nORDER BY time DESC LIMIT 1\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u73b0\u5728\u6a21\u62df\u4e00\u4e2a\u6162SQL\uff0c select /*+ query_timeout(100000000) */ sleep(100);  \u67e5\u8be2\u7ed3\u679c\u5982\u4e0b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"+------+--------+----------------------------------+------+---------------------------------------------------+---------------+----------+-----------------------------------+\n| USER | tenant | sql_id                           | time | info                                              | svr_ip        | svr_port | trace_id                          |\n+------+--------+----------------------------------+------+---------------------------------------------------+---------------+----------+-----------------------------------+\n| root | obtest | DE47F6BC20D6E36C14AA4D90BDE3B083 | 2s   | select /*+ query_timeout(100000000) */ sleep(100) | 172.xx.xx.19 |     2882 | YB42AC18FF13-0005FE3D2CBF2D57-0-0 |\n+------+--------+----------------------------------+------+---------------------------------------------------+---------------+----------+-----------------------------------+\n1 row in set (0.003 sec)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u65b9\u5f0f\u56db\uff1a\n\u5982\u679c\u6709OCP\u7684\u8bdd\uff0c\u4e5f\u662f\u53ef\u4ee5\u5728OCP\u4e0a\u76f4\u63a5\u67e5\u770b\u6162SQL\uff0c\u8fdb\u5230\u5177\u4f53\u7684\u79df\u6237\u4e0b\u9762\uff0c\u7136\u540e\u8fdb\u5230SQL\u8bca\u65ad\u4e2d\uff0c\u6709\u6162SQL\u9875\u9762\uff0c\u8fd9\u91cc\u7684SQL\u6587\u672c\uff0c\u90fd\u662f\u6709\u76f8\u540cSQL_ID\u7684SQL\n",(0,s.jsx)(n.img,{alt:"image.png",src:t(70636).A+"",width:"2972",height:"1520"}),"\n\u8fd9\u91cc\u518d\u89e3\u91ca\u4e0bSQL_ID\uff0cSQL_ID\u662f\u6bcf\u6761SQL\u8fdb\u5165\u6570\u636e\u5e93\u4e4b\u540e\uff0c\u4f1a\u6839\u636eSQL\u5b57\u7b26\u4e32\u751f\u6210\u4e00\u4e2amd5\u503c\uff0c\u6240\u4ee5\u6267\u884c\u76f8\u540c\u7684SQL \u4f1a\u6709\u76f8\u540c\u7684SQL_ID\uff0c\u4f46\u662ftrace_id\u662f\u4e0d\u4e00\u6837\u7684\u3002\n\u60f3\u8981\u67e5\u770b\u67d0\u6761SQL\u5177\u4f53\u662f\u54ea\u6b21\u6267\u884c\u6162\u4e86\uff0c\u53ef\u4ee5\u70b9\u51fbSQL\u6587\u672c\u8fdb\u5230\u4e0b\u4e00\u4e2a\u9875\u9762\uff0c\u62ff\u5230\u6267\u884c\u6162\u7684\u90a3\u4e00\u6b21\u7684 SQL \u7684trace_id\u3002\n",(0,s.jsx)(n.img,{alt:"image.png",src:t(803).A+"",width:"3046",height:"1696"})]}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u8fd9\u51e0\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f88\u5feb\u83b7\u53d6\u5230\u7cfb\u7edf\u4e2d\u6267\u884c\u7684\u6162SQL\uff0c\u4e0d\u8fc7\u524d\u4e24\u79cd\u65b9\u5f0f\u548c\u7b2c\u56db\u79cd\u65b9\u5f0f\u53ea\u80fd\u83b7\u53d6\u5230trace_id\uff0c\u800c\u7b2c\u4e09\u79cd\u65b9\u5f0f\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230\u6267\u884c\u7684SQL\uff0c\u4ee5\u53caSQL_ID\u3002\u5bf9\u4e8e\u524d\u4e24\u79cd\u65b9\u5f0f\uff0c\u60f3\u8981\u770b\u5177\u4f53\u7684\u5185\u5bb9\uff0c\u8fd8\u9700\u8981\u518d\u8fdb\u4e00\u6b65\u67e5\u8be2\u3002\u8fd9\u91cc\u53c8\u7528\u5230\u6211\u4eec\u7684 GV$OB_SQL_AUDIT \u89c6\u56fe\uff0c\u53ef\u4ee5\u6839\u636e\u89c6\u56fe\u4e2d\u7684trace_id\u76f4\u63a5\u5b9a\u4f4d\u5230\u5bf9\u5e94\u7684SQL\u5185\u5bb9\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:'obclient [oceanbase]> select SVR_IP,SVR_PORT,TRACE_ID,TENANT_NAME,SQL_ID,QUERY_SQL,PLAN_ID\n    ->     from gv$ob_sql_audit \n    ->     where trace_id = "YB42AC18FF13-0005FE3D2CBF2D57-0-0"\\G;\n*************************** 1. row ***************************\n                         SVR_IP: 172.xx.xx.19\n                       SVR_PORT: 2882\n                       TRACE_ID: YB42AC18FF13-0005FE3D2CBF2D57-0-0\n                    TENANT_NAME: obtest\n                         SQL_ID: DE47F6BC20D6E36C14AA4D90BDE3B083\n                      QUERY_SQL: select /*+ query_timeout(100000000) */ sleep(100)\n                        PLAN_ID: 2518\n1 row in set (0.146 sec)\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u8fd9\u4e2a\u67e5\u8be2\uff0c\u6211\u4eec\u5c31\u77e5\u9053\u4e86\u5177\u4f53\u662f\u54ea\u6761SQL\u6267\u884c\u6162\u4e86\uff0c\u5e76\u4e14\u83b7\u53d6\u5230\u4e86SQL\u6267\u884c\u8ba1\u5212\u7684PLAN_ID\uff0c\u63a5\u7740\u5c31\u53ef\u4ee5\u6839\u636ePLAN_ID\u53bb\u67e5\u627e\u8fd9\u6761SQL\u7684\u6267\u884c\u8ba1\u5212\uff0c\u6839\u636e\u6267\u884c\u8ba1\u5212\u518d\u8fdb\u4e00\u6b65\u6392\u67e5\n\u83b7\u53d6\u6267\u884c\u8ba1\u5212\u76f8\u5173\u4fe1\u606f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [oceanbase]> SELECT tenant_id,\n    ->    svr_ip,\n    ->    svr_port,\n    ->    sql_id,\n    ->    plan_id,\n    ->    last_active_time,\n    ->    first_load_time,\n    ->    outline_data\n    -> FROM GV$OB_PLAN_CACHE_PLAN_STAT\n    -> WHERE TENANT_ID = 1012\n    -> AND SQL_ID = 'DE47F6BC20D6E36C14AA4D90BDE3B083'\n    -> AND SVR_IP = '172.xx.xx.19'\n    -> AND SVR_PORT = 2882;\n*************************** 1. row ***************************\n       tenant_id: 1012\n          svr_ip: 172.xx.xx.19\n        svr_port: 2882\n          sql_id: DE47F6BC20D6E36C14AA4D90BDE3B083\n         plan_id: 2518\nlast_active_time: 2023-08-04 11:42:47.834366\n first_load_time: 2023-08-04 11:42:47.834366\n    outline_data: /*+BEGIN_OUTLINE_DATA QUERY_TIMEOUT(100000000) OPTIMIZER_FEATURES_ENABLE('4.0.0.0') END_OUTLINE_DATA*/\n1 row in set (0.019 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5f97\u5230\u8fd9\u4e2a\u67e5\u8be2\u7684\u6267\u884c\u8ba1\u5212\u7684\u7f16\u53f7\uff08plan_id\uff09\uff0c\u8fd9\u4e2a\u6267\u884c\u8ba1\u5212\u7b2c\u4e00\u6b21\u751f\u6210\u7684\u65f6\u95f4\uff08first_load_time\uff09\u4ee5\u53ca\u6700\u540e\u4e00\u6b21\u88ab\u4f7f\u7528\u7684\u65f6\u95f4\uff08last_active_time\uff09"}),"\n",(0,s.jsx)(n.p,{children:"\u63a5\u7740\uff0c\u5c31\u53ef\u4ee5\u6839\u636eplan_id\u6765\u83b7\u53d6\u8fd9\u6761SQL\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [oceanbase]> SELECT OPERATOR, NAME, ROWS, COST FROM GV$OB_PLAN_CACHE_PLAN_EXPLAIN\n    ->     WHERE TENANT_ID = 1012 AND\n    ->     SVR_IP = '172.xx.xx.19' AND\n    ->     SVR_PORT = 2882 AND\n    ->     PLAN_ID = 2518;\n+-----------------+------+------+------+\n| OPERATOR        | NAME | ROWS | COST |\n+-----------------+------+------+------+\n| PHY_EXPR_VALUES | NULL |    1 |    0 |\n+-----------------+------+------+------+\n1 row in set (0.001 sec)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5982\u679c\u60f3\u8981\u83b7\u53d6SQL\u7684\u903b\u8f91\u6267\u884c\u8ba1\u5212\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 explain SQL \u83b7\u53d6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"obclient [test]> explain select /*+ query_timeout(100000000) */ sleep(100);\n+--------------------------------------------------------------+\n| Query Plan                                                   |\n+--------------------------------------------------------------+\n| ==========================================                   |\n| |ID|OPERATOR  |NAME|EST.ROWS|EST.TIME(us)|                   |\n| ------------------------------------------                   |\n| |0 |EXPRESSION|    |1       |1           |                   |\n| ==========================================                   |\n| Outputs & filters:                                           |\n| -------------------------------------                        |\n|   0 - output([sleep(cast(100, DECIMAL(3, 0)))]), filter(nil) |\n|       values({sleep(cast(100, DECIMAL(3, 0)))})              |\n+--------------------------------------------------------------+\n9 rows in set (0.007 sec)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u63a5\u7740\u5c31\u53ef\u4ee5\u6839\u636e\u6267\u884c\u8ba1\u5212\uff0c\u6765\u5224\u65ad\u95ee\u9898\u7684\u539f\u56e0\u3002\u6267\u884c\u8ba1\u5212\u89e3\u8bfb\uff0c\u53ef\u53c2\u8003\u5b98\u7f51\u6587\u6863\uff1a",(0,s.jsx)(n.a,{href:"https://www.oceanbase.com/docs/common-oceanbase-database-1000000000033850",children:"\u6267\u884c\u8ba1\u5212"}),"\uff0c\u5b9a\u4f4d\u5230\u95ee\u9898\u4e4b\u540e\uff0c\u6211\u4eec\u4e5f\u6709\u5f88\u591a\u4f18\u5316\u7684\u65b9\u5f0f\uff0c\u8fd9\u4e9b\u540e\u7eed\u6211\u4eec\u518d\u5c55\u5f00\u6765\u5c06\uff0c\u5176\u4e2d\u5305\u62ec hint\uff0c outline\u7ed1\u5b9a\u7b49\u3002\n\u53e6\u5916\uff0c\u5728OceanBase 4.0\u7248\u672c\u4e4b\u540e\uff0c\u6211\u4eec\u4e5f\u63a8\u51fa\u4e86\u5168\u94fe\u8def\u8ffd\u8e2a\u7684\u529f\u80fd\uff0c\u4f9d\u9760\u5168\u94fe\u8def\u8ffd\u8e2a\uff0c\u53ef\u4ee5\u66f4\u5feb\u901f\u7684\u5b9a\u4f4d\u5230\u4e00\u6761SQL\u5177\u4f53\u662f\u54ea\u91cc\u6267\u884c\u6162\u3002\u76f8\u5173\u5168\u94fe\u8def\u8ffd\u8e2a\u6587\u6863\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\uff1a",(0,s.jsx)(n.a,{href:"https://open.oceanbase.com/blog/1775421184",children:"OceanBase 4.0 \u89e3\u8bfb\uff1a\u5168\u94fe\u8def\u8ffd\u8e2a\u8981\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\uff1f\u4ece\u4e00\u6761\u6162SQL\u8bf4\u8d77"})]})]})}function o(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},72382:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/a-149690b9b762dca75a7fc28bc93e874a.png"},39733:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/b-324127a6ab1327411bcb153e5da22381.png"},70636:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/c-7e7d1c9315ead1d36aed0a38cfb9fe21.png"},803:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/d-5fd5a4ae602a0bc5db0c0f0d138fcfda.png"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var s=t(96540);const i={},d=s.createContext(i);function a(e){const n=s.useContext(d);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);