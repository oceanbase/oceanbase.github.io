"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[4281],{92527:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>d});var r=s(74848),o=s(28453);const t={},a="Use OCP to take over a cluster deployed by OBD",i={id:"obd/user-guide/OCP-takeover-OBD-deployment-cluster",title:"Use OCP to take over a cluster deployed by OBD",description:"This topic describes how to use OceanBase Cloud Platform (OCP) to take over a cluster deployed by OceanBase Deployer (OBD). The cluster named test, which is started by using the distributed-example.yaml configuration file, is used as an example.",source:"@site/docs/obd/300.user-guide/400.OCP-takeover-OBD-deployment-cluster.md",sourceDirName:"obd/300.user-guide",slug:"/obd/user-guide/OCP-takeover-OBD-deployment-cluster",permalink:"/docs/obd/user-guide/OCP-takeover-OBD-deployment-cluster",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/obd/300.user-guide/400.OCP-takeover-OBD-deployment-cluster.md",tags:[],version:"current",sidebarPosition:400,frontMatter:{}},l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Modify the OceanBase cluster",id:"modify-the-oceanbase-cluster",level:2},{value:"Check whether takeover conditions are met",id:"check-whether-takeover-conditions-are-met",level:3},{value:"Configure IDC information",id:"configure-idc-information",level:3},{value:"Configure the password",id:"configure-the-password",level:3},{value:"Configure the user",id:"configure-the-user",level:3},{value:"Create a user",id:"create-a-user",level:4},{value:"Grant the passwordless sudo permission to the admin user",id:"grant-the-passwordless-sudo-permission-to-the-admin-user",level:4},{value:"Change the user",id:"change-the-user",level:4},{value:"Multiple OBServers on a single server",id:"multiple-observers-on-a-single-server",level:3},{value:"Use OCP to take over the cluster",id:"use-ocp-to-take-over-the-cluster",level:2},{value:"Change the password of the proxyro user",id:"change-the-password-of-the-proxyro-user",level:3},{value:"Use OCP to take over the OceanBase cluster",id:"use-ocp-to-take-over-the-oceanbase-cluster",level:3},{value:"FAQ",id:"faq",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"use-ocp-to-take-over-a-cluster-deployed-by-obd",children:"Use OCP to take over a cluster deployed by OBD"}),"\n",(0,r.jsx)(n.p,{children:"This topic describes how to use OceanBase Cloud Platform (OCP) to take over a cluster deployed by OceanBase Deployer (OBD). The cluster named test, which is started by using the distributed-example.yaml configuration file, is used as an example."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The OBD version is V1.3.0 or later."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The OCP version is V3.1.1-ce or later."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"modify-the-oceanbase-cluster",children:"Modify the OceanBase cluster"}),"\n",(0,r.jsx)(n.h3,{id:"check-whether-takeover-conditions-are-met",children:"Check whether takeover conditions are met"}),"\n",(0,r.jsx)(n.p,{children:"Before using OCP to take over an OceanBase cluster deployed by OBD, run the following command to check whether takeover conditions are met. If the conditions are not met, modify the cluster based on prompts as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster check4ocp <deploy-name>\n\n# Example\nobd cluster check4ocp test\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For information about the ",(0,r.jsx)(n.code,{children:"obd cluster check4ocp"})," command, see ",(0,r.jsx)(n.a,{href:"/docs/obd/user-guide/obd-command/cluster-command-groups",children:"obd cluster check4ocp"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"configure-idc-information",children:"Configure IDC information"}),"\n",(0,r.jsx)(n.p,{children:"The configuration file of default style does not support the configuration of Internet Data Center (IDC) information. You need to use the new feature of OBD V1.3.0 to change the style of the configuration file to the cluster style."}),"\n",(0,r.jsx)(n.p,{children:"Run the following command to change the style:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster chst <deploy name> --style <STYLE> [-c/--components]\n\n# Example\nobd cluster chst test -c oceanbase-ce --style cluster\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For information about the ",(0,r.jsx)(n.code,{children:"obd cluster chst"})," command, see ",(0,r.jsx)(n.a,{href:"/docs/obd/user-guide/obd-command/cluster-command-groups",children:"obd cluster chst"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"After changing the style of the configuration file, run the following command to enter the edit mode and add IDC information for the zone."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster edit-config <deploy name>\n\n# Example\nobd cluster edit-config test\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For information about the ",(0,r.jsx)(n.code,{children:"obd cluster edit-config"})," command, see ",(0,r.jsx)(n.a,{href:"/docs/obd/user-guide/obd-command/cluster-command-groups",children:"obd cluster edit-config"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Configuration for reference:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"## Only need to configure when remote login is required\n# user:\n#   username: your username\n#   password: your password if need\n#   key_file: your ssh-key file path if need\n#   port: your ssh port, default 22\n#   timeout: ssh connection timeout (second), default 30\noceanbase-ce:\n  style: cluster\n  config:\n    devname: eth0\n    memory_limit: 64G\n    system_memory: 30G\n    datafile_disk_percentage: 20\n    syslog_level: INFO\n    enable_syslog_wf: false\n    enable_syslog_recycle: true\n    max_syslog_file_count: 4\n    skip_proxy_sys_private_check: true\n    enable_strict_kernel_release: false\n    mysql_port: 2881\n    rpc_port: 2882\n    home_path: /root/observer\n    root_password: xxxxxx\n  zones:\n    zone1:\n      idc: idc1\n      servers:\n      - name: server1\n        ip: xxx.xxx.xxx.xxx\n    zone2:\n      idc: idc2\n      servers:\n      - name: server2\n        ip: xxx.xxx.xxx.xxx\n    zone3:\n      idc: idc3\n      servers:\n      - name: server3\n        ip: xxx.xxx.xxx.xxx\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the following command for the modification to take effect:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster reload <deploy name>\n\n# Example\nobd cluster reload test\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For information about the ",(0,r.jsx)(n.code,{children:"obd cluster reload"})," command, see ",(0,r.jsx)(n.a,{href:"/docs/obd/user-guide/obd-command/cluster-command-groups",children:"obd cluster reload"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"configure-the-password",children:"Configure the password"}),"\n",(0,r.jsxs)(n.p,{children:["To use OCP to take over a cluster, you need to configure the password for the root user to connect to the cluster under the SYS tenant. Run the following command to enter the edit mode and use ",(0,r.jsx)(n.code,{children:"root_passwd"})," to configure the password."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster edit-config <deploy name>\n\n# Example\nobd cluster edit-config test\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sample configuration file:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"## Only need to configure when remote login is required\n# user:\n#   username: your username\n#   password: your password if need\n#   key_file: your ssh-key file path if need\n#   port: your ssh port, default 22\n#   timeout: ssh connection timeout (second), default 30\noceanbase-ce:\nservers:\n    - name: server1\n    # Please don't use hostname, only IP can be supported\n    ip: xxx.xxx.xxx.xxx\n    - name: server2\n    ip: xxx.xxx.xxx.xxx\n    - name: server3\n    ip: xxx.xxx.xxx.xxx\nglobal:\n    # The working directory for OceanBase Database. OceanBase Database is started under this directory. This is a required field.\n    home_path: /root/observer\n    # External port for OceanBase Database. The default value is 2881. DO NOT change this value after the cluster is started.\n    mysql_port: 2881\n    # Internal port for OceanBase Database. The default value is 2882. DO NOT change this value after the cluster is started.\n    rpc_port: 2882\n    # The maximum running memory for an observer. When ignored, autodeploy calculates this value based on the current server available resource.\n    memory_limit: 64G \n    # The reserved system memory. system_memory is reserved for general tenants. The default value is 30G. Autodeploy calculates this value based on the current server available resource.\n    system_memory: 30G\n    # Password for root. The default value is empty.\n    root_password: xxxxxx\n    # Password for proxyro. proxyro_password must be the same as observer_sys_password. The default value is empty.\n    # proxyro_password:\nserver1:\n    zone: zone1\nserver2:\n    zone: zone2\nserver3:\n    zone: zone3\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The preceding shows a sample configuration file of the default style. For a configuration file of the cluster style, see the configuration example in ",(0,r.jsx)(n.strong,{children:"Configure IDC information"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Run the following command for the modification to take effect:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster reload <deploy name>\n\n# Example\nobd cluster reload test\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configure-the-user",children:"Configure the user"}),"\n",(0,r.jsxs)(n.p,{children:["OCP requires the process to be started by the admin user with the passwordless sudo permission. Therefore, you need to prepare an admin user as required. If this condition is already met, go to ",(0,r.jsx)(n.strong,{children:"Change the user"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"create-a-user",children:"Create a user"}),"\n",(0,r.jsx)(n.p,{children:"On a server where OBServer is deployed, you can create the admin user as the root user."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# Create a user group\ngroupadd admin\n# Create the admin user\nuseradd admin -g admin\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then, configure passwordless SSH logon for the admin user. For information about how to configure passwordless SSH logon, see ",(0,r.jsx)(n.a,{href:"https://en.oceanbase.com/docs/community-observer-en-10000000000209361",children:"Use SSH to log on without a password"}),"."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Note"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"You need to configure passwordless SSH logon for the admin user."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["A private key needs to be configured here, that is, ",(0,r.jsx)(n.code,{children:"id_rsa"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"grant-the-passwordless-sudo-permission-to-the-admin-user",children:"Grant the passwordless sudo permission to the admin user"}),"\n",(0,r.jsx)(n.p,{children:"Perform the following operations as the root user:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# Add the write permission on the sudoers file.\nchmod u+w /etc/sudoers\n# vi /etc/sudoers\necho 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n# Revoke the write permission on the sudoers file.\nchmod u-w /etc/sudoers\n"})}),"\n",(0,r.jsx)(n.h4,{id:"change-the-user",children:"Change the user"}),"\n",(0,r.jsx)(n.p,{children:"Run the following command to enter the edit mode and modify the user field."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster edit-config <deploy name>\n\n# Example\nobd cluster edit-config test\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sample configuration after modification:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"## Only need to configure when remote login is required\nuser:\n  username: admin\n#   password: your password if need\n  key_file: your ssh-key file path if need # Set it to the id_rsa file path of the admin user.\n#   port: your ssh port, default 22\n#   timeout: ssh connection timeout (second), default 30\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the following command for the modification to take effect:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"obd cluster restart <deploy name>\n\n# Example\nobd cluster restart test --wp\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For information about the ",(0,r.jsx)(n.code,{children:"obd cluster restart"})," command, see ",(0,r.jsx)(n.a,{href:"/docs/obd/user-guide/obd-command/cluster-command-groups",children:"obd cluster restart"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"multiple-observers-on-a-single-server",children:"Multiple OBServers on a single server"}),"\n",(0,r.jsx)(n.p,{children:"OCP requires that one server have only one OBServer installed. At present, the scenario with multiple OBServers running on a single server is not supported. To use OCP to take over a cluster with multiple OBServers running on a single server, you need to keep only one OBServer running and stop other OBServers."}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Note"})}),"\n",(0,r.jsxs)(n.p,{children:["After all the preceding operations are completed, you can run the ",(0,r.jsx)(n.code,{children:"obd cluster check4ocp <deploy name>"})," command again to check whether takeover conditions are met. If not, you can make modifications based on prompts."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"use-ocp-to-take-over-the-cluster",children:"Use OCP to take over the cluster"}),"\n",(0,r.jsx)(n.h3,{id:"change-the-password-of-the-proxyro-user",children:"Change the password of the proxyro user"}),"\n",(0,r.jsx)(n.p,{children:"Before using OCP to take over the cluster, check whether the password of the proxyro user in the cluster is the default value. If not, change the password of the proxyro user in OCP to that of the proxyro user in the cluster."}),"\n",(0,r.jsx)(n.p,{children:"You can call an OCP API to change the password."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl --user user:pass -X POST "http://ocp-site-url:port/api/v2/obproxy/password" -H "Content-Type:application/json" -d \'{"username":"proxyro","password":"*****"}\'\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Note:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"user:pass"})," represents the username and password of OCP. The caller must have the admin permissions."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"password"})," after ",(0,r.jsx)(n.code,{children:"-d"})," represents the password of the proxyro user in the cluster to be taken over."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This operation produces an O&M task to change the password of the proxyro user in the existing OceanBase cluster in OCP, as well as the corresponding configuration of the OBProxy cluster."}),"\n",(0,r.jsx)(n.p,{children:"You can proceed with subsequent steps only after the O&M task succeeds. If the task fails, you need to try it again and ensure that it is successful so that you can execute the subsequent steps."}),"\n",(0,r.jsx)(n.h3,{id:"use-ocp-to-take-over-the-oceanbase-cluster",children:"Use OCP to take over the OceanBase cluster"}),"\n",(0,r.jsxs)(n.p,{children:["You can directly take over the OceanBase cluster on the GUI of OCP. For detailed steps, see ",(0,r.jsx)(n.a,{href:"https://en.oceanbase.com/docs/community-ocp-en-10000000000779629",children:"Take over a cluster"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["After using OCP to take over the OceanBase cluster, you need to create an OBProxy cluster and associate it with the OceanBase cluster that has been taken over. For detailed steps, see ",(0,r.jsx)(n.a,{href:"https://en.oceanbase.com/docs/community-ocp-en-10000000000779538",children:"Create an OBProxy cluster"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"If original OBProxies use a virtual IP address (VIP), add the OBProxies created in OCP to the VIP one by one, and then delete the original OBProxies from the VIP one by one."}),"\n",(0,r.jsx)(n.h3,{id:"faq",children:"FAQ"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Why do I need to change the password of the proxyro user in OCP?"}),"\n",(0,r.jsx)(n.p,{children:"Typically, an OBProxy managed in OCP is started by ConfigServer and can theoretically connect to multiple OceanBase clusters. However, the password of the proxyro user can be changed only globally for OBProxies. This password is a global configuration in OCP. It is used by OBProxies to query metadata, and the change of it does not affect business tenants."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"When I switch to a new OBProxy, can I reuse the original server?"}),"\n",(0,r.jsx)(n.p,{children:"If multiple OBProxies have been deployed and are accessed through a VIP, you can delete them from the VIP one by one, deploy new OBProxies in OCP by using the original servers, and add the new OBProxies back to the VIP, thereby reusing the servers."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Can I choose not to switch to a new OBProxy?"}),"\n",(0,r.jsx)(n.p,{children:"Yes, you can. The original OBProxy can still properly connect to the OceanBase cluster that has been taken over. However, we recommend that you create a new OBProxy in OCP to facilitate subsequent O&M management."}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>i});var r=s(96540);const o={},t=r.createContext(o);function a(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);