"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[8226],{74932:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var i=s(74848),t=s(28453);const o={title:"Use SQL Diagnoser to diagnose and analyze SQL performance issues",weight:9},r="7.8 Use SQL Diagnoser to diagnose and analyze SQL performance issues",a={id:"user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/performance_diagnosis_by_sql_diagnoser",title:"Use SQL Diagnoser to diagnose and analyze SQL performance issues",description:"This topic describes how to use SQL Diagnoser to diagnose and analyze SQL performance issues. We recommend that you use this tool in troubleshooting.",source:"@site/docs/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/08_performance_diagnosis_by_sql_diagnoser.md",sourceDirName:"user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning",slug:"/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/performance_diagnosis_by_sql_diagnoser",permalink:"/docs/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/performance_diagnosis_by_sql_diagnoser",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/08_performance_diagnosis_by_sql_diagnoser.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{title:"Use SQL Diagnoser to diagnose and analyze SQL performance issues",weight:9},sidebar:"quick_starts_and_hands_on_practices_in_englishSidebar",previous:{title:"Typical scenarios and troubleshooting logic for SQL performance issues",permalink:"/docs/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/troubleshooting_sql_performance_issues"},next:{title:"Use obdiag for diagnostics and analytics",permalink:"/docs/user_manual/quick_starts_and_hands_on_practices_in_english/chapter_07_diagnosis_and_tuning/diagnose_and_analyze_through_obdiag"}},d={},c=[{value:"Overview",id:"overview",level:2},{value:"Use SQL Diagnoser",id:"use-sql-diagnoser",level:2},{value:"Start SQL Diagnoser",id:"start-sql-diagnoser",level:3},{value:"Stop SQL Diagnoser",id:"stop-sql-diagnoser",level:3},{value:"Features",id:"features",level:3},{value:"Tenant SQL diagnostics",id:"tenant-sql-diagnostics",level:4},{value:"Procedure",id:"procedure",level:4},{value:"SQL review",id:"sql-review",level:4},{value:"Diagnostic items of SQL review",id:"diagnostic-items-of-sql-review",level:4},{value:"Procedure",id:"procedure-1",level:4}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"78-use-sql-diagnoser-to-diagnose-and-analyze-sql-performance-issues",children:"7.8 Use SQL Diagnoser to diagnose and analyze SQL performance issues"})}),"\n",(0,i.jsx)(n.p,{children:"This topic describes how to use SQL Diagnoser to diagnose and analyze SQL performance issues. We recommend that you use this tool in troubleshooting."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"SQL Diagnoser is an agile SQL diagnostic tool for OceanBase Database. It provides the following features:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"SQL advisor: You can use this feature on the GUI to directly analyze the SQL statements executed in a business cluster to find common suspicious SQL statements. This feature helps you identify hidden performance issues and provides optimization suggestions."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"SQL review: You can use this feature on the GUI by simply entering the SQL statement that you want to review. Then this feature analyzes the SQL statement based on common diagnostic items and provides suggestions for improvement."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"As shown in the following figure, SQL Diagnoser contains two diagnostic rule engines."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The static rule engine functions based on SQL syntax parsing. It parses the SQL syntax tree and implements static rules such as predicate calculus and implicit conversion rules based on the nodes of the SQL syntax tree."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The dynamic rule engine queries the internal performance views ",(0,i.jsx)(n.code,{children:"gv$(ob_)sql_audit"})," and ",(0,i.jsx)(n.code,{children:"gv$(ob_)plan_cache_plan_stat"})," of OceanBase Database as well as tables and indexes to analyze SQL statement exceptions."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Architecture",src:s(65846).A+"",width:"1474",height:"1822"})}),"\n",(0,i.jsx)(n.h2,{id:"use-sql-diagnoser",children:"Use SQL Diagnoser"}),"\n",(0,i.jsx)(n.h3,{id:"start-sql-diagnoser",children:"Start SQL Diagnoser"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Decompress the package."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Open the package."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Run the following command. ",(0,i.jsx)(n.code,{children:"-Dserver.port=9090"})," specifies the port number. If this parameter is not specified, port ",(0,i.jsx)(n.code,{children:"8080"})," is used by default."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"java -Dserver.port=9090 -jar sql-diagnoser-4.2.0.0.jar &\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Note"})}),"\n",(0,i.jsx)(n.p,{children:"If you deploy SQL Diagnoser in a production environment, use a Java virtual machine (JVM) parameter to specify the maximum memory size for this process to prevent it from occupying excessive memory."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"stop-sql-diagnoser",children:"Stop SQL Diagnoser"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the following command to query the process ID."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ps -ef  |  grep sql-diagnoser\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the following command to stop the process."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kill -9 <Process ID>\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"features",children:"Features"}),"\n",(0,i.jsx)(n.h4,{id:"tenant-sql-diagnostics",children:"Tenant SQL diagnostics"}),"\n",(0,i.jsx)(n.p,{children:"You can use this feature to directly analyze a business cluster to find common suspicious SQL statements. This feature helps you identify hidden performance issues and provides suggestions on index optimization and SQL rewriting."}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Full table scan with unused index"}),(0,i.jsx)(n.th,{children:"Indexes are created for tables involved in the SQL statement for full table scan."})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Full table scan without available index"}),(0,i.jsx)(n.td,{children:"No indexes are created for tables involved in the SQL statement for full table scan."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Poor performance despite the use of index"}),(0,i.jsx)(n.td,{children:"Despite the use of indexes, the SQL performance is still poor because the response time or CPU time is too long."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Hint with no effect"}),(0,i.jsx)(n.td,{children:"The indexes specified in the hints are not used during SQL execution."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Too many partitions involved"}),(0,i.jsx)(n.td,{children:"During SQL execution, too many irrelevant partitions are involved in the calculation, wasting system resources."})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"The following diagnostic items are designed based on development specifications. They affect the response time of SQL statements and also increase the system load."})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Too many rows affected"}),(0,i.jsx)(n.th,{children:"The number of rows affected by SQL execution exceeds the specified threshold."})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Too many rows returned"}),(0,i.jsx)(n.td,{children:"The number of rows returned from SQL execution exceeds the specified threshold."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Too many tables involved in SQL execution"}),(0,i.jsx)(n.td,{children:"The number of tables involved in SQL execution exceeds the specified threshold."})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"procedure",children:"Procedure"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Obtain logon connection information of a user, log on to OceanBase Database by using the connection information, and verify that the user has the privilege to access tables in the ",(0,i.jsx)(n.code,{children:"oceanbase"})," and ",(0,i.jsx)(n.code,{children:"information_schema"})," databases."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Specify the following fields on the page that appears, and then click ",(0,i.jsx)(n.strong,{children:"One-click Diagnostics"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The fields are described as follows:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response Time"}),": The response time of SQL statements. SQL statements whose execution time exceeds this value will be returned for analysis."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Samples"}),": The number of SQL statements collected for diagnostics each time. The default value is ",(0,i.jsx)(n.code,{children:"10000"}),". You can modify this field based on your business needs."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Logon User"}),": The username used to log on to OceanBase Database. If you directly connect to an OBServer node, specify the username in the format of ",(0,i.jsx)(n.code,{children:"user@tenant"}),", for example, ",(0,i.jsx)(n.code,{children:"root@ocp_meta"}),". If you connect to an OceanBase cluster through ODP, specify the username in the format of ",(0,i.jsx)(n.code,{children:"user@tenant#cluster"}),", for example, ",(0,i.jsx)(n.code,{children:"root@ocp_meta#obcluster"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"sql-review",children:"SQL review"}),"\n",(0,i.jsx)(n.p,{children:"You can use this feature to analyze table schemas and SQL statement structures to identify SQL syntax errors. This feature does not execute SQL statements. We recommend that you review the SQL statements before you launch new business."}),"\n",(0,i.jsx)(n.h4,{id:"diagnostic-items-of-sql-review",children:"Diagnostic items of SQL review"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["0001 Diagnostic item 1 related to indexes: The indexed column in the query condition involves calculation, for example, ",(0,i.jsx)(n.code,{children:"ID+1=10"}),", which invalidates the index and causes a failure to extract the query range."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"0002 Diagnostic item 2 related to indexes: The indexed column in the query condition uses fuzzy match or prefix fuzzy match."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"0003 Diagnostic item 3 related to indexes: The indexed column in the query condition involves implicit data type conversion or precision conversion."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["1001 Diagnostic item 1 related to execution plans: Too many ",(0,i.jsx)(n.code,{children:"in"})," conditions exist. We recommend that you use no more than 200 ",(0,i.jsx)(n.code,{children:"in"})," conditions, for example, ",(0,i.jsx)(n.code,{children:"in(?,?,?..) "}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"1002 Diagnostic item 2 related to execution plans: Too many table connections exist. We recommend that you use no more than 10 table connections. Otherwise, no optimal plan is available after pruning."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["1003 Diagnostic item 3 related to execution plans: The ",(0,i.jsx)(n.code,{children:"not in"})," clause must contain the ",(0,i.jsx)(n.code,{children:"not null"})," constraint to avoid nested-loop joins."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["2001 Diagnostic item 1 related to high-risk SQL statements: The ",(0,i.jsx)(n.code,{children:"UPDATE"})," or ",(0,i.jsx)(n.code,{children:"DELETE"})," statement does not contain the ",(0,i.jsx)(n.code,{children:"WHERE"})," condition, or the ",(0,i.jsx)(n.code,{children:"WHERE"})," condition is identically true."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["2002 Diagnostic item 2 related to high-risk SQL statements: We recommend that you use the ",(0,i.jsx)(n.code,{children:"not in"})," clause with caution. It involves special logic for processing null values, and the semantics are difficult to control."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["2003 Diagnostic item 3 related to high-risk SQL statements: We recommend that you do not use the ",(0,i.jsx)(n.code,{children:"INSERT"})," or ",(0,i.jsx)(n.code,{children:"REPLACE"})," statement without fields."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["3001 Diagnostic item 1 related to performance: The ",(0,i.jsx)(n.code,{children:"UPDATE"}),", ",(0,i.jsx)(n.code,{children:"DELETE"}),", or ",(0,i.jsx)(n.code,{children:"SELECT"})," statement does not contain an index key, resulting in a full table scan."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"3002 Diagnostic item 2 related to performance: The operation on the partitioned table does not contain a partitioning key, and thus partitions cannot be pruned."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"4001 Diagnostic item 1 related to DDL operations: Too many indexes exist, which are redundant."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"4002 Diagnostic item 2 related to DDL operations: Data skew occurs in the indexed column, leading to poor performance."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["4003 Diagnostic item 3 related to DDL operations: When you create an index, you must manually specify the ",(0,i.jsx)(n.code,{children:"global"})," or ",(0,i.jsx)(n.code,{children:"local"})," keyword. We recommend that you use a local index."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"4004 Diagnostic item 4 related to DDL operations: Too many table fields exist."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"procedure-1",children:"Procedure"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"In input area 1, enter the tenant connection information. The logon user must have at least the read privilege on business databases. SQL review will not execute the SQL statement."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Enter SQL text in the text box. The SQL text must be a string without Chinese characters."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"One-click Review"}),". The rewriting suggestions will be displayed at the bottom."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},65846:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/001-58a2df86bc29429ef90c806a2831121a.png"},28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var i=s(96540);const t={},o=i.createContext(t);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);