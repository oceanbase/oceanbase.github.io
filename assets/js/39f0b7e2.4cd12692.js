"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[3621],{44721:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>l,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var s=o(74848),t=o(28453);const a={title:"Node Failures",weight:4},r=void 0,i={id:"user_manual/operation_and_maintenance/en-US/emergency_handbook/node_breakdown",title:"Node Failures",description:"Business and Database Symptoms",source:"@site/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/04_node_breakdown.md",sourceDirName:"user_manual/operation_and_maintenance/en-US/emergency_handbook",slug:"/user_manual/operation_and_maintenance/en-US/emergency_handbook/node_breakdown",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/node_breakdown",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/04_node_breakdown.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Node Failures",weight:4},sidebar:"operation_and_maintenanceEnglishSidebar",previous:{title:"High CPU Load",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/cpu_high"},next:{title:"Network Jitter",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/network_problem"}},c={},d=[{value:"Business and Database Symptoms",id:"business-and-database-symptoms",level:2},{value:"Troubleshooting Approach and Procedure",id:"troubleshooting-approach-and-procedure",level:2},{value:"Troubleshoot node failures",id:"troubleshoot-node-failures",level:3},{value:"If healthy nodes cannot form the majority",id:"if-healthy-nodes-cannot-form-the-majority",level:3},{value:"If healthy nodes can form the majority",id:"if-healthy-nodes-can-form-the-majority",level:3},{value:"References",id:"references",level:2},{value:"Updates Released on December 4, 2024",id:"updates-released-on-december-4-2024",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"business-and-database-symptoms",children:"Business and Database Symptoms"}),"\n",(0,s.jsx)(n.p,{children:"Business symptom: Business fails."}),"\n",(0,s.jsx)(n.p,{children:"Database symptom: Database services held by a certain OBServer node are unavailable."}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting-approach-and-procedure",children:"Troubleshooting Approach and Procedure"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image",src:o(48317).A+"",width:"2214",height:"1510"})}),"\n",(0,s.jsx)(n.h3,{id:"troubleshoot-node-failures",children:"Troubleshoot node failures"}),"\n",(0,s.jsxs)(n.p,{children:["Check the availability of the host. If you can log in to the node, run the ",(0,s.jsx)(n.code,{children:"ps"})," command to check whether the observer process is running on the node."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"$ps -ef | grep observer\n03:55:52 /home/xiaofeng.lby/obn.obs0/bin/observer\n00:00:00 grep --color=auto observer\n"})}),"\n",(0,s.jsx)(n.p,{children:"If the observer process is running on the node, test the network connectivity of the host on which the node resides. This aims to identify misreported alerts due to network isolation between nodes and network jitter."}),"\n",(0,s.jsxs)(n.p,{children:["For more information, see ",(0,s.jsx)(n.a,{href:"https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000207684",children:"Troubleshoot NTP clock synchronization issues"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"if-healthy-nodes-cannot-form-the-majority",children:"If healthy nodes cannot form the majority"}),"\n",(0,s.jsx)(n.p,{children:"If the host or network issue cannot be fixed in time, try the following measures in order:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Initiate a ",(0,s.jsx)(n.strong,{children:"failover"})," to switch the physical standby tenant or cluster to the primary role in OceanBase Cloud Platform (OCP)."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.strong,{children:"physical backup and restore"})," feature in OCP."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If no physical standby database or data backup is available, restart the observer process on each node in the cluster, one by one."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If the issue persists after the restart, contact the engineers on duty in the OceanBase community forum for troubleshooting."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Contact the engineers on duty in the OceanBase community forum to identify the cause."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)("font",{color:"red",children:"We recommend that you back up important data and key tenants in the production environment to prevent losses caused by unexpected faults."})})," You can use the ",(0,s.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001703571",children:"physical backup and restore"})," feature and ",(0,s.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001703770",children:"create standby tenants or clusters"})," in the OCP console."]}),"\n",(0,s.jsx)(n.h3,{id:"if-healthy-nodes-can-form-the-majority",children:"If healthy nodes can form the majority"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["If healthy nodes in the cluster can form the majority, the cluster can elect a new leader within eight seconds by using its high-availability capability and continue to provide services. You need to only restart or replace the abnormal nodes. In most cases, the issue is fixed after you perform the preceding operations. ",(0,s.jsx)(n.strong,{children:(0,s.jsx)("font",{color:"red",children:"You can record the following statements. "})})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"-- Before a fault occurs\nSELECT SVR_IP, ROLE, SCN_TO_TIMESTAMP(END_SCN)\nFROM oceanbase.GV$OB_LOG_STAT \nWHERE TENANT_ID = 1 order by LS_ID, ROLE;\n+---------------+----------+----------------------------+\n| SVR_IP        | ROLE     | SCN_TO_TIMESTAMP(END_SCN)  |\n+---------------+----------+----------------------------+\n| xx.xxx.xxx.1  | FOLLOWER | 2024-11-27 19:44:27.881516 |\n| xx.xxx.xxx.2  | FOLLOWER | 2024-11-27 19:44:27.881516 |\n| xx.xxx.xxx.3  | LEADER   | 2024-11-27 19:44:27.881516 |\n+---------------+----------+----------------------------+\n\n-- After the system elects the leader\nSELECT SVR_IP, ROLE, SCN_TO_TIMESTAMP(END_SCN)\nFROM oceanbase.GV$OB_LOG_STAT \nWHERE TENANT_ID = 1 order by LS_ID, ROLE;\n+---------------+----------+----------------------------+\n| SVR_IP        | ROLE     | SCN_TO_TIMESTAMP(END_SCN)  |\n+---------------+----------+----------------------------+\n| xx.xxx.xxx.1  | FOLLOWER | 2024-11-27 19:44:38.737837 |\n| xx.xxx.xxx.2  | LEADER   | 2024-11-27 19:44:38.737837 |\n+---------------+----------+----------------------------+\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"SCN_TO_TIMESTAMP(END_SCN)"})," function obtains the latest system change numbers (SCNs) of replicas of a specific log stream and converts them into timestamps. If the difference between the latest SCN of followers and that of the leader is within five seconds, the logs have been synchronized."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["If the cluster cannot provide services, isolate the abnormal nodes first. Then, determine whether to specify a greater value for the ",(0,s.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715463",children:"server_permanent_offline_time"})," parameter. By default, this parameter is set to one hour."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"-- Check the status of nodes in the cluster.\nselect SVR_IP, SVR_PORT, ZONE, WITH_ROOTSERVER, STATUS from oceanbase.DBA_OB_SERVERS;\n+---------------+----------+-------+-----------------+----------+\n| SVR_IP        | SVR_PORT | ZONE  | WITH_ROOTSERVER | STATUS   |\n+---------------+----------+-------+-----------------+----------+\n| xx.xxx.xxx.3  |     2882 | zone3 | NO              | INACTIVE |\n| xx.xxx.xxx.2  |     2882 | zone2 | YES             | ACTIVE   |\n| xx.xxx.xxx.1  |     2882 | zone1 | NO              | ACTIVE   |\n+---------------+----------+-------+-----------------+----------+\n\n-- Check the value of the server_permanent_offline_time parameter.\nshow parameters like \"%server_permanent_offline_time%\";\n\n-- Stop the abnormal node to isolate it.\nalter system stop server 'xx.xxx.xxx.3:2882';\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"STOP SERVER"})," is the most secure statement for node isolation. The ",(0,s.jsx)(n.code,{children:"STOP SERVER"})," statement can switch the business traffic from an abnormal node to isolate the node from the business traffic. The statement can also ensure that other nodes are still the majority in the Paxos group. This way, you can securely perform all actions on the isolated node. For example, you can run the ",(0,s.jsx)(n.code,{children:"pstack"})," or ",(0,s.jsx)(n.code,{children:"obstack"})," command, adjust the log level, or even stop the observer process. When you need to isolate a fault or stop a node for maintenance, you can use the ",(0,s.jsx)(n.code,{children:"STOP SERVER"})," statement, which is the best choice in this case."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If the cluster remains faulty two minutes after you execute the previous step, manually specify a zone with no faulty nodes as the primary zone for the leader switchover."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ALTER TENANT tenant_name primary_zone='zone1';\n\n-- Check the ROLE column in the GV$OB_LOG_STAT view to determine whether the leader switchover is successful.\nSELECT SVR_IP, ROLE, SCN_TO_TIMESTAMP(END_SCN)\nFROM oceanbase.GV$OB_LOG_STAT \nWHERE TENANT_ID = 1 order by LS_ID, ROLE;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:'If the cluster still cannot provide services three minutes after the leader switchover, refer to the "If healthy nodes cannot form the majority" section of this topic.'}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Contact the engineers on duty in the OceanBase community forum to identify the cause."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://open.oceanbase.com/blog/13250502949",children:"Quick Fixes for OceanBase Issues"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715007",children:"Troubleshoot common problems"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001714999",children:"Isolate a node"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"updates-released-on-december-4-2024",children:"Updates Released on December 4, 2024"}),"\n",(0,s.jsx)(n.p,{children:"I want to provide more suggestions for you."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If the host of the node can be restored, you can restart the node in OCP."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"image",src:o(18362).A+"",width:"3288",height:"482"})}),"\n",(0,s.jsx)(n.p,{children:"If the node cannot be immediately restarted in OCP, you can go to the installation directory of the node and manually start its observer process."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[xiaofeng.lby@sqaobnoxdn011161204091.sa128 /home/xiaofeng.lby/oceanbase]\n$sudo su admin\n\n[admin@sqaobnoxdn011161204091.sa128 /home/xiaofeng.lby/oceanbase]\n$export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/xiaofeng.lby/oceanbase/lib\n\n[admin@sqaobnoxdn011161204091.sa128 /home/xiaofeng.lby/oceanbase]\n$./bin/observer\n./bin/observer\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that you must run the ",(0,s.jsx)(n.code,{children:"./bin/observer"})," command in the ",(0,s.jsx)(n.code,{children:"/oceanbase"})," directory. This may be because specific configuration files in the ",(0,s.jsx)(n.code,{children:"etc"})," directory are required."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[admin@sqaobnoxdn011161204091.sa128 /home/xiaofeng.lby/oceanbase]\n$find . -name observer.config.bin\n./etc/observer.config.bin\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"After you restart the node, you can switch back to the original leader during off-peak hours. This prevents the session from accessing the leader through cross-IDC communication for a long period of time."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ALTER TENANT tenant_name primary_zone='zone1';\n\n-- Check the ROLE column in the GV$OB_LOG_STAT view to determine whether the leader switchover is successful.\nSELECT SVR_IP, ROLE, SCN_TO_TIMESTAMP(END_SCN)\nFROM oceanbase.GV$OB_LOG_STAT \nWHERE TENANT_ID = 1 order by LS_ID, ROLE;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If the host of the node cannot be restored, add a new node to replace the abnormal node in OCP. After the new node is added, the system automatically adds replicas."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If no new host is available, you can temporarily use two replicas to provide services. However, this method does not ensure high availability and may cause risks. You must put new hosts online at the earliest opportunity."}),"\n"]}),"\n"]})]})}function l(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},48317:(e,n,o)=>{o.d(n,{A:()=>s});const s=o.p+"assets/images/001-1d77afd0d8c6b257a4beb0b01ffadbe2.png"},18362:(e,n,o)=>{o.d(n,{A:()=>s});const s=o.p+"assets/images/1-47df72cf141bc25a609edc64d2f155f7.png"},28453:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>i});var s=o(96540);const t={},a=s.createContext(t);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);