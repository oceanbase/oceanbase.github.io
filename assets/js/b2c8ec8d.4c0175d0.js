"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[8910],{95278:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var s=o(74848),t=o(28453);const i={slug:"practices-binlog",title:"Practices of OceanBase Binlog Service"},r=void 0,a={id:"blogs/tech/practices-binlog",title:"Practices of OceanBase Binlog Service",description:"The OceanBase team has recently released an open source edition of the binlog service, which converts clogs in OceanBase into binlogs for downstream tools such as Canal and Flink CDC to consume. Today, we will try the binlog service and check its correctness by using the MySQL binlog tool named mysqlbinlog.",source:"@site/docs/blogs/tech/practices-binlog.md",sourceDirName:"blogs/tech",slug:"/blogs/tech/practices-binlog",permalink:"/docs/blogs/tech/practices-binlog",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/blogs/tech/practices-binlog.md",tags:[],version:"current",frontMatter:{slug:"practices-binlog",title:"Practices of OceanBase Binlog Service"},sidebar:"blogsSidebar",previous:{title:"A Brief Analysis of Frequently Asked Questions about Partition Creation",permalink:"/docs/blogs/tech/partition-create"},next:{title:"Distributed Pushdown Techniques in OceanBase Database",permalink:"/docs/blogs/tech/pushdown-tech"}},l={},c=[{value:"Introduction",id:"introduction",level:3},{value:"Limitations",id:"limitations",level:3},{value:"Environment",id:"environment",level:3},{value:"Installation and Configuration",id:"installation-and-configuration",level:3},{value:"Configure ODP",id:"configure-odp",level:4},{value:"Install and start the binlog service",id:"install-and-start-the-binlog-service",level:4},{value:"Configure the binlog service",id:"configure-the-binlog-service",level:4},{value:"Parse Binlogs",id:"parse-binlogs",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"The OceanBase team has recently released an open source edition of the binlog service, which converts clogs in OceanBase into binlogs for downstream tools such as Canal and Flink CDC to consume. Today, we will try the binlog service and check its correctness by using the MySQL binlog tool named mysqlbinlog."}),"\n",(0,s.jsxs)(n.p,{children:["The binlog service is a service mode provided by oblogproxy. When binlog_mode is set to true, the service compatible with native MySQL binlogs is enabled, providing functionalities such as the generation of binlog files that contain SQL statements and binlog dump. To use the binlog service, download oblogproxy in the ",(0,s.jsx)(n.a,{href:"https://www.oceanbase.com/softwarecenter",children:"software center"})," of the OceanBase official website."]}),"\n",(0,s.jsxs)(n.p,{children:["Currently, the binlog service documentation is unavailable on the OceanBase official website. You can view it on GitHub: ",(0,s.jsx)(n.a,{href:"https://github.com/oceanbase/oblogproxy/blob/dev/docs/binlog_service.md",children:"Binlog Service Documentation"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"ODP"}),": OceanBase Database Proxy (ODP) provides SQL statements and binlogs with unified access to OceanBase. The service for binlogs consists of binlog commands such as show binlog events and the binlog replication protocol."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"oblogproxy"}),": oblogproxy ensures compatibility with MySQL binlogs, including compatibility with binlog commands and the binlog replication protocol."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bc"}),": Binlog converter (bc) is a sub-process of oblogproxy. It pulls and parses clogs through libobcdc to convert clogs into binlogs."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bd"}),": Binlog dumper (bd) is a sub-process of oblogproxy. It provides binlog event subscription service for binlog dump requests from downstream tools such as Canal and Flink CDC."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bcm"}),": Binlog converter manager (bcm) is the bc management module of oblogproxy."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bdm"}),": Binlog dumper manager (bdm) is the bd management module of oblogproxy."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"As shown in the following architecture, oblogproxy connects to ODP in the cluster to obtain cluster logs and converts them into binlogs. Downstream tools such as Canal and Flink CDC also connect to ODP to consume binlogs."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"1702608197",src:o(54226).A+"",width:"2002",height:"1917"})}),"\n",(0,s.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Currently, the binlog service requires OBServer and ODP V4.2.1 or later."}),"\n",(0,s.jsx)(n.li,{children:'The extended semantics for the ENUM and SET types in OceanBase are not supported. For example, the extended semantics support more than 64 SET definitions, duplication, and insertion of undefined data (such as ") into ENUM.'}),"\n",(0,s.jsx)(n.li,{children:"Varchar(65536) definitions are not supported."}),"\n",(0,s.jsx)(n.li,{children:"Geographic information system (GIS) data types are not supported."}),"\n",(0,s.jsx)(n.li,{children:"Differences from some MySQL DDL operations may cause incompatibility between parsed binlogs and MySQL. However, OBServer has resolved this issue. We recommend that you set init_sql in ODP to enable _show_ddl_in_compat_mode at the tenant level. After you do this, the SHOW CREATE TABLE results output by OBServer will be fully compatible with MySQL syntax."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"environment",children:"Environment"}),"\n",(0,s.jsx)(n.p,{children:"The environment consists of four servers, with three servers hosting a 3-node OceanBase cluster and one server hosting the oblogproxy service."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"IP address"}),(0,s.jsx)(n.th,{children:"Role"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"172.24.255.54"}),(0,s.jsx)(n.td,{children:"oblogproxy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"172.24.255.56"}),(0,s.jsx)(n.td,{children:"OBServer and ODP"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"172.24.255.57"}),(0,s.jsx)(n.td,{children:"OBServer"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"172.24.255.58"}),(0,s.jsx)(n.td,{children:"OBServer"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"installation-and-configuration",children:"Installation and Configuration"}),"\n",(0,s.jsx)(n.h4,{id:"configure-odp",children:"Configure ODP"}),"\n",(0,s.jsx)(n.p,{children:"As shown in the preceding architecture, oblogproxy, Canal, and Flink CDC all interact with ODP. Canal and Flink CDC are unaware of oblogproxy, the actual binlog service provider. ODP forwards downstream requests to OBServer or oblogproxy."}),"\n",(0,s.jsx)(n.p,{children:"As a result, you must configure the oblogproxy service address in ODP."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"    # Connect to ODP to access the cluster or interact with ODP.\n    [root@OB1 ~]# obclient -h172.24.255.56 -P2883 -uroot@sys#myoceanbase -pxxx -Doceanbase -A\n    \n    # Query the IP address of the binlog server. Currently, it is empty.\n    obclient [oceanbase]> show proxyconfig like 'binlog_service_ip';\n    +-------------------+-------+-----------------------------------------+-------------+---------------+\n    | name              | value | info                                    | need_reboot | visible_level |\n    +-------------------+-------+-----------------------------------------+-------------+---------------+\n    | binlog_service_ip |       | binlog service ip, format ip1:sql_port1 | false       | SYS           |\n    +-------------------+-------+-----------------------------------------+-------------+---------------+\n    1 row in set (0.001 sec)\n    \n    # Configure the binlog server address in the format of ip:port.\n    obclient [oceanbase]> alter proxyconfig set binlog_service_ip=\"172.24.255.54:2983\";\n    Query OK, 0 rows affected (0.004 sec)\n    \n    # Enable forwarding for the binlog service.\n    obclient [oceanbase]> alter proxyconfig set enable_binlog_service='True';\n    \n    # Configure init_sql to set session-level system variables for all sessions passing through the ODP.\n    obclient [oceanbase]> alter proxyconfig set init_sql='set _show_ddl_in_compat_mode = 1;';\n"})}),"\n",(0,s.jsx)(n.h4,{id:"install-and-start-the-binlog-service",children:"Install and start the binlog service"}),"\n",(0,s.jsx)(n.p,{children:"Download the installation package, upload it to the server, and start the installation."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"    [root@OB2 ~]# rpm -ivh oblogproxy-2.0.0-100000012023111521.el7.x86_64.rpm\n"})}),"\n",(0,s.jsx)(n.p,{children:"By default, oblogproxy is installed in the /usr/local/oblogproxy directory."}),"\n",(0,s.jsx)(n.p,{children:"Modify the conf/conf.json file in the installation directory."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'    [root@OB2 ~]# cd /usr/local/oblogproxy\n    [root@OB2 oblogproxy]# vim conf/conf.json\n    # Modify the following parameters to enable binlogs and specify absolute paths.\n    "binlog_mode": true\n    "oblogreader_path": "/usr/local/oblogproxy/run"\n    "bin_path": "/usr/local/oblogproxy/bin"\n    "oblogreader_obcdc_ce_path_template": "/usr/local/oblogproxy/obcdc/obcdc-ce-%d.x-access/libobcdc.so"\n    "binlog_log_bin_basename": "/usr/local/oblogproxy/run"\n    "binlog_obcdc_ce_path_template": "/usr/local/oblogproxy/obcdc/obcdc-ce-%d.x-access/libobcdc.so"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For more information about the configurations, see ",(0,s.jsx)(n.a,{href:"https://github.com/oceanbase/oblogproxy/blob/dev/docs/binlog_service.md",children:"Binlog Service Documentation"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Configure an account. As the username and a password cannot be written in plaintext in the configuration file, call the config_sys function to encrypt them and replace the values of ob_sys_username and ob_sys_password in the conf.json file with the encrypted username and password."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"    [root@OB2 oblogproxy]# ./run.sh config_sys ${sys_usr} ${sys_pwd}\n    # Enter y when a prompt appears to confirm whether to update ob_sys_username and ob_sys_password in the conf.json file.\n    DEPLOY_PATH : /usr/local/oblogproxy\n    \n    !!DANGER!! About to update logproxy conf/conf.json, Please confirm? [Y/n] y\n"})}),"\n",(0,s.jsx)(n.p,{children:'Note that the username and password you specify must belong to the sys tenant, such as root@sys#cluster_name, and must be enclosed in double quotation marks (").'}),"\n",(0,s.jsx)(n.p,{children:"Start the binlog service."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"    # Start oblogproxy.\n    [root@OB2 oblogproxy]# ./run.sh start\n"})}),"\n",(0,s.jsx)(n.p,{children:"Check the log file in the log/ directory for errors."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    [root@OB2 oblogproxy]# cat log/logproxy.log\n    [2023-12-06 15:51:34] [info] environmental.cpp(27): Max file descriptors: 655350\n    [2023-12-06 15:51:34] [info] environmental.cpp(34): Max processes/threads: 655360\n    [2023-12-06 15:51:34] [info] environmental.cpp(41): Core dump size: 18446744073709551615\n    [2023-12-06 15:51:34] [info] environmental.cpp(48): Maximum number of pending signals: 252872\n    [2023-12-06 15:51:34] [info] binlog_server.cpp(66): Start pull up all BC processes\n    [2023-12-06 15:51:34] [info] binlog_server.cpp(76): The current binlog converter [myoceanbase,obtest]is alive and the pull action is terminated\n    [2023-12-06 15:51:34] [info] binlog_server.cpp(76): The current binlog converter [myoceanbase,obtest]is alive and the pull action is terminated\n    [2023-12-06 15:51:34] [info] binlog_server.cpp(89): Finish to pull up 1 BC processes\n    [2023-12-06 15:51:34] [info] event_wrapper.cpp(43): Succeed to listen socket with port: 2983\n    [2023-12-06 15:51:34] [info] binlog_server.cpp(47): Start OceanBase binlog server on port 2983\n"})}),"\n",(0,s.jsx)(n.h4,{id:"configure-the-binlog-service",children:"Configure the binlog service"}),"\n",(0,s.jsx)(n.p,{children:"After the binlog service starts successfully, specify the tenant whose binlogs you want to obtain. Log in to oblogproxy to create a binlog subscription sub-process using the following official syntax:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"    CREATE BINLOG [IF NOT EXISTS] FOR TENANT `cluster`. `tenant` [TO USER `user` PASSWORD `pwd`] [FROM <timestamp>] WITH CLUSTER URL `<cluster url>`[, INITIAL_TRX_XID `ob_txn_id`, INITIAL_TRX_GTID_SEQ `gtid_seq`];\n    \n    -- You can specify a username and password for the binlog service, which are used for subscribing to OceanBase logs. In version 4.x, business tenants are allowed.\n    [TO USER `user` PASSWORD `pwd`]\n    \n    -- You can map an OceanBase transaction ID to the global transaction ID (GTID) of a binlog.\n    -- INITIAL_TRX_XID: The OceanBase transaction ID.\n    -- INITIAL_TRX_GTID_SEQ: The GTID to map to.\n    [, INITIAL_TRX_XID `ob_txn_id`, INITIAL_TRX_GTID_SEQ `gtid_seq`]\n    \n    -- Example:\n    CREATE BINLOG FOR TENANT `cluster`. `tenant` TO USER `user` PASSWORD `pwd` FROM 1668339370000000 WITH CLUSTER URL 'cluster_url', SERVER UUID '2340778c-7464-11ed-a721-7cd30abc99b4', INITIAL_TRX_XID '97984179', INITIAL_TRX_GTID_SEQ '31';\n"})}),"\n",(0,s.jsx)(n.p,{children:"To obtain the preceding parameters, connect to the target OBServer cluster and run the following commands:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"timestamp: select time\\_to\\_usec(NOW());\n\ncluster\\_url\uff1ashow parameters like '%url%'\n\nSERVER UUID: show global variables like '%uuid';\n\nINITIAL\\_TRX\\_XID: select \\* from GV$OB\\_TRANSACTION\\_PARTICIPANTS;\n\nINITIAL\\_TRX\\_GTID\\_SEQ: 1 # For the first startup, you can specify any number.\n"})}),"\n",(0,s.jsx)(n.p,{children:"For the first startup, you do not need to specify the timestamp, INITIAL_TRX_XID, or INITIAL_TRX_GTID_SEQ because the system configures them automatically. The following code executes the startup command and queries the status:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:'    [root@OB2 oblogproxy]# mysql -A -c -h 127.0.0.1 -P 2983\n    MySQL [(none)]> CREATE BINLOG FOR TENANT `myoceanbase`. `obtest` TO USER `root` PASSWORD `xxxx` WITH CLUSTER URL \'http://172.24.255.53:8080/services?Action=ObRootServiceInfo&User_ID=alibaba&UID=ocpmaster&ObRegion=myoceanbase\', SERVER UUID \'xxxx-xxx-xx-xx-xxxxxx\';\n    MySQL [(none)]> SHOW BINLOG STATUS\\G;\n    *************************** 1. row ***************************\n    cluster: myoceanbase\n     tenant: obtest\n     status: {\n    \t"binlog_files" :\n    \t[\n    \t\t{\n    \t\t\t"binlog_name" : "mysql-bin.000001",\n    \t\t\t"binlog_size" : 178\n    \t\t}\n    \t],\n    \t"client_id" : "/usr/local/oblogproxy/run/myoceanbase/obtest",\n    \t"cpu_status" :\n    \t{\n    \t\t"cpu_count" : 16,\n    \t\t"cpu_used_ratio" : 0.12666244804859161\n    \t},\n    \t"disk_status" :\n    \t{\n    \t\t"disk_total_size_mb" : 503837,\n    \t\t"disk_usage_size_process_mb" : 0,\n    \t\t"disk_used_ratio" : 0.45975583791732788,\n    \t\t"disk_used_size_mb" : 231642\n    \t},\n    \t"memory_status" :\n    \t{\n    \t\t"mem_total_size_mb" : 63238,\n    \t\t"mem_used_ratio" : 0.0,\n    \t\t"mem_used_size_mb" : 735\n    \t},\n    \t"network_status" :\n    \t{\n    \t\t"network_rx_bytes" : 0,\n    \t\t"network_wx_bytes" : 0\n    \t},\n    \t"pid" : 7605\n    }\n    1 row in set (0.00 sec)\n'})}),"\n",(0,s.jsx)(n.p,{children:"After startup, the subscription sub-process binlog_converter is enabled."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2023-12/1702608226013.png",alt:"1702608225"})}),"\n",(0,s.jsx)(n.p,{children:"In the run/myoceanbase/obtest/data/ directory under the home directory, mysql-bin files are automatically generated."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"1702608245",src:o(2569).A+"",width:"1980",height:"282"})}),"\n",(0,s.jsx)(n.p,{children:"Now, the binlog service is configured and started, and all create, read, update, and delete (CRUD) operations on the source OceanBase cluster can be captured and written to the mysql-bin files."}),"\n",(0,s.jsx)(n.h3,{id:"parse-binlogs",children:"Parse Binlogs"}),"\n",(0,s.jsx)(n.p,{children:"Lastly, write data to the source cluster and use the mysqlbinlog tool to check whether the parsing is correct."}),"\n",(0,s.jsx)(n.p,{children:"In this example, mysqlbinlog 3.4 is used. The corresponding MySQL version is about 5.7.9."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2023-12/1702608266385.png",alt:"1702608266"})}),"\n",(0,s.jsx)(n.p,{children:"Create a table and insert data in the source cluster to check whether the parsing succeeds."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2023-12/1702608280371.png",alt:"1702608280"})}),"\n",(0,s.jsx)(n.p,{children:"The parsing results are as follows."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2023-12/1702608301790.png",alt:"1702608301"})}),"\n",(0,s.jsx)(n.p,{children:"This is a simple test of the binlog service of OceanBase. If you are interested, download, test, and use it. For any questions, contact OceanBase Technical Support. For more information about the commands, view the binlog service documentation on GitHub or stay tuned to the official website."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},54226:(e,n,o)=>{o.d(n,{A:()=>s});const s=o.p+"assets/images/1702608197778-c28dd8a07ab618ca9f92d95a614cc705.png"},2569:(e,n,o)=>{o.d(n,{A:()=>s});const s=o.p+"assets/images/1702608245245-5a1b689af7c02c2687ea0dc2ba869892.png"},28453:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>a});var s=o(96540);const t={},i=s.createContext(t);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);