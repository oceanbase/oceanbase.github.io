"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[4524],{53644:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});var a=t(74848),i=t(28453);const s={slug:"flashback-query",title:"Practice of Flashback Queries in OceanBase Database"},o=void 0,r={id:"blogs/tech/flashback-query",title:"Practice of Flashback Queries in OceanBase Database",description:"Misoperations such as deleting data by mistake are common in the daily work of database administrators (DBAs). To help them address these issues, we need to know how to restore data.",source:"@site/docs/blogs/tech/flashback-query.md",sourceDirName:"blogs/tech",slug:"/blogs/tech/flashback-query",permalink:"/docs/blogs/tech/flashback-query",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/blogs/tech/flashback-query.md",tags:[],version:"current",frontMatter:{slug:"flashback-query",title:"Practice of Flashback Queries in OceanBase Database"},sidebar:"blogsSidebar",previous:{title:"SQL Tuning Practices - Index Failure Caused by Collations",permalink:"/docs/blogs/tech/failure-by-collation"},next:{title:"OceanBase Technical Insights for High-Concurrency Scenarios",permalink:"/docs/blogs/tech/high-concurrency"}},l={},c=[{value:"1. Preparations",id:"1-preparations",level:2},{value:"2. Flash Back to the State Before a DML Operation",id:"2-flash-back-to-the-state-before-a-dml-operation",level:2},{value:"2.1 Create a table and prepare the required data",id:"21-create-a-table-and-prepare-the-required-data",level:3},{value:"2.2 Modify the table",id:"22-modify-the-table",level:3},{value:"2.3 Flash back data",id:"23-flash-back-data",level:3},{value:"3. Flash Back to the State Before a DDL Operation",id:"3-flash-back-to-the-state-before-a-ddl-operation",level:2},{value:"3.1 Flash back the table to the state before an ADD COLUMN operation",id:"31-flash-back-the-table-to-the-state-before-an-add-column-operation",level:3},{value:"3.2 Restore the table to the state before a DROP COLUMN operation",id:"32-restore-the-table-to-the-state-before-a-drop-column-operation",level:3},{value:"3.3 Flash back the table to the state before a DROP TABLE operation",id:"33-flash-back-the-table-to-the-state-before-a-drop-table-operation",level:3},{value:"4. Flash Back to the State Before a TRUNCATE Operation",id:"4-flash-back-to-the-state-before-a-truncate-operation",level:2},{value:"5. Command Summary",id:"5-command-summary",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Misoperations such as deleting data by mistake are common in the daily work of database administrators (DBAs). To help them address these issues, we need to know how to restore data."}),"\n",(0,a.jsx)(n.p,{children:"OceanBase Database supports record-specific flashback queries, which allow you to obtain data of a specific historical version. Let's have a look at how to use this feature in advance when it might be needed unexpectedly."}),"\n",(0,a.jsxs)(n.p,{children:["In a flashback query, ",(0,a.jsx)(n.code,{children:"undo_retention"})," is used to specify the time range of data versions to be retained in minor compactions. When ",(0,a.jsx)(n.code,{children:"undo_retention"})," is set to ",(0,a.jsx)(n.code,{children:"0"}),", multi-version minor compaction is disabled, which indicates that only the latest version of row data is retained in the minor compaction file. When ",(0,a.jsx)(n.code,{children:"undo_retention"})," is set to a value greater than 0, multi-version minor compaction is enabled, and multiple versions of row data within the specified period in seconds are retained in the minor compaction file. To recover accidentally deleted data, you can first increase the value of ",(0,a.jsx)(n.code,{children:"undo_retention"})," and set ",(0,a.jsx)(n.code,{children:"undo_retention"})," to the default value after data is restored."]}),"\n",(0,a.jsx)(n.p,{children:"Default value:"}),"\n",(0,a.jsx)(n.p,{children:"1800, in seconds"}),"\n",(0,a.jsx)(n.p,{children:"Value range:"}),"\n",(0,a.jsx)(n.p,{children:"[0, 4294967295]"}),"\n",(0,a.jsx)(n.h2,{id:"1-preparations",children:"1. Preparations"}),"\n",(0,a.jsxs)(n.p,{children:["Change the value of ",(0,a.jsx)(n.code,{children:"undo_retention"})," and enable the recycle bin."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    #Change the value of undo_retention.\n    obclient [test]> ALTER SYSTEM SET undo_retention=1800;\n    Query OK, 0 rows affected (0.004 sec)\n    \n    obclient [test]> SHOW PARAMETERS LIKE 'undo_retention';\n    +-------+----------+-----------------+----------+----------------+-----------+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+--------+---------+-------------------+---------------+-----------+\n    | zone  | svr_type | svr_ip          | svr_port | name           | data_type | value | info                                                                                                                                                                           | section | scope  | source  | edit_level        | default_value | isdefault |\n    +-------+----------+-----------------+----------+----------------+-----------+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+--------+---------+-------------------+---------------+-----------+\n    | zone1 | observer | 192.168.150.116 |     2882 | undo_retention | INT       | 1800  | the low threshold value of undo retention. The system retains undo for at least the time specified in this config when active txn protection is banned. Range: [0, 4294967295] | TENANT  | TENANT | DEFAULT | DYNAMIC_EFFECTIVE | 1800          |         1 |\n    +-------+----------+-----------------+----------+----------------+-----------+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+--------+---------+-------------------+---------------+-----------+\n    1 row in set (0.004 sec)\n    \n    # Enable the recycle bin and log in again to reconnect to the database.\n    bclient [test]> SET GLOBAL recyclebin = on;\n    Query OK, 0 rows affected (0.002 sec)\n    \n    obclient [test]> SHOW VARIABLES LIKE 'recyclebin';\n    +---------------+-------+\n    | Variable_name | Value |\n    +---------------+-------+\n    | recyclebin    | ON    |\n    +---------------+-------+\n    1 row in set (0.001 sec)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"2-flash-back-to-the-state-before-a-dml-operation",children:"2. Flash Back to the State Before a DML Operation"}),"\n",(0,a.jsx)(n.h3,{id:"21-create-a-table-and-prepare-the-required-data",children:"2.1 Create a table and prepare the required data"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> create table banjin_flash (id int ,name varchar(10),dizhi varchar(10),primary key (id));\n    insert into banjin_flash values (1,'zhangsan','Beijing');\n    insert into banjin_flash values (2,'lisi','Shanghai');\n    insert into banjin_flash values (3,'wangwu','Tianjin');\n    Query OK, 0 rows affected (0.050 sec)\n    \n    obclient [test]> insert into banjin_flash values (1,'zhangsan','Beijing');\n    Query OK, 1 row affected (0.008 sec)\n    \n    obclient [test]> insert into banjin_flash values (2,'lisi','Shanghai');\n    Query OK, 1 row affected (0.001 sec)\n    \n    obclient [test]> insert into banjin_flash values (3,'wangwu','Tianjin');\n    Query OK, 1 row affected (0.001 sec)\n    \n    obclient [test]> insert into banjin_flash values (4,'zhaoliu','Hebei');\n    Query OK, 1 row affected (0.001 sec)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"22-modify-the-table",children:"2.2 Modify the table"}),"\n",(0,a.jsx)(n.p,{children:"Modify the table and record the current date and time returned by the NOW() function to facilitate subsequent data restoration."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> select now();\n    +---------------------+\n    | now()               |\n    +---------------------+\n    | 2024-10-20 17:31:13 |\n    +---------------------+\n    1 row in set (0.000 sec)\n    \n    obclient [test]> update banjin_flash set dizhi = 'Hunan' where name='lisi';\n    Query OK, 1 row affected (0.003 sec)\n    Rows matched: 1  Changed: 1  Warnings: 0\n    \n    obclient [test]> select now();\n    +---------------------+\n    | now()               |\n    +---------------------+\n    | 2024-10-20 17:31:30 |\n    +---------------------+\n    1 row in set (0.000 sec)\n    \n    obclient [test]> delete from banjin_flash;\n    Query OK, 4 rows affected (0.002 sec)\n    \n    obclient [test]> select now();\n    +---------------------+\n    | now()               |\n    +---------------------+\n    | 2024-10-20 17:31:52 |\n    +---------------------+\n    1 row in set (0.000 sec)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"23-flash-back-data",children:"2.3 Flash back data"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> select * from banjin_flash;\n    Empty set (0.001 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:31:30') * 1000;\n    +----+----------+--------+\n    | id | name     | dizhi  |\n    +----+----------+--------+\n    |  1 | zhangsan | Beijing   |\n    |  2 | lisi     | Hunan   |\n    |  3 | wangwu   | Tianjin   |\n    |  4 | zhaoliu  | Hebei   |\n    +----+----------+--------+\n    4 rows in set (0.000 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:31:13') * 1000;\n    +----+----------+--------+\n    | id | name     | dizhi  |\n    +----+----------+--------+\n    |  1 | zhangsan | Beijing   |\n    |  2 | lisi     | Shanghai   |\n    |  3 | wangwu   | Tianjin   |\n    |  4 | zhaoliu  | Hebei   |\n    +----+----------+--------+\n    4 rows in set (0.000 sec)\n"})}),"\n",(0,a.jsx)(n.p,{children:"In the results of the preceding two flashback queries, data at different points in time is returned: the data before the deletion is returned for the first query, and the data before the update is returned for the second query."}),"\n",(0,a.jsx)(n.p,{children:"You can insert the restored data into the backup table for subsequent operations."}),"\n",(0,a.jsx)(n.h2,{id:"3-flash-back-to-the-state-before-a-ddl-operation",children:"3. Flash Back to the State Before a DDL Operation"}),"\n",(0,a.jsx)(n.h3,{id:"31-flash-back-the-table-to-the-state-before-an-add-column-operation",children:"3.1 Flash back the table to the state before an ADD COLUMN operation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> alter table banjin_flash add column dianhua decimal(11) default 1;\n    Query OK, 0 rows affected (0.038 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:44:43') * 1000;\n    +----+----------+--------+---------+\n    | id | name     | dizhi  | dianhua |\n    +----+----------+--------+---------+\n    |  1 | zhangsan | Beijing   |       1 |\n    |  2 | lisi     | Hunan   |       1 |\n    |  3 | wangwu   | Tianjin   |       1 |\n    |  4 | zhaoliu  | Hebei   |       1 |\n    +----+----------+--------+---------+\n    4 rows in set (0.002 sec)\n    \n    obclient [test]> alter table banjin_flash add column dianhua1 decimal(11) ;\n    Query OK, 0 rows affected (0.034 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:44:43') * 1000;\n    +----+----------+--------+---------+----------+\n    | id | name     | dizhi  | dianhua | dianhua1 |\n    +----+----------+--------+---------+----------+\n    |  1 | zhangsan | Beijing   |       1 |     NULL |\n    |  2 | lisi     | Hunan   |       1 |     NULL |\n    |  3 | wangwu   | Tianjin   |       1 |     NULL |\n    |  4 | zhaoliu  | Hebei   |       1 |     NULL |\n    +----+----------+--------+---------+----------+\n    4 rows in set (0.001 sec)\n"})}),"\n",(0,a.jsx)(n.p,{children:"In the preceding flashback query result, the default value is used in the added columns. If no default value is available, NULL is used."}),"\n",(0,a.jsx)(n.h3,{id:"32-restore-the-table-to-the-state-before-a-drop-column-operation",children:"3.2 Restore the table to the state before a DROP COLUMN operation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]>  alter table banjin_flash drop column dianhua1;\n    Query OK, 0 rows affected (0.251 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:44:43') * 1000;\n    ERROR 1412 (HY000): Unable to read data -- Table definition has changed\n"})}),"\n",(0,a.jsx)(n.p,{children:"The table cannot be restored after a column is dropped. The following error is returned in this case: ERROR 1412 (HY000): Unable to read data -- Table definition has changed."}),"\n",(0,a.jsx)(n.h3,{id:"33-flash-back-the-table-to-the-state-before-a-drop-table-operation",children:"3.3 Flash back the table to the state before a DROP TABLE operation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> drop table banjin_flash;\n    Query OK, 0 rows affected (0.022 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:51:30') * 1000;\n    ERROR 1146 (42S02): Table 'test.banjin_flash' doesn't exist\n"})}),"\n",(0,a.jsx)(n.p,{children:"If the table is dropped, it cannot be directly restored. An error is returned, indicating that the table does not exist."}),"\n",(0,a.jsx)(n.p,{children:"In this case, restore the table from the recycle bin and perform a flashback query again."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> select * from banjin_flash;\n    Empty set (0.001 sec)\n    \n    obclient [test]> show recyclebin;\n    +--------------------------------+---------------+-------+----------------------------+\n    | OBJECT_NAME                    | ORIGINAL_NAME | TYPE  | CREATETIME                 |\n    +--------------------------------+---------------+-------+----------------------------+\n    | __recycle_$_1_1729417897979024 | banjin_flash  | TABLE | 2024-10-20 17:51:37.978166 |\n    +--------------------------------+---------------+-------+----------------------------+\n    1 row in set (0.002 sec)\n    \n    obclient [test]> FLASHBACK TABLE __recycle_$_1_1729417897979024 TO BEFORE DROP;\n    Query OK, 0 rows affected (0.033 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:51:30') * 1000;\n    +----+----------+--------+\n    | id | name     | dizhi  |\n    +----+----------+--------+\n    |  1 | zhangsan | Beijing   |\n    |  2 | lisi     | Shanghai   |\n    |  3 | wangwu   | Tianjin   |\n    |  4 | zhaoliu  | Hebei   |\n    +----+----------+--------+\n    4 rows in set (0.008 sec)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"4-flash-back-to-the-state-before-a-truncate-operation",children:"4. Flash Back to the State Before a TRUNCATE Operation"}),"\n",(0,a.jsx)(n.p,{children:"TRUNCATE is a special DDL operation, for which the flashback feature needs to be described separately."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> insert into banjin_flash values (1,'zhangsan','Beijing');\n    Query OK, 1 row affected (0.007 sec)\n    \n    obclient [test]> insert into banjin_flash values (2,'lisi','Shanghai');\n    Query OK, 1 row affected (0.001 sec)\n    \n    obclient [test]> insert into banjin_flash values (3,'wangwu','Tianjin');\n    Query OK, 1 row affected (0.001 sec)\n    \n    obclient [test]> insert into banjin_flash values (4,'zhaoliu','Hebei');\n    Query OK, 1 row affected (0.001 sec)\n    \n    obclient [test]> \n    obclient [test]> select now();\n    +---------------------+\n    | now()               |\n    +---------------------+\n    | 2024-10-20 18:42:47 |\n    +---------------------+\n    1 row in set (0.000 sec)\n    \n    obclient [test]> update banjin_flash set dizhi = 'Hunan' where name='lisi';\n    Query OK, 1 row affected (0.002 sec)\n    Rows matched: 1  Changed: 1  Warnings: 0\n    \n    obclient [test]> select now();\n    +---------------------+\n    | now()               |\n    +---------------------+\n    | 2024-10-20 18:42:48 |\n    +---------------------+\n    1 row in set (0.000 sec)\n    \n    obclient [test]> truncate table banjin_flash;\n    Query OK, 0 rows affected (0.040 sec)\n    \n    obclient [test]> SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 18:42:47') * 1000;\n    ERROR 1412 (HY000): Unable to read data -- Table definition has changed\n"})}),"\n",(0,a.jsx)(n.p,{children:'"ERROR 1412 (HY000): Unable to read data -- Table definition has changed" is reported when you flash back the table to the state before it was truncated.'}),"\n",(0,a.jsx)(n.p,{children:"The definition and procedure of a TRUNCATE operation are as follows according to the OceanBase Database official website:"}),"\n",(0,a.jsxs)(n.p,{children:["To execute the ",(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"})," statement, you must have the ",(0,a.jsx)(n.code,{children:"DROP"})," privilege on the table. It is a DDL statement."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"})," and ",(0,a.jsx)(n.code,{children:"DELETE FROM"})," have the following differences:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"A TRUNCATE operation drops a table and creates it again."})," It is much faster than deleting data row by row, especially for large tables."]}),"\n",(0,a.jsxs)(n.li,{children:["The output of ",(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"})," always indicates that 0 rows were affected."]}),"\n",(0,a.jsxs)(n.li,{children:["When you use ",(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"}),", the table management program does not record the last ",(0,a.jsx)(n.code,{children:"AUTO_INCREMENT"})," value, but resets it to zero."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"})," statement cannot be executed during transactions or when the table is locked. Otherwise, an error is returned."]}),"\n",(0,a.jsxs)(n.li,{children:["If the table definition file is valid, you can use the ",(0,a.jsx)(n.code,{children:"TRUNCATE TABLE"})," statement to recreate the table as an empty table, even if the data or indexes are corrupted."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Although the table is dropped before recreation, the dropped table is not moved to the recycle bin. Proceed with caution."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    obclient [test]> TRUNCATE TABLE BANJIN_FLASH;\n    Query OK, 0 rows affected (0.042 sec)\n    \n    obclient [test]> show recyclebin;\n    Empty set (0.002 sec)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"5-command-summary",children:"5. Command Summary"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"    # Modify the value of undo_retention.\n    ALTER SYSTEM SET undo_retention=1800;\n    \n    # View the undo_retention parameter.\n    SHOW PARAMETERS LIKE 'undo_retention';\n    \n    # Enable the recycle bin.\n    bclient [test]> SET GLOBAL recyclebin = on;\n    \n    # View the recycle bin status.\n    SHOW VARIABLES LIKE 'recyclebin';\n    \n    # Perform a flashback query.\n    SELECT * FROM banjin_flash AS OF SNAPSHOT time_to_usec('2024-10-20 17:31:13') * 1000;\n    # Alternatively, use the following two statements together.\n    SELECT time_to_usec('2024-10-20 06:42:40') * 1000;\n    SELECT * FROM banjin_flash AS OF SNAPSHOT 1729377760000000000;\n    \n    # View the recycle bin.\n    show recyclebin;\n    \n    # Restore a dropped table from the recycle bin.\n    FLASHBACK TABLE __recycle_$_1_1729417897979024 TO BEFORE DROP;\n    \n    # Table and data\n    create table banjin_flash (id int ,name varchar(10),dizhi varchar(10),primary key (id));\n    insert into banjin_flash values (1,'zhangsan','Beijing');\n    insert into banjin_flash values (2,'lisi','Shanghai');\n    insert into banjin_flash values (3,'wangwu','Tianjin');\n    insert into banjin_flash values (4,'zhaoliu','Hebei');\n    \n    #Data operations\n    select now();\n    update banjin_flash set dizhi = 'Hunan' where name='lisi';\n    select now();\n    delete from banjin_flash;\n    select now();\n    \n    alter table banjin_flash add column dianhua decimal(11) default 1;\n    \n    alter table banjin_flash drop column dianhua;\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(96540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);