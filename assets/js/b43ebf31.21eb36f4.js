"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[4569],{506:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var t=s(74848),o=s(28453);const i={title:"Slow Response",weight:2},a=void 0,r={id:"user_manual/operation_and_maintenance/en-US/emergency_handbook/slow_response",title:"Slow Response",description:"Business and Database Symptoms",source:"@site/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/02_slow_response.md",sourceDirName:"user_manual/operation_and_maintenance/en-US/emergency_handbook",slug:"/user_manual/operation_and_maintenance/en-US/emergency_handbook/slow_response",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/slow_response",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/02_slow_response.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Slow Response",weight:2},sidebar:"operation_and_maintenanceEnglishSidebar",previous:{title:"Overview",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/emergency_overview"},next:{title:"High CPU Load",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/cpu_high"}},c={},l=[{value:"Business and Database Symptoms",id:"business-and-database-symptoms",level:2},{value:"Troubleshooting Approach and Procedure",id:"troubleshooting-approach-and-procedure",level:2},{value:"Troubleshoot hardware issues",id:"troubleshoot-hardware-issues",level:3},{value:"Troubleshoot slow queries",id:"troubleshoot-slow-queries",level:3},{value:"Troubleshoot tenant request queue backlogs",id:"troubleshoot-tenant-request-queue-backlogs",level:3},{value:"Troubleshooting methods",id:"troubleshooting-methods",level:4},{value:"Solutions",id:"solutions",level:4},{value:"Troubleshoot plan issues",id:"troubleshoot-plan-issues",level:3}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"business-and-database-symptoms",children:"Business and Database Symptoms"}),"\n",(0,t.jsx)(n.p,{children:"Business symptom: Business responses slow down or even time out."}),"\n",(0,t.jsx)(n.p,{children:"Database symptom: SQL execution time increases, and the response time (RT) for SQL requests becomes longer."}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting-approach-and-procedure",children:"Troubleshooting Approach and Procedure"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:s(74084).A+"",width:"2258",height:"1308"})}),"\n",(0,t.jsx)(n.h3,{id:"troubleshoot-hardware-issues",children:"Troubleshoot hardware issues"}),"\n",(0,t.jsx)(n.p,{children:"Check whether slow SQL responses are caused by hardware issues such as issues related to networks and disk I/O."}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"troubleshoot-slow-queries",children:"Troubleshoot slow queries"}),"\n",(0,t.jsxs)(n.p,{children:["Check whether suspicious SQL queries exist in OceanBase Cloud Platform (OCP).\n",(0,t.jsx)(n.img,{alt:"image",src:s(10943).A+"",width:"3298",height:"638"})]}),"\n",(0,t.jsx)(n.p,{children:"If the system responds to short requests with high latency because most resources are occupied by slow queries, you can troubleshoot as follows:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Enable throttling for slow queries that occupy excessive resources in OCP."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Set the ",(0,t.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715377",children:"large_query_worker_percentage"})," parameter to specify the percentage of worker threads reserved for slow queries. The default value of the parameter is 30%."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Set the ",(0,t.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715457",children:"large_query_threshold"})," parameter to specify the threshold for determining a slow query. The default value of the parameter is 5 seconds. Modifying this parameter will significantly affect the system. We recommend that you do not modify the parameter unless you understand it."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Add hosts in OCP and scale up the OceanBase Database tenant after more nodes are added to zones. For more information, see ",(0,t.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001703629",children:"Scale out an OceanBase cluster and scale up an OceanBase Database tenant"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"troubleshoot-tenant-request-queue-backlogs",children:"Troubleshoot tenant request queue backlogs"}),"\n",(0,t.jsx)(n.h4,{id:"troubleshooting-methods",children:"Troubleshooting methods"}),"\n",(0,t.jsx)(n.p,{children:"In addition to slow queries that occupy excessive resources, you need to troubleshoot tenant request queue backlogs by using the following methods:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check if the average queuing time of a slow query as a percentage of the response time is as expected. If the average queuing time is too long, the tenant request queue may be backlogged.\n",(0,t.jsx)(n.img,{alt:"image",src:s(97654).A+"",width:"3728",height:"1976"}),"\n",(0,t.jsx)(n.img,{alt:"image",src:s(37737).A+"",width:"3786",height:"1970"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Query the information about a slow query in the ",(0,t.jsx)(n.code,{children:"GV$OB_SQL_AUDIT"})," view. For more information, see ",(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/analyze_sql_monitoring_view",children:"Perform analysis based on SQL monitoring views"}),". The following figure shows the intervals between important events.\n",(0,t.jsx)(n.img,{alt:"image",src:s(59616).A+"",width:"2077",height:"883"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"-- In this example, an SQL request that is executed by the tenant with ID 1002 after 2024-11-20 12:00:00,\n-- with an execution time exceeding 100 ms, is queried.\n\nselect\n    tenant_id,\n    request_id,\n    usec_to_time(request_time),\n    elapsed_time,\n    queue_time,\n    execute_time,\n    query_sql\nfrom\n    oceanbase.GV$OB_SQL_AUDIT\nwhere\n    tenant_id = 1002\n    and elapsed_time > 100000\n    and request_time > time_to_usec('2024-11-20 12:00:00')\n    order by\n    elapsed_time desc\nlimit 1 \\G\n\n*************************** 1. row ***************************\n                tenant_id: 1002\n                request_id: 13329994\nusec_to_time(request_time): 2024-11-20 15:14:58.765564\n            elapsed_time: 153118\n                queue_time: 34\n            execute_time: 139873\n                query_sql: select * from xxxx where xxxx;\n1 row in set (0.11 sec)\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:'To observe the request queue backlogs of a specific tenant, you can search the logs by using the "dump tenant info" keyword, which is the most common method'})}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"grep 'dump tenant info' observer.log*\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:s(37947).A+"",width:"1433",height:"146"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You can refer to the following keywords in the logs:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:"req_queue"})}),": the regular request queue."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"total_size=n: n indicates the total number of requests in the queue."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"queue[x]=y: y indicates the number of requests at a specific priority in the queue. A smaller value of x indicates a higher priority."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:"multi_level_queue"})}),": the nested request queue."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"total_size=n: n indicates the total number of requests in the queue."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"queue[x]=y: y indicates the number of requests at a specific nesting level in the queue. x indicates the nesting level."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"queue[0]: non-nested requests. This parameter is left empty in most cases because non-nested requests are queued in the regular request queue."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"queue[1]: requests at nesting level 1, such as a remote procedure call (RPC) request triggered by an SQL query."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"queue[2]: requests at nesting level 2, such as an RPC request triggered by another RPC request that was initiated by an SQL query."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u2026"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:"group_id = x, queue_size = y"})}),": y indicates the number of requests in a grouped request queue."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["A group is used to process RPC requests of a specific type. Each group ID corresponds to a request type. For more information, see ",(0,t.jsx)(n.a,{href:"https://github.com/oceanbase/oceanbase/blob/develop/src/share/resource_manager/ob_group_list.h",children:"ob_group_list.h"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This method allows you to view historical information about both tenant request queues and threads. However, the logs are printed periodically, which means the information is less timely."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Log in to the sys tenant and execute the following SQL statement to observe request queue backlogs of a tenant:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"obclient [oceanbase]> select * from oceanbase.__all_virtual_dump_tenant_info where tenant_id = 1002\\G\n*************************** 1. row ***************************\n            svr_ip: 11.158.31.20\n            svr_port: 22602\n        tenant_id: 1002\n        compat_mode: 0\n        unit_min_cpu: 2\n        unit_max_cpu: 2\n            slice: 0\n        remain_slice: 0\n        token_cnt: 10\n    ass_token_cnt: 10\n        lq_tokens: 0\n    used_lq_tokens: 0\n            stopped: 0\n            idle_us: 0\n    recv_hp_rpc_cnt: 99\n    recv_np_rpc_cnt: 2226\n    recv_lp_rpc_cnt: 0\n    recv_mysql_cnt: 5459\n    recv_task_cnt: 5\nrecv_large_req_cnt: 0\nrecv_large_queries: 3661\n            actives: 10\n            workers: 10\nlq_waiting_workers: 0\nreq_queue_total_size: 0\n            queue_0: 0\n            queue_1: 0\n            queue_2: 0\n            queue_3: 0\n            queue_4: 0\n            queue_5: 0\n        large_queued: 0\n1 row in set (0.001 sec)\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You can view the real-time queue information in the virtual table. However, the virtual table does not record the historical queue information."}),"\n",(0,t.jsx)(n.h4,{id:"solutions",children:"Solutions"}),"\n",(0,t.jsx)(n.p,{children:"The thread model of OceanBase Database is a typical producer-consumer model. If the request production speed is faster than the request consumption speed for a long period of time, requests are accumulated in queues and the maximum queue size is reached. In this case, error code -4019 is returned."}),"\n",(0,t.jsxs)(n.p,{children:['Even if the maximum queue size is not reached, requests may still wait in the queue for a long period of time in scenarios such as when a large number of auto-increment columns exist. For more information about auto-increment columns, see the "Sequences" section in ',(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_06_using_ob_for_business_development/extended_functionality",children:"Extended features of a MySQL tenant of OceanBase Database"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"To solve this issue, perform the following operations:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:"If the maximum request queue size is reached, you can recover the service only through restart. Rejecting new requests will not help."})})," We recommend that you submit your question in the ",(0,t.jsx)(n.a,{href:"https://ask.oceanbase.com/",children:"OceanBase community forum"})," and contact engineers on duty to obtain technical support. The engineers will help you obtain stack traces by using obstack or pstack to identify the cause."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)("font",{color:"red",children:"In most cases, the maximum request queue size will not be reached. Request queue backlogs are the more common issue. "})})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"If the request queue is backlogged, check whether auto-increment columns with the ORDER property exist."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"If the issue is not caused by bulk data writes to auto-increment columns, contact engineers on duty in the OceanBase community forum to obtain technical support. The engineers will help you analyze stack traces by using obstack or pstack."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:'If the request queue backlog is not caused by deadlocks, you can upgrade tenant specifications to address the issue in special scenarios. The "special scenarios" here refer to situations involving high overhead from threads waiting for locks due to bulk data writes or those involving operations that are extremely CPU-intensive. You can use the top or tsar tool to identify such operations.'}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"troubleshoot-plan-issues",children:"Troubleshoot plan issues"}),"\n",(0,t.jsx)(n.p,{children:"If slow responses are not caused by resource issues, they may be due to plans."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:s(23122).A+"",width:"2234",height:"1296"})}),"\n",(0,t.jsx)(n.p,{children:'If SQL execution is "slowing down", you can troubleshoot the following common issues:'}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Bad case of the plan cache (cardinality). For more information about the issue description, troubleshooting method, and solution, see ",(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/sql_tuning",children:"Bad case of the plan cache"}),". This issue may occur in the following scenarios:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If SQL statements are identical except for the constants they contain, the database reuses the same plan from the plan cache for them. This scenario has been introduced in the getting-started tutorial.","\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"To avoid this scenario, later versions of OceanBase Database will cache different plans for SQL statements with the same structure but different constants in certain scenarios."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Statistics on the table accessed by an SQL query have significantly changed, but the database still uses the previously cached plan from the plan cache.","\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"This scenario will also be eliminated in later versions."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Buffer tables. For more information, see ",(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/troubleshooting_sql_performance_issues",children:"Buffer table issues"}),". No details will be provided here."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["The getting-started tutorial provides an approach to solving this issue, which is to improve the major compaction frequency of specific tables. In addition to the manual compaction feature, OceanBase Database V4.2.0 and later support the adaptive major compaction feature. You can set the ",(0,t.jsx)(n.code,{children:"table_mode"})," parameter to ",(0,t.jsx)(n.code,{children:"queue"})," to resolve the issue. For more information, see ",(0,t.jsx)(n.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001719947",children:"Adaptive major compactions"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Change of optimal plans to non-optimal plans after version upgrade."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"In most cases, plans become more optimal after version upgrade. This issue occurs rarely, and is not described in the getting-started tutorial. You can view the historical trends and plan changes of an SQL statement in OCP to check for the issue."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:['For more information about the solution, see the "Use hints to generate a plan" and "Use an outline to bind a plan" sections in ',(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/management_execution_plan#syntax-of-the-explain-statement",children:"Read and manage SQL execution plans in OceanBase Database"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:['Hard parsing. You can view the historical trends in the generation time of an SQL execution plan in OCP to check for the issue. For more information about the solution, see the "Hard parsing" section in ',(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/quick_starts/en-US/chapter_07_diagnosis_and_tuning/troubleshooting_sql_performance_issues#tools-for-analyzing-sql-performance-issues",children:"Typical scenarios and troubleshooting logic for SQL performance issues"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:['If SQL execution does not change from fast to slow but "remains consistently slow", refer to ',(0,t.jsx)(n.a,{href:"https://oceanbase.github.io/docs/user_manual/operation_and_maintenance/scenario_best_practices/chapter_03_htap/performance_tuning",children:"SQL performance diagnostics and tuning"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},74084:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/001-7800e63c28b00587f831a6f4fa15d446.png"},10943:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/002-75b69679f773a502b6e9bd7fad1db3a4.png"},97654:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/003-2298e8fe7454412bfbd05717ee6a272e.png"},37737:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/004-4364b79bd208422bd9c3f7e3979d8689.png"},59616:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/005-3640d352a835c4e96b6685513f383e96.png"},37947:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/006-38d77556744d8c2e967938f546f8a70e.png"},23122:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/007-fb081ef7749bfcaffd2b0ce80541dc61.png"},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>r});var t=s(96540);const o={},i=t.createContext(o);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);