"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[9478],{62447:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>r,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>o,toc:()=>l});var n=t(74848),s=t(28453);const c={slug:"truncated-table",title:"Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?"},i="Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?",o={id:"blogs/tech/truncated-table",title:"Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?",description:'I have been questioned a lot lately that "OceanBase Database V3.x supports the recycle of truncated tables. Why is this feature removed in OceanBase Database V4.x?"',source:"@site/docs/blogs/tech/truncated-table.md",sourceDirName:"blogs/tech",slug:"/blogs/tech/truncated-table",permalink:"/docs/blogs/tech/truncated-table",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/blogs/tech/truncated-table.md",tags:[],version:"current",frontMatter:{slug:"truncated-table",title:"Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?"},sidebar:"blogsSidebar",previous:{title:"Principles and Practices of Transaction Recovery in Distributed Databases",permalink:"/docs/blogs/tech/trans-recovery"},next:{title:"Vector capabilities of OceanBase Database: find similar images in a blink",permalink:"/docs/blogs/tech/vector-search"}},r={},l=[{value:"Implementation of the Recycle Bin",id:"implementation-of-the-recycle-bin",level:2},{value:"Implementation of TRUNCATE TABLE",id:"implementation-of-truncate-table",level:2},{value:"TRUNCATE TABLE in OceanBase Database V3.x",id:"truncate-table-in-oceanbase-database-v3x",level:3},{value:"TRUNCATE TABLE in OceanBase Database V4.x",id:"truncate-table-in-oceanbase-database-v4x",level:3},{value:"Why the Change in OceanBase Database V4.x?",id:"why-the-change-in-oceanbase-database-v4x",level:3},{value:"Flash Back a Table by Using original_name",id:"flash-back-a-table-by-using-original_name",level:2},{value:"Purge a Table by Using original_name",id:"purge-a-table-by-using-original_name",level:2}];function d(e){const a={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.header,{children:(0,n.jsx)(a.h1,{id:"why-truncated-tables-cannot-be-recycled-in-oceanbase-database-v4x",children:"Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?"})}),"\n",(0,n.jsxs)(a.blockquote,{children:["\n",(0,n.jsxs)(a.p,{children:['I have been questioned a lot lately that "OceanBase Database V3.x supports the recycle of truncated tables. Why is this feature removed in OceanBase Database V4.x?"',(0,n.jsx)(a.br,{}),"\n","In this article, I will explain why truncated tables are not moved to the recycle bin in OceanBase Database V4.x."]}),"\n"]}),"\n",(0,n.jsx)(a.h1,{id:"background",children:"Background"}),"\n",(0,n.jsxs)(a.p,{children:["MySQL does not provide a recycle bin, which, however, is necessary for a database administrator (DBA) to quickly and losslessly restore accidentally deleted data. In response to the strong request of Ant Group DBAs, OceanBase Database has supported the recycle bin feature in MySQL mode, which is similar to that in Oracle 10g. For more information, see ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001029493",children:"Overview"}),"."]}),"\n",(0,n.jsxs)(a.p,{children:["In OceanBase Database V3.x, if the session-level system variable ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001030833",children:"ob_enable_truncate_flashback"})," is set to ",(0,n.jsx)(a.code,{children:"on"}),", you can perform a ",(0,n.jsx)(a.code,{children:"FLASHBACK"})," operation to restore the data truncated from a table."]}),"\n",(0,n.jsxs)(a.p,{children:["For example, you can execute the following SQL sequence to restore the data truncated from table ",(0,n.jsx)(a.code,{children:"t1"})," to a table named ",(0,n.jsx)(a.code,{children:"truncated_t1"}),":\n",(0,n.jsx)(a.img,{alt:"1",src:t(92707).A+"",width:"1746",height:"714"})]}),"\n",(0,n.jsxs)(a.p,{children:["In OceanBase Database V4.x, a truncated table is not moved to the recycle bin, as shown in the following example:\n",(0,n.jsx)(a.img,{alt:"2",src:t(55848).A+"",width:"1346",height:"450"})]}),"\n",(0,n.jsx)(a.h1,{id:"cause-analysis",children:"Cause Analysis"}),"\n",(0,n.jsxs)(a.p,{children:["Let's start with the implementation of the recycle bin in OceanBase Database and the implementation of the ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," statement in OceanBase Database V3.x and V4.x."]}),"\n",(0,n.jsx)(a.h2,{id:"implementation-of-the-recycle-bin",children:"Implementation of the Recycle Bin"}),"\n",(0,n.jsx)(a.p,{children:"The recycle bin is implemented by logically deleting data, where deleted objects are labeled with an internal identifier, making them invisible to users. Objects in the recycle bin have only their metadata changed. Their underlying data remains unchanged."}),"\n",(0,n.jsxs)(a.p,{children:["You can execute the ",(0,n.jsx)(a.code,{children:"SHOW RECYCLEBIN"})," statement to view the information about all objects in the recycle bin. The object information is stored in an internal table named ",(0,n.jsx)(a.code,{children:"__all_recyclebin"}),". When you move an object to the recycle bin, a record is inserted into the ",(0,n.jsx)(a.code,{children:"__all_recyclebin"})," table. When you perform a ",(0,n.jsx)(a.code,{children:"FLASHBACK"})," or ",(0,n.jsx)(a.code,{children:"PURGE"})," operation, that record is deleted from the ",(0,n.jsx)(a.code,{children:"__all_recyclebin"})," table.\n",(0,n.jsx)(a.img,{alt:"3",src:t(66065).A+"",width:"2150",height:"1470"})]}),"\n",(0,n.jsxs)(a.p,{children:["To retain dropped tables in the recycle bin, OceanBase Database adds a default ",(0,n.jsx)(a.code,{children:"__recyclebin"})," database whose ",(0,n.jsx)(a.code,{children:"database_id"})," is ",(0,n.jsx)(a.code,{children:"201004"})," for each tenant.\n",(0,n.jsx)(a.img,{alt:"4",src:t(82974).A+"",width:"798",height:"434"})]}),"\n",(0,n.jsxs)(a.p,{children:["Dropping a table into the recycle bin is moving the table from its original database to the ",(0,n.jsx)(a.code,{children:"__recyclebin"})," database, during which the ",(0,n.jsx)(a.code,{children:"database_id"})," and ",(0,n.jsx)(a.code,{children:"table_name"})," of the table are changed. The indexes on the dropped table are also moved to the recycle bin.\n",(0,n.jsx)(a.img,{alt:"5",src:t(35463).A+"",width:"2334",height:"856"})]}),"\n",(0,n.jsx)(a.p,{children:"Therefore, the procedure of dropping a table into the recycle bin is as follows:"}),"\n",(0,n.jsxs)(a.ol,{children:["\n",(0,n.jsxs)(a.li,{children:["The ",(0,n.jsx)(a.code,{children:"database_id"})," and ",(0,n.jsx)(a.code,{children:"table_name"})," values of the table are modified. The new database name is ",(0,n.jsx)(a.code,{children:"__recyclebin"}),", and the new table name starts with ",(0,n.jsx)(a.code,{children:"__recycle"}),"."]}),"\n",(0,n.jsxs)(a.li,{children:["The table is moved to the recycle bin and a corresponding record is inserted into the ",(0,n.jsx)(a.code,{children:"__all_recyclebin"})," table."]}),"\n",(0,n.jsx)(a.li,{children:"The preceding steps are performed for the index tables of the dropped table."}),"\n"]}),"\n",(0,n.jsxs)(a.p,{children:["The ",(0,n.jsx)(a.code,{children:"FLASHBACK"})," operation restores a dropped table from the recycle bin. For more information, see ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001029495",children:"Restore objects from the recycle bin"}),"."]}),"\n",(0,n.jsxs)(a.p,{children:["The ",(0,n.jsx)(a.code,{children:"PURGE"})," operation purges the recycle bin. It first deletes the information about an object from ",(0,n.jsx)(a.code,{children:"__recyclebin"})," and then deletes the object from ",(0,n.jsx)(a.code,{children:"__all_table"})," and ",(0,n.jsx)(a.code,{children:"__all_table_history"}),". For more information, see ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001029492",children:"Purge the recycle bin"}),"."]}),"\n",(0,n.jsx)(a.p,{children:"Other objects such as tenants and databases are dropped into the recycle bin in a similar way."}),"\n",(0,n.jsx)(a.h2,{id:"implementation-of-truncate-table",children:"Implementation of TRUNCATE TABLE"}),"\n",(0,n.jsx)(a.h3,{id:"truncate-table-in-oceanbase-database-v3x",children:"TRUNCATE TABLE in OceanBase Database V3.x"}),"\n",(0,n.jsxs)(a.p,{children:["In OceanBase Database V3.x, a ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," statement is essentially the combination of a ",(0,n.jsx)(a.code,{children:"DROP TABLE"})," statement and a ",(0,n.jsx)(a.code,{children:"CREATE TABLE"})," statement. For example, if you execute ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE t1"}),", ",(0,n.jsx)(a.code,{children:"DROP TABLE t1"})," and ",(0,n.jsx)(a.code,{children:"CREATE TABLE t1"})," are executed within the same transaction."]}),"\n",(0,n.jsxs)(a.p,{children:["In other words, a truncated table and its data in OceanBase Database V3.x are moved into the recycle bin when the ",(0,n.jsx)(a.code,{children:"DROP TABLE"})," statement is executed. This is why you can perform a ",(0,n.jsx)(a.code,{children:"FLASHBACK"})," operation in OceanBase Database V3.x to restore an accidentally truncated table and its data."]}),"\n",(0,n.jsx)(a.h3,{id:"truncate-table-in-oceanbase-database-v4x",children:"TRUNCATE TABLE in OceanBase Database V4.x"}),"\n",(0,n.jsxs)(a.p,{children:["OceanBase Database V4.x has introduced the concept of tablets. Tablets, imperceptible to users, are migratable data blocks at the physical storage layer. For more information, see ",(0,n.jsx)(a.a,{href:"https://open.oceanbase.com/blog/1249578496",children:"What Are Tablets in OceanBase Database V4.0?"})," The ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," statement in OceanBase Database V4.x is implemented by modifying the corresponding tablets of partitions, instead of executing a ",(0,n.jsx)(a.code,{children:"DROP TABLE"})," statement and a ",(0,n.jsx)(a.code,{children:"CREATE TABLE"})," statement as in OceanBase Database V3.x. To be specific, truncating a table in OceanBase Database V4.x deletes old tablets and creates new tablets. This boosts performance in scenarios where a table has many associated objects such as columns, constraints, foreign keys, partitions, and indexes."]}),"\n",(0,n.jsxs)(a.p,{children:["As ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," in OceanBase Database V4.x does not involve ",(0,n.jsx)(a.code,{children:"DROP TABLE"}),", a truncated table is not moved to the recycle bin. When you truncate a table in OceanBase Database V4.x, the metadata of the table remains unchanged, and only the corresponding tablets are modified."]}),"\n",(0,n.jsx)(a.h3,{id:"why-the-change-in-oceanbase-database-v4x",children:"Why the Change in OceanBase Database V4.x?"}),"\n",(0,n.jsxs)(a.p,{children:["Users frequently truncating tables in OceanBase Database V3.x have found that the performance of the ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," statement in OceanBase Database was lower than that in Oracle. The performance overhead comes from two aspects: updating system tables and creating partitions. In OceanBase Database V3.x, partition creation requires creating Paxos groups and thereby involves many steps. In OceanBase Database V4.x, which adopts a single-log stream architecture, partition creation involves only operations on the data within the log stream, leading to a significant improvement in performance. To eliminate the performance overhead caused by updating system tables, the ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," statement must be implemented differently."]}),"\n",(0,n.jsxs)(a.p,{children:["A user of OceanBase Database V3.x maintains tens of thousands of tables, each with hundreds of columns and check constraints. For each table, hundreds of records are stored in the ",(0,n.jsx)(a.code,{children:"__all_column"})," and ",(0,n.jsx)(a.code,{children:"__all_constraint"})," system tables. Every time when they perform a ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," operation, the system deletes metadata during the ",(0,n.jsx)(a.code,{children:"DROP TABLE"})," operation and rewrites metadata during the ",(0,n.jsx)(a.code,{children:"CREATE TABLE"})," operation. If the table is associated with many objects, this process takes forever to complete."]}),"\n",(0,n.jsxs)(a.p,{children:["In OceanBase Database V4.x, ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," no longer modifies the metadata of a table, leaving system tables such as ",(0,n.jsx)(a.code,{children:"__all_column"})," and ",(0,n.jsx)(a.code,{children:"__all_constraint"})," unchanged during the truncation. Data is cleared by replacing tablets. The ",(0,n.jsx)(a.code,{children:"__all_table"})," table has a column named ",(0,n.jsx)(a.code,{children:"tablet_id"})," added to record the tablet of each table. When you truncate a table, OceanBase Database creates an empty tablet, uses the ",(0,n.jsx)(a.code,{children:"tablet_id"})," value of the new tablet to overwrite the old value in the ",(0,n.jsx)(a.code,{children:"__all_table"})," table, and then deletes the old tablet. For a partitioned table, a ",(0,n.jsx)(a.code,{children:"tablet_id"})," value is recorded in the ",(0,n.jsx)(a.code,{children:"__all_part"})," table for each partition. When you truncate a partitioned table, OceanBase Database replaces the corresponding tablet with a new, empty tablet for each partition."]}),"\n",(0,n.jsxs)(a.p,{children:["The implementation of ",(0,n.jsx)(a.code,{children:"TRUNCATE TABLE"})," in OceanBase Database V4.x is similar to that in Oracle. You can think of ",(0,n.jsx)(a.code,{children:"table_id"})," and ",(0,n.jsx)(a.code,{children:"tablet_id"})," in OceanBase Database V4.x as ",(0,n.jsx)(a.code,{children:"object_id"})," and ",(0,n.jsx)(a.code,{children:"data_object_id"})," in Oracle."]}),"\n",(0,n.jsx)(a.h1,{id:"other-noteworthy-points",children:"Other Noteworthy Points"}),"\n",(0,n.jsx)(a.p,{children:"Here are a few interesting but often overlooked aspects of the recycle bin feature."}),"\n",(0,n.jsx)(a.h2,{id:"flash-back-a-table-by-using-original_name",children:"Flash Back a Table by Using original_name"}),"\n",(0,n.jsxs)(a.p,{children:["As stated in ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001031748",children:"FLASHBACK"}),", a topic currently dated September 12, 2023, when restoring a table from the recycle bin by using the ",(0,n.jsx)(a.code,{children:"FLASHBACK"})," statement, you can only specify the corresponding object name (",(0,n.jsx)(a.code,{children:"object_name"}),") of the table in the recycle bin, not the original name (",(0,n.jsx)(a.code,{children:"original_name"}),") of the table before it was dropped."]}),"\n",(0,n.jsxs)(a.p,{children:["Actually, OceanBase Database also allows you to specify ",(0,n.jsx)(a.code,{children:"original_name"}),". If the recycle bin contains tables with the same original name, the ",(0,n.jsx)(a.code,{children:"FLASHBACK original_name"})," statement restores the table that was last moved to the recycle bin. This is consistent with the recycle bin feature of Oracle."]}),"\n",(0,n.jsxs)(a.p,{children:["Here is an example:\n",(0,n.jsx)(a.img,{alt:"6",src:t(32812).A+"",width:"2470",height:"1138"}),"\n",(0,n.jsx)(a.img,{alt:"7",src:t(68725).A+"",width:"2434",height:"1224"})]}),"\n",(0,n.jsx)(a.h2,{id:"purge-a-table-by-using-original_name",children:"Purge a Table by Using original_name"}),"\n",(0,n.jsxs)(a.p,{children:["As stated in ",(0,n.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001031730",children:"PURGE"}),", a topic currently dated September 12, 2023, when purging a table from the recycle bin by using the ",(0,n.jsx)(a.code,{children:"PURGE"})," statement, you can only specify the corresponding object name (",(0,n.jsx)(a.code,{children:"object_name"}),") of the table in the recycle bin, not the original name (",(0,n.jsx)(a.code,{children:"original_name"}),") of the table before it was dropped."]}),"\n",(0,n.jsxs)(a.p,{children:["Actually, OceanBase Database also allows you to specify ",(0,n.jsx)(a.code,{children:"original_name"}),". If the recycle bin contains tables with the same original name, the ",(0,n.jsx)(a.code,{children:"PURGE original_name"})," statement purges the table that was first moved to the recycle bin. This is consistent with the recycle bin feature of Oracle."]}),"\n",(0,n.jsxs)(a.p,{children:["Here is an example:\n",(0,n.jsx)(a.img,{alt:"8",src:t(97874).A+"",width:"2446",height:"1140"}),"\n",(0,n.jsx)(a.img,{alt:"9",src:t(12699).A+"",width:"2414",height:"1222"})]}),"\n",(0,n.jsx)(a.p,{children:"Let me put an end here. For any questions about the recycle bin feature of OceanBase Database, feel free to leave a comment."}),"\n",(0,n.jsx)(a.h1,{id:"references",children:"References"}),"\n",(0,n.jsx)(a.p,{children:"\xa0 \xa0If you are interested, read the following posts:"}),"\n",(0,n.jsxs)(a.p,{children:["\xa0 \xa0",(0,n.jsx)(a.a,{href:"https://oceanbase.github.io/docs/blogs/tech/ob-schema",children:"What Is a Schema in OceanBase Database?"})]}),"\n",(0,n.jsxs)(a.p,{children:["\xa0 \xa0",(0,n.jsx)(a.a,{href:"https://oceanbase.github.io/docs/blogs/tech/adaptive-sql-execution-engine",children:"Adaptive Techniques in the OceanBase Database Execution Engine"})]}),"\n",(0,n.jsxs)(a.p,{children:["\xa0 \xa0",(0,n.jsx)(a.a,{href:"https://open.oceanbase.com/blog/5382203648",children:"Pushdown Techniques in OceanBase Database"})]})]})}function h(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},92707:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/1-8c07377795ad02c52be589807767cb32.png"},55848:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/2-c246df9002f5ec6312e8ceabe49bb387.png"},66065:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/3-1688af58d62dd16f446f44382117ef36.png"},82974:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/4-df05023bdc9903dcc111010053c6bc88.png"},35463:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/5-0ad8324831b585aa7379ae4c64a597f2.png"},32812:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/6-4ee7f93a4bbea589729bc18321a05de2.png"},68725:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/7-0d7140ea8972faa07982de31b281e3e7.png"},97874:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/8-5d4f18f60d5c5ace61e6ff24539ee20a.png"},12699:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/9-20b491736c2e908e86747d6f08d99725.png"},28453:(e,a,t)=>{t.d(a,{R:()=>i,x:()=>o});var n=t(96540);const s={},c=n.createContext(s);function i(e){const a=n.useContext(c);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function o(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),n.createElement(c.Provider,{value:a},e.children)}}}]);