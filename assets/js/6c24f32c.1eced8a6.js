"use strict";(self.webpackChunkmy_docs_website=self.webpackChunkmy_docs_website||[]).push([[496],{5302:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});var s=n(74848),t=n(28453);const o={title:"Full Log/Data Disk",weight:6},i=void 0,r={id:"user_manual/operation_and_maintenance/en-US/emergency_handbook/disk_capacity_problem",title:"Full Log/Data Disk",description:"Business and Database Symptoms",source:"@site/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/07_disk_capacity_problem.md",sourceDirName:"user_manual/operation_and_maintenance/en-US/emergency_handbook",slug:"/user_manual/operation_and_maintenance/en-US/emergency_handbook/disk_capacity_problem",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/disk_capacity_problem",draft:!1,unlisted:!1,editUrl:"https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/07_disk_capacity_problem.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{title:"Full Log/Data Disk",weight:6},sidebar:"operation_and_maintenanceEnglishSidebar",previous:{title:"Disk Issues",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/disk_problem"},next:{title:"Unexpected Errors",permalink:"/docs/user_manual/operation_and_maintenance/en-US/emergency_handbook/how_to_ask"}},d={},l=[{value:"Business and Database Symptoms",id:"business-and-database-symptoms",level:2},{value:"Full data disk",id:"full-data-disk",level:3},{value:"Full log disk",id:"full-log-disk",level:3},{value:"Troubleshooting Approach",id:"troubleshooting-approach",level:2},{value:"Full data disk",id:"full-data-disk-1",level:3},{value:"Full log disk",id:"full-log-disk-1",level:3},{value:"Troubleshooting Procedure",id:"troubleshooting-procedure",level:2},{value:"Full data disk",id:"full-data-disk-2",level:3},{value:"Check whether the operating system disk that stores data files has enough remaining capacity for allocation.",id:"check-whether-the-operating-system-disk-that-stores-data-files-has-enough-remaining-capacity-for-allocation",level:4},{value:"If the system disk has no remaining capacity for allocation, add nodes to the zone and migrate resource units to evenly distribute data across nodes.",id:"if-the-system-disk-has-no-remaining-capacity-for-allocation-add-nodes-to-the-zone-and-migrate-resource-units-to-evenly-distribute-data-across-nodes",level:4},{value:"Full log disk",id:"full-log-disk-2",level:3},{value:"References",id:"references",level:2}];function c(e){const a={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(a.h2,{id:"business-and-database-symptoms",children:"Business and Database Symptoms"}),"\n",(0,s.jsx)(a.h3,{id:"full-data-disk",children:"Full data disk"}),"\n",(0,s.jsxs)(a.p,{children:["OceanBase Cloud Platform (OCP) reports a data disk alert, such as the alert for ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001899685",children:"ob_host_data_path_disk_percent"}),"."]}),"\n",(0,s.jsx)(a.p,{children:"The business application reports an error. OBServer nodes may fail to perform minor compactions, major compactions, or memory release, resulting in a failure to write data to the cluster."}),"\n",(0,s.jsx)(a.h3,{id:"full-log-disk",children:"Full log disk"}),"\n",(0,s.jsxs)(a.p,{children:["OCP reports a log disk alert, such as ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001899703",children:"ob_host_log_disk_percent_over_threshold"}),"."]}),"\n",(0,s.jsx)(a.p,{children:"The business application reports an error. OBServer nodes may not function properly, affecting the election process."}),"\n",(0,s.jsxs)(a.blockquote,{children:["\n",(0,s.jsx)(a.p,{children:"The methods described in the preceding topics are applicable when other programs generate a large amount of data in the log disk or data disk of an OBServer node. Do not manually delete log files or data files on OBServer nodes. Otherwise, the system may fail to be restored."}),"\n"]}),"\n",(0,s.jsx)(a.h2,{id:"troubleshooting-approach",children:"Troubleshooting Approach"}),"\n",(0,s.jsx)(a.h3,{id:"full-data-disk-1",children:"Full data disk"}),"\n",(0,s.jsxs)(a.p,{children:["Connect to the ",(0,s.jsx)(a.code,{children:"oceanbase"})," database through the sys tenant and query information about the data disk usage of each node in the cluster, including the total allocated size, occupied size, and remaining size."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"SELECT b.zone, a.svr_ip, a.svr_port,\n        ROUND(a.total_size/1024/1024/1024,3) total_size_GB,\n        ROUND((a.total_size-a.free_size)/1024/1024/1024,3) used_size_GB,\n        ROUND(a.free_size/1024/1024/1024,3) free_size_GB,\n        ROUND((a.total_size-a.free_size)/total_size,2)*100 disk_used_percentage\nFROM oceanbase.__all_virtual_disk_stat a\nINNER JOIN oceanbase.__all_server b\n  ON a.svr_ip=b.svr_ip AND a.svr_port=b.svr_port\nORDER BY zone\n\n*************************** 1. row ***************************\n                zone: zone1\n              svr_ip: 1.2.3.4\n            svr_port: 22602\n       total_size_GB: 8.000\n        used_size_GB: 0.307\n        free_size_GB: 7.693\ndisk_used_percentage: 4.00\n"})}),"\n",(0,s.jsxs)(a.p,{children:["If the ",(0,s.jsx)(a.code,{children:"disk_used_percentage"})," value exceeds the default alert threshold, which is 97%, the alert reported by OCP is valid."]}),"\n",(0,s.jsx)(a.h3,{id:"full-log-disk-1",children:"Full log disk"}),"\n",(0,s.jsxs)(a.blockquote,{children:["\n",(0,s.jsx)(a.p,{children:"The issue of a full log disk rarely occurs because expired logs are recycled."}),"\n"]}),"\n",(0,s.jsx)(a.p,{children:"Check whether the alert reported by OCP is valid on the affected node. The cluster and host information for the node can be found in the alert."}),"\n",(0,s.jsxs)(a.p,{children:["Log in to the sys tenant and connect to the ",(0,s.jsx)(a.code,{children:"oceanbase"})," database. Run the following command to check whether the log disk usage in a tenant exceeds the threshold."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"select a.svr_ip,a.svr_port,a.tenant_id,b.tenant_name,\n    CAST(a.data_disk_in_use/1024/1024/1024 as DECIMAL(15,2)) data_disk_use_G, \n    CAST(a.log_disk_size/1024/1024/1024 as DECIMAL(15,2)) log_disk_size, \n    CAST(a.log_disk_in_use/1024/1024/1024 as DECIMAL(15,2)) log_disk_use_G,\n    log_disk_in_use/log_disk_size 'usage%'\nfrom oceanbase.__all_virtual_unit a,dba_ob_tenants b \nwhere a.tenant_id=b.tenant_id\\G\n\n*************************** 1. row ***************************\n         svr_ip: 1.2.3.4\n       svr_port: 22602\n      tenant_id: 1\n    tenant_name: sys\ndata_disk_use_G: 0.10\n  log_disk_size: 2.00\n log_disk_use_G: 1.54\n         usage%: 0.7693\n*************************** 2. row ***************************\n         svr_ip: 1.2.3.4\n       svr_port: 22602\n      tenant_id: 1001\n    tenant_name: META$1002\ndata_disk_use_G: 0.07\n  log_disk_size: 0.60\n log_disk_use_G: 0.43\n         usage%: 0.7174\n*************************** 3. row ***************************\n         svr_ip: 1.2.3.4\n       svr_port: 22602\n      tenant_id: 1002\n    tenant_name: mysql\ndata_disk_use_G: 0.05\n  log_disk_size: 5.40\n log_disk_use_G: 3.13\n         usage%: 0.5789\n"})}),"\n",(0,s.jsx)(a.h2,{id:"troubleshooting-procedure",children:"Troubleshooting Procedure"}),"\n",(0,s.jsx)(a.h3,{id:"full-data-disk-2",children:"Full data disk"}),"\n",(0,s.jsx)(a.h4,{id:"check-whether-the-operating-system-disk-that-stores-data-files-has-enough-remaining-capacity-for-allocation",children:"Check whether the operating system disk that stores data files has enough remaining capacity for allocation."}),"\n",(0,s.jsxs)(a.p,{children:["If so, modify the cluster-level parameter ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715485",children:"datafile_size"})," or ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715434",children:"datafile_disk_percentage"})," to increase the available capacity of the data disk for the database."]}),"\n",(0,s.jsxs)(a.p,{children:["Run the following commands to check the values of the ",(0,s.jsx)(a.code,{children:"datafile_size"})," and ",(0,s.jsx)(a.code,{children:"datafile_disk_percentage"})," parameters:"]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"show parameters like 'datafile_size'\\G\n*************************** 1. row ***************************\n         zone: zone1\n     svr_type: observer\n       svr_ip: 1.2.3.4\n     svr_port: 22602\n         name: datafile_size\n    data_type: CAPACITY\n        value: 2G\n         info: size of the data file. Range: [0, +\u221e)\n      section: SSTABLE\n        scope: CLUSTER\n       source: DEFAULT\n   edit_level: DYNAMIC_EFFECTIVE\ndefault_value: 0M\n    isdefault: 0\n1 row in set (0.006 sec)\n"})}),"\n",(0,s.jsxs)(a.p,{children:["The default value of the ",(0,s.jsx)(a.code,{children:"datafile_size"})," parameter is ",(0,s.jsx)(a.code,{children:"0M"}),". If the default value is used, the available capacity of the data disk is controlled by the ",(0,s.jsx)(a.code,{children:"datafile_disk_percentage"})," parameter."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"show parameters like 'datafile_disk_percentage'\\G\n*************************** 1. row ***************************\n         zone: zone1\n     svr_type: observer\n       svr_ip: 11.158.31.20\n     svr_port: 22602\n         name: datafile_disk_percentage\n    data_type: INT\n        value: 0\n         info: the percentage of disk space used by the data files. Range: [0,99] in integer\n      section: SSTABLE\n        scope: CLUSTER\n       source: DEFAULT\n   edit_level: DYNAMIC_EFFECTIVE\ndefault_value: 0\n    isdefault: 1\n1 row in set (0.006 sec)\n"})}),"\n",(0,s.jsxs)(a.p,{children:["The default value of the ",(0,s.jsx)(a.code,{children:"datafile_disk_percentage"})," parameter is ",(0,s.jsx)(a.code,{children:"0"}),". If the default value is used, the system automatically calculates the percentage of the total disk space occupied by the data file in Shared-Nothing (SN) mode or local cache in Shared-Storage (SS) mode based on whether the logs and data share the same disk."]}),"\n",(0,s.jsxs)(a.ul,{children:["\n",(0,s.jsx)(a.li,{children:"If the same disk is shared, the percentage of the total disk space occupied by data files or local cache is 60%."}),"\n",(0,s.jsxs)(a.li,{children:["If the disk is not shared, the percentage of the total disk space occupied by data files or local cache is 90%.\nIf this parameter and the ",(0,s.jsx)(a.code,{children:"datafile_size"})," parameter are both specified, the value of the ",(0,s.jsx)(a.code,{children:"datafile_size"})," parameter prevails."]}),"\n"]}),"\n",(0,s.jsx)(a.p,{children:"Run the following commands to set the parameters to greater values:"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"-- Set the size of the data file to 80 GB.\nobclient> ALTER SYSTEM SET datafile_size = '80G';\n\n-- Alternatively, set the percentage of the total disk space occupied by the data file to 95%.\nobclient> ALTER SYSTEM SET datafile_disk_percentage = 90;\n"})}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.strong,{children:(0,s.jsxs)("font",{color:"red",children:["OceanBase Database supports auto scale-out of disk space available for data files based on the actual situation. We recommend that you set the ",(0,s.jsx)(a.code,{children:"datafile_next"})," and ",(0,s.jsx)(a.code,{children:"datafile_maxsize"})," parameters for auto scale-out when you deploy a cluster. For more information, see ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001714935",children:"Configure automatic scale-out of disk space for data files"}),". "]})})}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.strong,{children:(0,s.jsx)("font",{color:"red",children:"In a production environment, we recommend that the size of the log disk be at least three times the memory size of the host. To avoid I/O performance issues, we recommend that you mount the data directory and the log directory to different disks. "})})}),"\n",(0,s.jsx)(a.h4,{id:"if-the-system-disk-has-no-remaining-capacity-for-allocation-add-nodes-to-the-zone-and-migrate-resource-units-to-evenly-distribute-data-across-nodes",children:"If the system disk has no remaining capacity for allocation, add nodes to the zone and migrate resource units to evenly distribute data across nodes."}),"\n",(0,s.jsxs)(a.p,{children:["You can perform GUI-based operations in OCP to add nodes to the zone and migrate resource units. For more information, see ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-ocp-10000000001899145",children:"Migrate a resource unit from an OceanBase Database tenant"}),"."]}),"\n",(0,s.jsx)(a.p,{children:"If an OBServer node hosts resource units of multiple tenants, migrate the resource units to evenly distribute data across nodes."}),"\n",(0,s.jsx)(a.p,{children:"If an OBServer node hosts only one user tenant, purge the recycle bin to delete redundant data."}),"\n",(0,s.jsx)(a.h3,{id:"full-log-disk-2",children:"Full log disk"}),"\n",(0,s.jsxs)(a.p,{children:["Check whether the log disk of the cluster has remaining capacity for allocation. If the value of the ",(0,s.jsx)(a.code,{children:"log_disk_free"})," parameter is 0, the log disk has no remaining capacity for allocation."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"select zone,concat(SVR_IP,':',SVR_PORT) observer,\n    cpu_capacity_max cpu_total,cpu_assigned_max cpu_assigned,\n    cpu_capacity-cpu_assigned_max as cpu_free,\n    round(memory_limit/1024/1024/1024,2) as memory_total,\n    round((memory_limit-mem_capacity)/1024/1024/1024,2) as system_memory,\n    round(mem_assigned/1024/1024/1024,2) as mem_assigned,\n    round((mem_capacity-mem_assigned)/1024/1024/1024,2) as memory_free,\n    round(log_disk_capacity/1024/1024/1024,2) as log_disk_capacity,\n    round(log_disk_assigned/1024/1024/1024,2) as log_disk_assigned,\n    round((log_disk_capacity-log_disk_assigned)/1024/1024/1024,2) as log_disk_free,\n    round((data_disk_capacity/1024/1024/1024),2) as data_disk,\n    round((data_disk_in_use/1024/1024/1024),2) as data_disk_used,\n    round((data_disk_capacity-data_disk_in_use)/1024/1024/1024,2) as data_disk_free\nfrom gv$ob_servers\\G\n*************************** 1. row ***************************\n             zone: zone1\n         observer: 11.158.31.20:22602\n        cpu_total: 8\n     cpu_assigned: 4\n         cpu_free: 4\n     memory_total: 8.00\n    system_memory: 1.00\n     mem_assigned: 3.00\n      memory_free: 4.00\nlog_disk_capacity: 21.00\nlog_disk_assigned: 8.00\n    log_disk_free: 13.00\n        data_disk: 8.00\n   data_disk_used: 0.27\n   data_disk_free: 7.73\n1 row in set (0.006 sec)\n"})}),"\n",(0,s.jsxs)(a.p,{children:["If the value of the ",(0,s.jsx)(a.code,{children:"log_disk_free"})," parameter is not 0, the log disk has remaining capacity for allocation. In this case, you can set the log disk size to a greater value for the resource unit of the tenant."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"ALTER RESOURCE UNIT unit_name LOG_DISK_SIZE = '10G';\n"})}),"\n",(0,s.jsxs)(a.p,{children:["If the value of the ",(0,s.jsx)(a.code,{children:"log_disk_free"})," parameter is 0, the log disk space allocated to the cluster is used up. You can run the ",(0,s.jsx)(a.code,{children:"df -h"})," command to check whether all the capacity of the disk to which the log directory of the node is mounted is allocated to the log directory."]}),"\n",(0,s.jsxs)(a.p,{children:["If the disk has remaining capacity for allocation, you can modify the cluster-level parameter ",(0,s.jsx)(a.a,{href:"log_disk_https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715277",children:"log_disk_size"})," or ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715452",children:"log_disk_percentage"})," to increase the log disk size available for the cluster. Then, run the ",(0,s.jsx)(a.code,{children:"ALTER RESOURCE UNIT"})," command to increase the log disk size available for the tenant."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"ALTER system SET log_disk_size = '40G';\n\nALTER system SET log_disk_percentage = 90;\n"})}),"\n",(0,s.jsxs)(a.p,{children:["If the operating system disk has no remaining capacity for allocation, stop the write operations to the abnormal tenant. Otherwise, the space temporarily released from the clog disk can be quickly used up again. At the same time, modify the ",(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001715555",children:"log_disk_utilization_limit_threshold"})," parameter to increase the threshold of the clog disk usage from 95% to 98%."]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"ALTER system SET log_disk_utilization_limit_threshold = 98;\n"})}),"\n",(0,s.jsx)(a.p,{children:"Wait a period of time until clogs have been synchronized. The capacity is then automatically recycled by the database system and the cluster can be automatically restored."}),"\n",(0,s.jsx)(a.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(a.ul,{children:["\n",(0,s.jsxs)(a.li,{children:["\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://open.oceanbase.com/blog/13250502949",children:"Quick Fixes for OceanBase Issues"})}),"\n"]}),"\n",(0,s.jsxs)(a.li,{children:["\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://en.oceanbase.com/docs/common-oceanbase-database-10000000001714619",children:"Emergency response"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:a}={...(0,t.R)(),...e.components};return a?(0,s.jsx)(a,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>r});var s=n(96540);const t={},o=s.createContext(t);function i(e){const a=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:a},e.children)}}}]);