<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blogs/tech/query-perf" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Insights into OceanBase Database 4.0: Distributed Query Performance Optimization in OceanBase Database | OceanBase</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://oceanbase.github.io/docs/blogs/tech/query-perf"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Insights into OceanBase Database 4.0: Distributed Query Performance Optimization in OceanBase Database | OceanBase"><meta data-rh="true" name="description" content="Wang Guoping | Senior Technical Expert of OceanBase"><meta data-rh="true" property="og:description" content="Wang Guoping | Senior Technical Expert of OceanBase"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://oceanbase.github.io/docs/blogs/tech/query-perf"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/docs/blogs/tech/query-perf" hreflang="en"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/docs/blogs/tech/query-perf" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://6JQM9QDU5V-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H4XM2M50RX"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H4XM2M50RX",{})</script><link rel="stylesheet" href="/assets/css/styles.7e3a93fe.css">
<script src="/assets/js/runtime~main.a50e5b58.js" defer="defer"></script>
<script src="/assets/js/main.589ef4b9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OceanBase</b></a><a class="navbar__item navbar__link" href="/docs/blogs/arch/all-in-one">Blogs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Product Docs</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">User Manual</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Developer Manual</a></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Community</a><ul class="dropdown__menu"><span><li><a class="dropdown__link" href="/docs/sig/overview/list">Special Interest Group(SIG)</a></li></span><span><li><a class="dropdown__link" href="/docs/honor/overview">Community Honors</a></li></span><span><li><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub Discussion<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://discord.gg/74cF8vbNEs" target="_blank" rel="noopener noreferrer" class="dropdown__link">Discord<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Forum (in Chinese)<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stack Overflow<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Data + AI</a><ul class="dropdown__menu"><span><li><a href="https://oceanbase-devhub.github.io" target="_blank" rel="noopener noreferrer" class="dropdown__link">AI Workshops<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://oceanbase-devhub.github.io/ai-workshop-2024" target="_blank" rel="noopener noreferrer" class="dropdown__link">RAG Bot<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://oceanbase-devhub.github.io/dify/dify@oceanbase-workshop" target="_blank" rel="noopener noreferrer" class="dropdown__link">Dify (MySQL Compatible)<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://oceanbase-devhub.github.io/DB-GPT/docker/compose_examples/ob_dbgpt_tutorial" target="_blank" rel="noopener noreferrer" class="dropdown__link">DB-GPT<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><a href="https://en.oceanbase.com/softwarecenter" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Downloads<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oceanbase" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/arch/all-in-one">Architectural Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/feat/io-isolation">Features Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/blogs/tech/DDL-Execution-Efficient">Technical Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/DDL-Execution-Efficient">Insights into OceanBase Database 4.0: How to Make DDL Execution Efficient and Transparent in a Distributed Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/Materialized-Views">Explore Data Warehouses with Columnar Storage and Materialized Views of OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/Modern-HBase-Arch">Simplistic Yet Not Simple: The Upgrade to a Modern HBase Architecture with OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/Real-time-AP">OceanBase Database 4.3 - Milestone Release for Real-time AP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/Zabbix">Zabbix and OceanBase Database Completed Product Compatibility and Mutual Certification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/adaptive-sql-execution-engine">Adaptive Techniques in the OceanBase SQL Execution Engine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/alter-table">Principles of ALTER TABLE in OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/analysis-column">OceanBase Database V4.3 Feature Breakdown: In-depth Analysis of Columnar Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/binlog-service">OceanBase Binlog Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/column-store">The Present and Future of Columnar Storage in OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/core-tech-ob">Decoding the Core Technologies of OceanBase Community Edition 4.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/distributed-push-down">OceanBase Distributed Pushdown Technology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/end-to-end-tracing">Insights into OceanBase Database 4.0: Issues Addressed by End-to-end Tracing, Starting with a Slow SQL Query</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/failure-by-collation">SQL Tuning Practices - Index Failure Caused by Collations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/flashback-query">Practice of Flashback Queries in OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/high-concurrency">OceanBase Technical Insights for High-Concurrency Scenarios</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/image-search-vector-search">[OceanBase Practices] Building an Image Search Application Based on the Vector Search Technology of OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/legacy-monitoring-system">Using OceanBase Database to Store Data of a traditional Monitoring System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/native-distributed">Treat the Symptoms and the Root Cause! OceanBase Native Distributed + Single-machine Distributed Integration Solves the Problem of Sharding from the Root</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/ob-db-transform">OceanBase Helps Enterprises Cope with the Challenges of Database Transformation in the Deep Waters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/ob-schema">What Is a Schema in OceanBase Database?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/obd-error">Troubleshoot obd Errors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/parallel-execution-I">Mastering Parallel Execution in OceanBase Database: Part 1 - Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/parallel-execution-II">Mastering Parallel Execution in OceanBase Database: Part 2 - Set the DOP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/parallel-execution-III">Mastering Parallel Execution in OceanBase Database: Part 3 - Concurrency Control and Queuing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/parallel-execution-IV">Mastering Parallel Execution in OceanBase Database: Part 4 - Parallel Execution Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/pushdown-tech">Distributed Pushdown Techniques in OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/query-engines">Evolution of Database Query Engines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/blogs/tech/query-perf">Insights into OceanBase Database 4.0: Distributed Query Performance Optimization in OceanBase Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/real-time-analytics">Release of OceanBase Database V4.3.3: The First GA Version for Real-time Analytics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/refine-performance">How We Approach Improving Distributed Query Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/small-specification-deployment">Insights into OceanBase Database 4.0: Support for Small-Specification Deployment to Make Distributed Databases More Accessible</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/storage-engine">Storage Engine of OceanBase Database V4.x Cuts Historical Database Costs by over 50%</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/tablet">What Is a Tablet in OceanBase Database V4.0? Why Is It Introduced?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/tp-to-ap">From OLTP to OLAP: Exploration and practice of the OceanBase SQL engine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/trans-recovery">Principles and Practices of Transaction Recovery in Distributed Databases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/troubleshoot">Five Steps to Troubleshoot Process Crashes Based on Logs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/truncated-table">Why Truncated Tables Cannot Be Recycled in OceanBase Database V4.x?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/tech/vector-search">Vector capabilities of OceanBase Database: find similar images in a blink</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/users/1st-financial">Corporate Cases</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/showcases/architectural-evolution">Highlights</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/others/flink-and-ob">Others</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Technical Introduction</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Insights into OceanBase Database 4.0: Distributed Query Performance Optimization in OceanBase Database</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Insights into OceanBase Database 4.0: Distributed Query Performance Optimization in OceanBase Database</h1></header><blockquote>
<p><strong>Wang Guoping | Senior Technical Expert of OceanBase</strong></p>
</blockquote>
<blockquote>
<p>Wang is the technical director of the OceanBase Database SQL engine team. He joined OceanBase in 2016 and is responsible for the R&amp;D of the SQL engine. He graduated from Harbin Institute of Technology in 2008 and received his PhD from the National University of Singapore in 2014. His main research direction during his PhD was multi-query optimization and processing in the database field. Before joining OceanBase, he was responsible for database R&amp;D in Huawei.</p>
</blockquote>
<p>Performance is one of the important metrics for measuring a database system and also a major concern in the database system field. OceanBase Database V3.x provides a relatively sound optimizer engine, standalone execution engine, parallel execution engine, and vectorized execution engine. In May 2021, OceanBase Database V3.x ran the TPC-H benchmark and ranked first in the 30,000 GB Results list. It achieved a result of 15.26 million QphH@30,000 GB, which showcases its core performance. OceanBase Database has proved its distributed query performance and linear scalability by running this benchmark.</p>
<p>During the massive application of OceanBase Database V3.x, performance issues still occur in some business scenarios. For example, non-optimal execution plans are generated in specific distributed scenarios, the execution engine has no tolerance for non-optimal execution plans, and parallel execution threads cannot be fully used to speed up queries in specific scenarios. To address these issues, when we started to design OceanBase Database V4.0, we thought about how to optimize the SQL engine to improve the distributed query performance. <strong>The distributed query optimization and distributed execution engine</strong> fundamentally determine the distributed query performance of the SQL engine. Let&#x27;s talk about our thoughts from these two aspects.</p>
<p><strong>How does OceanBase Database V4.0 perform distributed query optimization?</strong></p>
<p>As we all know, query optimization is the focus and difficulty in database kernel development, and also the key point that determines the database query performance. Query optimization aims to select the optimal execution plan for each SQL statement. Generally, an SQL statement has many equivalent execution plans whose performance may vary by orders of magnitude. Therefore, query optimization fundamentally determines the query performance. OceanBase Database is a distributed relational database system, which means it inherently needs to perform distributed query optimization. In a relational database system, query optimization is always difficult in development. Distributed query optimization raises the level of the difficulty. Next, let&#x27;s talk about the challenges in distributed query optimization compared with standalone query optimization.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-challenges-in-distributed-query-optimization">1. Challenges in distributed query optimization<a href="#1-challenges-in-distributed-query-optimization" class="hash-link" aria-label="Direct link to 1. Challenges in distributed query optimization" title="Direct link to 1. Challenges in distributed query optimization">​</a></h2>
<p><strong>Significantly expanded plan enumeration space</strong></p>
<p>In query optimization, the optimizer needs to select an implementation method for each operator in an execution plan. In a standalone scenario, the optimizer only needs to consider the implementation of the operator on a single server. In a distributed scenario, the optimizer also needs to consider the distributed implementation of the operator. For example, in a standalone scenario, the implementation methods for a join operator include hash join, merge join, and nested loop join. In a distributed scenario, the implementation methods include partition-wise join, partial partition-wise join, hash-hash distribution join, and broadcast distribution join. When these distributed implementation methods are combined with standalone implementation methods, the plan enumeration space for distributed query optimization will be significantly expanded, posing challenges for the optimization.</p>
<p><strong>More physical attributes to be maintained</strong></p>
<p>In standalone query optimization, operator order is a very important physical attribute because it may be used to speed up subsequent operators. The operator order determines whether tuples in the database are output based on a specific order after the operator is executed. For example, tuples are output in the order of (a,b,c) after the index (a,b,c) is scanned, because OceanBase Database preserves the order during index scan. The operator order is related to the implementation of specific operators. It may even affect the cost of subsequent operators. Therefore, after each operator is executed, query optimization will maintain the physical attribute &quot;order&quot;, and execution plans with a useful order will be retained during plan pruning.</p>
<p>In distributed query optimization, another physical attribute is partition information. Partition information mainly includes the data partitioning method and the physical location of each partition. Partition information fundamentally determines the distributed algorithm selected for an operator. For example, whether a join can be implemented as a partition-wise join depends on the join key and the table partition information. As partition information can also affect the cost of subsequent operators, the physical attribute &quot;partition information&quot; also needs to be maintained during distributed query optimization. Partition information maintenance will finally affect plan pruning and selection and increase the complexity in distributed query optimization.</p>
<p><strong>More accurate distributed cost model needed</strong></p>
<p>In query optimization, cost is the standard to evaluate an execution plan. Generally, cost represents the execution time of an execution plan or the amount of database system resources, such as CPU, I/O, and network resources, occupied by the execution plan. In a standalone scenario, the cost model needs to consider only the CPU and I/O costs. In a distributed scenario, apart from CPU and I/O costs, the cost model also needs to consider the network transmission cost, degree of parallelism (DOP) for queries, and cost in specific distributed optimization scenarios such as cost calculation for a Bloom filter. These factors increase the complexity in the design and fitting of a distributed cost model, as well as the complexity in distributed query optimization to some extent.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-two-phase-distributed-query-optimization-in-oceanbase-database-v3x">2. Two-phase distributed query optimization in OceanBase Database V3.x<a href="#2-two-phase-distributed-query-optimization-in-oceanbase-database-v3x" class="hash-link" aria-label="Direct link to 2. Two-phase distributed query optimization in OceanBase Database V3.x" title="Direct link to 2. Two-phase distributed query optimization in OceanBase Database V3.x">​</a></h2>
<p>To decrease the complexity caused by distributed query optimization, OceanBase Database V3.x adopts two-phase distributed query optimization, which is a common solution in the industry.</p>
<p>In the first phase, based on the assumption that all tables are stored on the local server, the optimizer selects a local optimal execution plan by using the existing standalone query optimization capabilities.</p>
<p>In the second phase, based on the fixed join order and local algorithms, the optimizer selects a distributed algorithm for each operator by using a simple distributed cost model.</p>
<p>The following figure shows an example of two-phase distributed query optimization for query Q1. In the first phase, the optimizer selects a local optimal execution plan, as shown on the left side of the figure. MJ represents merge join, HJ represents hash join, and HGBY represents hash group by, which are local algorithms. In the second phase, based on the fixed join order and local algorithms, the optimizer selects a distributed algorithm for each operator by using a simple distributed cost model. In this example, the partition-wise join algorithm is selected for the MJ node, and the hash-hash distribution join algorithm is selected for the HJ node.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create table R2(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create table R3(a int primary key, b int, c int, d int) partition by hash(b) partitions 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select R2.c, sum(R3.d) from R1, R2, R3 where R1.a = R2.a and R2.C = R3.C group by R2.C;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/330988c9-f643-4c4b-af39-50584f9b99e0-330f25c288e1ac8058a2a876bdb71874.png" width="1234" height="486" class="img_ev3q"></p>
<p>Two-phase distributed query optimization significantly decreases the optimization complexity. However, during massive commercial use of OceanBase Database V3.x, the effects of two-phase distributed query optimization are sometimes not as expected due to the following reasons:</p>
<p><strong>A non-optimal local algorithm is selected when partition information is ignored</strong></p>
<p>During two-phase distributed query optimization, if partition information is ignored in the first phase, a non-optimal local algorithm will generally be selected. The following example shows a query Q2 and its execution plan in the first phase. During local optimization in the first phase, if the selectivity of predicate R1.c = 100 is low, a few rows in the R1 table meet this condition. In this case, the optimizer will select a nested loop join for this query. Specifically, for each row in the R1 table that meets the condition, data that meets the condition is quickly obtained from the R2 table based on the index <code>idx</code>. In actual execution, however, the execution time of the nested loop join is much longer than that estimated by the optimizer. This is because R2 is a partitioned table with 100 partitions and the operation performed for each row in the R1 table must be performed in each partition in the R2 table during the nested loop join, which increases the execution time by 100 times. In this case, the optimal plan may be a hash join rather than a nested loop join. In this scenario, partition information is not considered during the optimization in the first phase. As a result, the standalone costs of operators are incorrectly estimated in the first phase, and a non-optimal local algorithm is selected for the query.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int primary key, b int, c int);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create table R2(a int primary key, b int, c int, index idx(b)) partition by hash(a) partitions 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Q2: select * from R1, R2 where R2.b = R1.b and R1.c = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*Execution plan for the first phase*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | =============================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |ID|OPERATOR        |NAME   |EST. ROWS|COST |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ---------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |0 |NESTED-LOOP JOIN|       |970299   |85622|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |1 | TABLE SCAN     |r1     |990      |40790|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |2 | TABLE SCAN     |r2(idx)|1        |44   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    =============================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Outputs &amp; filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0 - output([r1.a], [r1.b], [r1.c], [r2.a], [r2.b], [r2.c]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          conds(nil), nl_params_([r1.b])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 - output([r1.b], [r1.c], [r1.a]), filter([r1.c = 100]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access([r1.b], [r1.c], [r1.a]), partitions(p0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 - output([r2.b], [r2.a], [r2.c]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access([r2.b], [r2.a], [r2.c]), partitions(p0)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>A non-optimal join order is selected when partition information is ignored</strong></p>
<p>During two-phase distributed query optimization, if partition information is ignored in the first phase, a non-optimal join order will generally be selected. The following figure shows a query Q3 and two groups of local plans and distributed plans generated for it. In the first group, the join order is ((R2, R3), R1). In the second group, the join order is ((R1, R2), R3). If partition information is not considered, the optimizer may select the ((R2, R3), R1) join order in the first phase. However, this join order may incur more network transmission costs in the second phase. As shown in the following figure, the tables R1, R2, and R3, as well as the join results of R2 and R3, all need to be transmitted over the network. ((R1,R2), R3) may be a better join order. This is because in the second phase, only R3 and the join results of R1 and R2 need to be transmitted. Since a partition-wise join can be performed on R1 and R2, the two tables do not need to be transmitted over the network. In business scenarios, it is common that an inappropriate join order is selected due to the ignorance of partition information.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;create table R2(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;create table R3(a int primary key, b int, c int, d int) partition by hash(b) partitions 5;Q3: select R2.c, sum(R3.d) from R1, R2, R3 where R1.a = R2.a and R2.b = R3.b;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/2c02e366-d102-488a-b179-42ea1f8c3779-97af413c31e6fbffbaa7736075ee36ba.png" width="845" height="872" class="img_ev3q"></p>
<p>In the foregoing two scenarios, a non-optimal join order and a non-optimal local algorithm are selected because partition information is not considered during optimization in the first phase. Through the two scenarios, we can see that the drawbacks of two-phase distributed query optimization are obvious. Next, let&#x27;s talk about how OceanBase Database V4.0 performs distributed query optimization to resolve these issues.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-distributed-query-optimization-in-oceanbase-database-v40">3. Distributed query optimization in OceanBase Database V4.0<a href="#3-distributed-query-optimization-in-oceanbase-database-v40" class="hash-link" aria-label="Direct link to 3. Distributed query optimization in OceanBase Database V4.0" title="Direct link to 3. Distributed query optimization in OceanBase Database V4.0">​</a></h2>
<p>OceanBase Database V4.0 uses the one-phase optimization method for distributed queries. In this method, the optimizer enumerates both local and distributed algorithms in the same phase and estimates the costs by using a distributed cost model. OceanBase Database V4.0 restructures the entire distributed query optimization method from two-phase optimization to one-phase optimization.</p>
<p>To facilitate understanding of the one-phase distributed query optimization method, I first want to introduce the bottom-up dynamic programming method in System-R. Given an SQL statement, System-R uses the bottom-up dynamic programming method to enumerate joins and select a join algorithm. For a join that involves N tables, this method will enumerate execution plans for each subset by size. For each enumeration subset, the method will select an optimal plan as follows:</p>
<ul>
<li>Enumerate all standalone join algorithms, maintain the physical attribute &quot;order&quot;, and calculate the costs based on a standalone cost model.</li>
<li>Retain the plan with the lowest cost and those with a useful order. The order in a plan is useful when and only when this order is useful for the allocation of subsequent operators.</li>
</ul>
<p>The following figure shows an example of plan enumeration for a join that involves four tables. The method will first enumerate plans for all base tables of size 1. For each base table, the method will enumerate all indexes and retain plans with the lowest cost and a useful order. Then, the method will enumerate plans for each subset of size 2. For example, to enumerate all execution plans for the join of <code>{R1,R2}</code>, the method will consider all standalone join algorithms and combine them with all plans retained for R1 and R2. The method will continue enumeration until execution plans are enumerated for the subset of size 4.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/87ee8003-c9b5-46bb-83c2-52abd3a3eb8c-8c63d15b55fdf73aaba55d0ef51bea0e.png" width="1001" height="408" class="img_ev3q"></p>
<p>Based on the standalone query optimization method of System-R, OceanBase Database V4.0 implements distributed query optimization as follows:</p>
<p>1. For each enumeration subset, OceanBase Database will enumerate the distributed algorithms of all operators, use a distributed cost model to calculate the cost of each distributed algorithm, and maintain two physical attributes: order and partition information.</p>
<p>2. For each enumeration subset, OceanBase Database will retain the plan with the lowest cost, plans with a useful order, and plans with useful partition information. Partition information is useful when and only when it is useful for subsequent operators. In the scenario shown in the following figure, plan P1 uses a hash-hash distribution join, and plan P2 uses a broadcast distribution join for the R2 table. Though P2 has a higher cost than P1, P2 inherits the partition information of the R1 table, which will be useful for the subsequent GROUP BY operator. Therefore, P2 will also be retained.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create table R2(a int primary key, b int, c int, d int) partition by hash(a) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select R1.a, SUM(R2.c) from R1, R2 where R1.b = R2.b group by R1.a;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/0a41f314-f6a5-41f1-913d-c6b230dd0f25-84e8fb51baf93a2beff3abe6b4411d0b.png" width="970" height="245" class="img_ev3q"></p>
<p>OceanBase Database V4.0 uses the one-phase distributed query optimization method, which involves a much larger plan space than standalone query optimization. Facing the issue of a large plan space, OceanBase Database V4.0 provides a variety of methods for quick plan pruning. It also provides new join enumeration algorithms to support distributed plan enumeration for ultra-large tables. Thanks to these techniques, OceanBase Database V4.0 effectively reduces the distributed plan space and improves the distributed query optimization performance. Our experimental results also show that OceanBase Database V4.0 can enumerate distributed plans for 50 tables within seconds.</p>
<p><strong>How does OceanBase Database V4.0 improve the performance of the distributed execution engine?</strong></p>
<p>Compared with OceanBase Database V3.x, OceanBase Database V4.0 has made many improvements in the execution engine. It has implemented new distributed and standalone algorithms, such as null-aware hash anti-join, shared broadcast hash join, hash-based window function, and partitioned Bloom filter. It has also improved the implementation of the entire vectorized engine, developed ultimate parallel pushdown techniques, and initiated the development of adaptive techniques. These efforts have greatly improved the performance of both distributed and standalone queries. Here I want to introduce the adaptive techniques and parallel pushdown techniques of OceanBase Database V4.0.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-development-towards-an-adaptive-execution-engine">4. Development towards an adaptive execution engine<a href="#4-development-towards-an-adaptive-execution-engine" class="hash-link" aria-label="Direct link to 4. Development towards an adaptive execution engine" title="Direct link to 4. Development towards an adaptive execution engine">​</a></h2>
<p>In business scenarios of OceanBase Database, we found that the execution engine has no tolerance for non-optimal execution plans generated by the optimizer. When the optimizer generates non-optimal execution plans, the execution engine cannot adjust the plans to improve the execution performance. Although the optimizer is designed to choose the optimal execution plans for database queries, the optimizer itself is not perfect. For example, it cannot accurately estimate the total number of rows. So, the optimizer may pick a less optimal execution plan, or even a lousy one.</p>
<p>To resolve this issue, OceanBase Database V4.0 starts to develop an adaptive execution engine. An adaptive execution engine identifies some non-optimal execution plans based on the real-time execution status and adjusts them accordingly to improve the execution performance. We believe that once an execution engine reaches a certain stage of development, it must use adaptive techniques to address the issue of non-optimal execution plans generated by the optimizer. However, we also do not believe that adaptive techniques can handle all scenarios of non-optimal plans.</p>
<p>OceanBase Database V4.0 implements adaptive GROUP BY/DISTINCT parallel pushdown, which can prevent performance downgrade caused by non-optimal plans in GROUP BY/DISTINCT parallel pushdown scenarios. Before we dive into the adaptive technique, let me briefly introduce the GROUP BY/DISTINCT parallel pushdown technique. As a general technique in distributed execution, GROUP BY/DISTINCT parallel pushdown is often used to push down the GROUP BY operator in advance to pre-aggregate some data. This reduces the workload of network transmission, thus improving the performance. The following figure shows an example where the execution plan pushes down the GROUP BY operator to Operator 5 for data pre-aggregation, so that the network transmission workload of Operator 4 is reduced to achieve higher performance. However, note that GROUP BY parallel pushdown does not necessarily improve the performance. It sometimes backfires, mainly because it consumes extra computing resources. GROUP BY parallel pushdown brings benefits only when the performance improvement in network transmission surpasses the extra computing cost.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int primary key, b int, c int) partition by hash(a) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    explain select b, sum(c) from R1 group by b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | ==========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |ID|OPERATOR                     |NAME    |EST. ROWS|COST|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |0 |PX COORDINATOR               |        |1        |10  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |1 | EXCHANGE OUT DISTR          |:EX10001|1        |10  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |2 |  HASH GROUP BY              |        |1        |9   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |3 |   EXCHANGE IN DISTR         |        |1        |9   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |4 |    EXCHANGE OUT DISTR (HASH)|:EX10000|1        |8   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |5 |     HASH GROUP BY           |        |1        |8   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |6 |      PX PARTITION ITERATOR  |        |1        |7   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |7 |       TABLE SCAN            |r1      |1        |7   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ==========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Outputs &amp; filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0 - output([INTERNAL_FUNCTION(r1.b, T_FUN_SUM(T_FUN_SUM(r1.c)))]), filter(nil), rowset=256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 - output([INTERNAL_FUNCTION(r1.b, T_FUN_SUM(T_FUN_SUM(r1.c)))]), filter(nil), rowset=256, dop=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 - output([r1.b], [T_FUN_SUM(T_FUN_SUM(r1.c))]), filter(nil), rowset=256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group([r1.b]), agg_func([T_FUN_SUM(T_FUN_SUM(r1.c))])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      3 - output([r1.b], [T_FUN_SUM(r1.c)]), filter(nil), rowset=256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4 - (#keys=1, [r1.b]), output([r1.b], [T_FUN_SUM(r1.c)]), filter(nil), rowset=256, dop=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      5 - output([r1.b], [T_FUN_SUM(r1.c)]), filter(nil), rowset=256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group([r1.b]), agg_func([T_FUN_SUM(r1.c)])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      6 - output([r1.b], [r1.c]), filter(nil), rowset=256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      7 - output([r1.b], [r1.c]), filter(nil), rowset=256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access([r1.b], [r1.c]), partitions(p[0-3])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In OceanBase Database of earlier versions, the optimizer determines whether to push down the GROUP BY operator based on cost estimation. However, the optimizer may sometimes incorrectly estimate the number of rows. As a result, the GROUP BY operator is not pushed down or is incorrectly pushed down, compromising the execution performance. To resolve this issue, OceanBase Database V4.0 introduces adaptive GROUP BY/DISTINCT parallel pushdown. The optimizer will always push down the GROUP BY/DISTINCT operator and determine whether to skip the pushed down GROUP BY/DISTINCT operator by sampling part of the data of the operator during execution. The challenge of this technique lies in how to determine whether the pushed down operator has satisfactory pre-aggregation performance. The OceanBase solution is to control the performance of the hash table of the pushed down operator by limiting the table within the L3 cache and perform multiple rounds of sampling to prevent misjudgment due to continuous non-aggregation of data. The key points of the solution are described as follows:</p>
<ul>
<li>
<p>The execution engine limits the hash table within the L2 cache (1 MB) and, in the case of unsatisfactory pre-aggregation performance, marks the hash table as discarded. If the pre-aggregation performance is good, the execution engine expands the hash table to the L3 cache (10 MB) and, if more memory is needed during the execution, marks the hash table as discarded.</p>
</li>
<li>
<p>If the hash table is discarded, the execution engine returns and releases all rows of the table, and then rebuilds the hash table to start the next round of sampling.</p>
</li>
<li>
<p>If pre-aggregation fails to achieve satisfactory performance in five consecutive rounds of sampling, the execution engine skips the pushed down GROUP BY operator.</p>
</li>
</ul>
<p>Adaptive GROUP BY/DISTINCT parallel pushdown incurs extra overhead for sampling and computing, which are required to determine whether to skip the pushed down operator during the execution. However, our tests based on various data distribution modes indicate that the extra overhead can be kept within 10%, which is much lower than the performance gain.</p>
<p>We are also working on more adaptive techniques, such as the adaptive creation and detection of Bloom filters, adaptive tuning of nested loop joins and hash joins, and adaptive tuning of broadcast distribution joins and hash-hash distribution joins. We believe that these adaptive techniques can elevate the capabilities of the execution engine to a new level, making the execution engine more robust. This way, when the optimizer generates a non-optimal or lousy execution plan, the execution engine can adjust the plan to improve the query performance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-development-towards-ultimate-parallel-pushdown">5. Development towards ultimate parallel pushdown<a href="#5-development-towards-ultimate-parallel-pushdown" class="hash-link" aria-label="Direct link to 5. Development towards ultimate parallel pushdown" title="Direct link to 5. Development towards ultimate parallel pushdown">​</a></h2>
<p>Parallel pushdown in the execution of distributed queries is a technique where the computing of some operators is pushed down to improve performance. Generally, this technique improves the performance of distributed queries by performing executions at the maximum parallelism or by reducing network transmission. It significantly improves the performance of distributed queries by orders of magnitude in many cases. The GROUP BY/DISTINCT parallel pushdown technique described in the previous section is a typical example of parallel pushdown techniques. Compared with OceanBase Database V3.x, OceanBase Database V4.0 provides well-developed parallel pushdown techniques, which work on almost all operators in analytical processing (AP) scenarios, such as GROUP BY, ROLLUP, and DISTINCT, and window functions.</p>
<p>The following table compares OceanBase Database V3.x and OceanBase Database V4.0 in parallel pushdown.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/8ae0d7fe-c66c-491d-ae63-c70899cad4b3-044ed346cb3131bb67fe1ac2930bca83.png" width="1016" height="818" class="img_ev3q"></p>
<p>In OceanBase Database V4.0, the implementation of parallel pushdown varies based on operators. Due to the complexity in parallel execution, each implementation is confronted with different challenges. Here we won&#x27;t introduce each implementation of parallel pushdown. Let&#x27;s talk about the three-phase parallel pushdown technique for DISTINCT aggregate functions, to illustrate the advantages of parallel pushdown. The following example shows a query Q1 that contains two DISTINCT aggregate functions. In OceanBase Database V3.x, parallel pushdown cannot be performed for Q1. The execution plan of Q1 shows that all deduplication logic and aggregate logic are calculated by Operator 0, which does not support parallel execution, leading to poor overall execution performance.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int, b int, c int, d int, primary key(a,b)) partition by hash(b) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Q1: select sum(distinct c), sum(distinct d) from R1 where a = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | =====================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |ID|OPERATOR                |NAME    |EST. ROWS|COST|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -----------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |0 |SCALAR GROUP BY         |        |1        |2365|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |1 | PX COORDINATOR         |        |3960     |2122|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |2 |  EXCHANGE OUT DISTR    |:EX10000|3960     |1532|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |3 |   PX PARTITION ITERATOR|        |3960     |1532|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |4 |    TABLE SCAN          |r1      |3960     |1532|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    =====================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Outputs &amp; filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0 - output([T_FUN_SUM(distinct r1.c)], [T_FUN_SUM(distinct r1.d)]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group(nil), agg_func([T_FUN_SUM(distinct r1.c)], [T_FUN_SUM(distinct r1.d)])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 - output([r1.c], [r1.d]), filter(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 - output([r1.c], [r1.d]), filter(nil), dop=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      3 - output([r1.c], [r1.d]), filter(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4 - output([r1.c], [r1.d]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access([r1.c], [r1.d]), partitions(p[0-3])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To improve the distributed execution performance of a query that uses a DISTINCT aggregate function, OceanBase Database V4.0 introduces the three-phase parallel pushdown logic. The following example shows the three-phase parallel pushdown logic for a query that uses a DISTINCT aggregate function. The details are as follows:</p>
<p><strong>In the first phase</strong>, the DISTINCT logic is pushed down for partial deduplication. In this example, the job in this phase is completed by Operator 6.</p>
<p><strong>In the second phase</strong>, data is repartitioned based on the deduplicated column, and then full deduplication and partial pre-aggregation calculation are performed. In this example, the job in this phase is completed by Operators 3, 4, and 5.</p>
<p><strong>In the third phase</strong>, the results obtained in the second phase are aggregated. In this example, the job in this phase is completed by Operators 0, 1, and 2.</p>
<p>Compared to the execution without operator pushdown, the three-phase parallel pushdown technique has two performance benefits. First, it allows data deduplication and pre-aggregation at the maximum parallelism. Second, data deduplication by using the DISTINCT pushdown technique reduces the workload of network transmission.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int, b int, c int, d int, primary key(a,b)) partition by hash(b) partitions 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select sum(distinct c) from R1 where a = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | ===========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |ID|OPERATOR                      |NAME    |EST. ROWS|COST|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |0 |SCALAR GROUP BY               |        |1        |1986|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |1 | PX COORDINATOR               |        |1        |1835|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |2 |  EXCHANGE OUT DISTR          |:EX10001|1        |1835|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |3 |   MERGE GROUP BY             |        |1        |1835|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |4 |    EXCHANGE IN DISTR         |        |1        |1683|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |5 |     EXCHANGE OUT DISTR (HASH)|:EX10000|1        |1683|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |6 |      HASH GROUP BY           |        |1        |1683|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |7 |       PX PARTITION ITERATOR  |        |3960     |1532|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |8 |        TABLE SCAN            |r1      |3960     |1532|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ===========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Outputs &amp; filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0 - output([T_FUN_SUM(T_FUN_SUM(distinct r1.c))]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group(nil), agg_func([T_FUN_SUM(T_FUN_SUM(distinct r1.c))])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 - output([T_FUN_SUM(distinct r1.c)]), filter(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 - output([T_FUN_SUM(distinct r1.c)]), filter(nil), dop=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      3 - output([T_FUN_SUM(distinct r1.c)]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group(nil), agg_func([T_FUN_SUM(distinct r1.c)])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4 - output([r1.c]), filter(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      5 - (#keys=1, [r1.c]), output([r1.c]), filter(nil), dop=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      6 - output([r1.c]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          group([r1.c]), agg_func(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      7 - output([r1.c]), filter(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8 - output([r1.c]), filter(nil),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access([r1.c]), partitions(p[0-3]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The preceding example shows how the three-phase parallel pushdown technique works for an aggregate function with only one DISTINCT keyword. The question is, is it still effective for aggregate functions with more DISTINCT keywords? The answer is yes. The trick is that in Phase 1, we create a replica of the data set for each aggregate function that has N DISTINCT keywords and tag the replica to indicate its association with this aggregate function. Similar operations are performed in Phases 2 and 3, except for some minor differences in terms of implementation. The following example shows the three-phase pushdown logic for a query that uses two DISTINCT aggregate functions. AGGR_CODE is used to mark the redundant data generated by each DISTINCT aggregate function.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    create table R1(a int, b int, c int, d int, primary key(a,b)) partition by hash(b) partitions 4;select sum(distinct c), sum(distinct d) from R1 where a = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | ===========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |ID|OPERATOR                      |NAME    |EST. ROWS|COST|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |0 |SCALAR GROUP BY               |        |1        |13  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |1 | PX COORDINATOR               |        |2        |13  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |2 |  EXCHANGE OUT DISTR          |:EX10001|2        |12  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |3 |   HASH GROUP BY              |        |2        |11  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |4 |    EXCHANGE IN DISTR         |        |2        |10  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |5 |     EXCHANGE OUT DISTR (HASH)|:EX10000|2        |9   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |6 |      HASH GROUP BY           |        |2        |8   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |7 |       PX PARTITION ITERATOR  |        |1        |7   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |8 |        TABLE SCAN            |r1      |1        |7   |===========================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Outputs &amp; filters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      0 - output([T_FUN_SUM(T_FUN_SUM(dup(r1.c)))], [T_FUN_SUM(T_FUN_SUM(dup(r1.d)))]), filter(nil), rowset=256,      group(nil), agg_func([T_FUN_SUM(T_FUN_SUM(dup(r1.c)))], [T_FUN_SUM(T_FUN_SUM(dup(r1.d)))])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 - output([AGGR_CODE], [T_FUN_SUM(dup(r1.c))], [T_FUN_SUM(dup(r1.d))]), filter(nil), rowset=256  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 - output([AGGR_CODE], [T_FUN_SUM(dup(r1.c))], [T_FUN_SUM(dup(r1.d))]), filter(nil), rowset=256, dop=1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      3 - output([AGGR_CODE], [T_FUN_SUM(dup(r1.c))], [T_FUN_SUM(dup(r1.d))]), filter(nil), rowset=256,      group([AGGR_CODE]), agg_func([T_FUN_SUM(dup(r1.c))], [T_FUN_SUM(dup(r1.d))])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      4 - output([AGGR_CODE], [dup(r1.c)], [dup(r1.d)]), filter(nil), rowset=256  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      5 - (#keys=3, [AGGR_CODE], [dup(r1.c)], [dup(r1.d)]), output([AGGR_CODE], [dup(r1.c)], [dup(r1.d)]), filter(nil), rowset=256, dop=1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      6 - output([AGGR_CODE], [dup(r1.c)], [dup(r1.d)]), filter(nil), rowset=256,      group([AGGR_CODE], [dup(r1.c)], [dup(r1.d)]), agg_func(nil)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      7 - output([r1.c], [r1.d]), filter(nil), rowset=256  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      8 - output([r1.c], [r1.d]), filter(nil), rowset=256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            access([r1.c], [r1.d]), partitions(p[0-3])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Parallel pushdown is common in distributed scenarios. In OceanBase Database V3.x, the distributed query performance often deteriorates due to the imperfection of the parallel pushdown feature. OceanBase Database V4.0 can resolve such issues to improve the distributed query performance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-afterword">6. Afterword<a href="#6-afterword" class="hash-link" aria-label="Direct link to 6. Afterword" title="Direct link to 6. Afterword">​</a></h2>
<p>In the end, I want to share with you the actual improvements made by OceanBase Database V4.0 in distributed query performance. Compared with OceanBase Database V3.x, OceanBase Database V4.0 implements a new distributed cost model, a distributed query optimization framework, a set of well-developed parallel pushdown techniques, and adaptive techniques. The development of these techniques is driven by our understanding of customer requirements and distributed systems.</p>
<p>We tested the techniques by running the TPC-DS 100 GB benchmark. The test results show that the new techniques significantly improve the distributed query performance. The total execution duration of 99 queries decreases from 918s to 270s. The following figure compares the performance of queries in OceanBase Database V3.x and OceanBase Database V4.0 in the TPC-DS 100 GB benchmark.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/bb5d7618-9c57-45d6-9547-3fea3c97e651-153077832933d5b9c1daaa5b522e91ea.png" width="989" height="526" class="img_ev3q"></p>
<p>Performance comparison between OceanBase Database V3.x and V4.0 in the TPC-DS 100 GB benchmark</p>
<p>These are our thoughts on the value and technical evolution of distributed query optimization of OceanBase Database V4.0. Databases are foundational software in essence. For software users, we hope that later OceanBase Database V4.x versions can bring better user experience and higher query performance based on distributed query optimization and technical innovations in the execution engine.</p>
<p>Follow us in the <a href="https://open.oceanbase.com/blog" target="_blank" rel="noopener noreferrer">OceanBase community</a>. We aspire to regularly contribute technical information so we can all move forward together.</p>
<p>Search 🔍 DingTalk group 33254054 or scan the QR code below to join the OceanBase technical Q&amp;A group. You can find answers to all your technical questions there.</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/zos/oceanbase/f4d95b17-3494-4004-8295-09ab4e649b68/image/2022-08-29/00ff7894-c260-446d-939d-f98aa6648760.png" alt="" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/oceanbase/oceanbase.github.io/tree/main/docs/blogs/tech/query-perf.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/blogs/tech/query-engines"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Evolution of Database Query Engines</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blogs/tech/real-time-analytics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Release of OceanBase Database V4.3.3: The First GA Version for Real-time Analytics</div></a></nav><div>Loading...</div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-challenges-in-distributed-query-optimization" class="table-of-contents__link toc-highlight">1. Challenges in distributed query optimization</a></li><li><a href="#2-two-phase-distributed-query-optimization-in-oceanbase-database-v3x" class="table-of-contents__link toc-highlight">2. Two-phase distributed query optimization in OceanBase Database V3.x</a></li><li><a href="#3-distributed-query-optimization-in-oceanbase-database-v40" class="table-of-contents__link toc-highlight">3. Distributed query optimization in OceanBase Database V4.0</a></li><li><a href="#4-development-towards-an-adaptive-execution-engine" class="table-of-contents__link toc-highlight">4. Development towards an adaptive execution engine</a></li><li><a href="#5-development-towards-ultimate-parallel-pushdown" class="table-of-contents__link toc-highlight">5. Development towards ultimate parallel pushdown</a></li><li><a href="#6-afterword" class="table-of-contents__link toc-highlight">6. Afterword</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/oceanbase/shared_invite/zt-1e25oz3ol-lJ6YNqPHaKwY_mhhioyEuw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum (in Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">SIG</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/sig/AI/sig_intro">AI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/cloud-native/sig_intro">cloud-native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/compilation/sig_intro">compilation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/develop-tools/sig_intro">develop-tools</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/miniob/sig_intro">MiniOB</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/obdiag/sig_intro">obdiag</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/operation/sig_intro">operation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://en.oceanbase.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">About OceanBase<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/blogs/arch/all-in-one">Blogs</a></li><li class="footer__item"><a href="https://github.com/oceanbase/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OceanBase, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>