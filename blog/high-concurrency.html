<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">OceanBase Technical Insights for High-Concurrency Scenarios | OceanBase</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://oceanbase.github.io/blog/high-concurrency"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="OceanBase Technical Insights for High-Concurrency Scenarios | OceanBase"><meta data-rh="true" name="description" content="As large-scale promotions become the norm, it is a severe challenge for enterprises to ensure a smooth shopping experience for users during peak times, apart from annual shopping festivals such as &quot;Double 11&quot; and &quot;618&quot;, by designing their application architecture and database architecture effectively to handle traffic surges. Based on its 10 years of experience in supporting &quot;Double 11&quot; as well as its features of online scaling, high concurrency, and low latency, OceanBase Database can quickly respond to business load changes without affecting the business, thereby improving system throughput during flash sales."><meta data-rh="true" property="og:description" content="As large-scale promotions become the norm, it is a severe challenge for enterprises to ensure a smooth shopping experience for users during peak times, apart from annual shopping festivals such as &quot;Double 11&quot; and &quot;618&quot;, by designing their application architecture and database architecture effectively to handle traffic surges. Based on its 10 years of experience in supporting &quot;Double 11&quot; as well as its features of online scaling, high concurrency, and low latency, OceanBase Database can quickly respond to business load changes without affecting the business, thereby improving system throughput during flash sales."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-06-03T13:23:07.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://oceanbase.github.io/blog/high-concurrency"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/blog/high-concurrency" hreflang="en"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/blog/high-concurrency" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://6JQM9QDU5V-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://oceanbase.github.io/blog/high-concurrency","mainEntityOfPage":"https://oceanbase.github.io/blog/high-concurrency","url":"https://oceanbase.github.io/blog/high-concurrency","headline":"OceanBase Technical Insights for High-Concurrency Scenarios","name":"OceanBase Technical Insights for High-Concurrency Scenarios","description":"As large-scale promotions become the norm, it is a severe challenge for enterprises to ensure a smooth shopping experience for users during peak times, apart from annual shopping festivals such as \"Double 11\" and \"618\", by designing their application architecture and database architecture effectively to handle traffic surges. Based on its 10 years of experience in supporting \"Double 11\" as well as its features of online scaling, high concurrency, and low latency, OceanBase Database can quickly respond to business load changes without affecting the business, thereby improving system throughput during flash sales.","datePublished":"2024-06-03T13:23:07.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://oceanbase.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OceanBase RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OceanBase Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8d7d8da1.css">
<script src="/assets/js/runtime~main.14c2332f.js" defer="defer"></script>
<script src="/assets/js/main.1d445965.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OceanBase</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blogs</a><div class="navbar__item dropdown dropdown--hoverable"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/blog/high-concurrency">Docs</a><ul class="dropdown__menu"><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Product Docs</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">User Manual</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Developer Manual</a></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/blog/high-concurrency">Community</a><ul class="dropdown__menu"><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Special Interest Group(SIG)</a><span><li><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub Discussion<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://join.slack.com/t/oceanbase/shared_invite/zt-1e25oz3ol-lJ6YNqPHaKwY_mhhioyEuw" target="_blank" rel="noopener noreferrer" class="dropdown__link">Slack<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Forum (in Chinese)<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stack Overflow<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><a href="https://en.oceanbase.com/softwarecenter" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Downloads<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oceanbase" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/architectural-evolution">The architectural evolution of OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/compression-ratio">Data Compression Technology Explained Balance between Costs &amp; Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/flink-cdc">Flink CDC + OceanBase integration solution for full and incremental synchronization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrated-architecture">Integrated Architecture of OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrated-sql-engine">Integrated SQL Engine in OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/vectorized-engine">Implementing a Vectorized Engine in a Distributed Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/boss-zhipin">BOSS Zhipin —— How to save 70% storage cost through OceanBase with an archive database of 1 billion rows per day?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dmall">DMALL —— a summary of database selection experience in SaaS scenarios</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sichuan-hwadee">Sichuan Hwadee —— The practice of lightweight data warehouse construction of health big data based on OceanBase</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kuayue-express">KUAYUE EXPRESS —— In the real-time warehouse scenario, utilizing OceanBase to make up for the shortcomings of MySQL and StarRocks</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/momo">Momo —— Exploration and practice of persistent cache based on OceanBase KV storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/all-in-one">Work with developers to create an all-in-one database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/io-isolation">OceanBase provides users with sufficiently flexible and simple I/O resource isolation experiences.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/miniaturization">OceanBase 4.0 interpretation: Reduce the threshold of distributed database use, talk about our thinking on small specifications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ob-430">OceanBase 4.3 - Milestone release for real-time AP analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/resource-isolation">Why is resource isolation important for HTAP?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/flink-and-ob">Flink CDC + OceanBase integration solution for full and incremental synchronization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hello-oceanbase">Hello OceanBase! The first lesson for becoming an OceanBase contributor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/obcloud">How OB Cloud Achieves Cost Reduction and Efficiency Improvement in Replacing MySQL Scenarios ？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/adaptive-sql-execution-engine">Adaptive Techniques in the OceanBase SQL Execution Engine</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/distributed-push-down">OceanBase Distributed Pushdown Technology</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/high-concurrency">OceanBase Technical Insights for High-Concurrency Scenarios</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/refine-performance">How We Approach Improving Distributed Query Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tp-to-ap">From OLTP to OLAP: Exploration and practice of the OceanBase SQL engine</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">OceanBase Technical Insights for High-Concurrency Scenarios</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-06-03T13:23:07.000Z">June 3, 2024</time> · <!-- -->15 min read</div></header><div id="__blog-post-container" class="markdown"><p>As large-scale promotions become the norm, it is a severe challenge for enterprises to ensure a smooth shopping experience for users during peak times, apart from annual shopping festivals such as &quot;Double 11&quot; and &quot;618&quot;, by designing their application architecture and database architecture effectively to handle traffic surges. Based on its 10 years of experience in supporting &quot;Double 11&quot; as well as its features of online scaling, high concurrency, and low latency, OceanBase Database can quickly respond to business load changes without affecting the business, thereby improving system throughput during flash sales.</p>
<p><a href="https://www.oceanbase.com/solution/ecommerce" target="_blank" rel="noopener noreferrer"><strong>Click to see more about scaling solutions for large-scale promotions&gt;&gt;</strong></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cases"><strong>Cases</strong><a class="hash-link" aria-label="Direct link to cases" title="Direct link to cases" href="/blog/high-concurrency#cases">​</a></h2>
<p><a href="https://www.oceanbase.com/customer/haidilao" target="_blank" rel="noopener noreferrer"><strong>Haidilao: stable support for holiday traffic peaks</strong></a></p>
<p><a href="https://www.oceanbase.com/customer/popmart" target="_blank" rel="noopener noreferrer"><strong>POP MART: handle traffic spikes of a hundredfold during flash sales</strong></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-high-concurrency-techniques-of-oceanbase-database"><strong>Key high-concurrency techniques of OceanBase Database</strong><a class="hash-link" aria-label="Direct link to key-high-concurrency-techniques-of-oceanbase-database" title="Direct link to key-high-concurrency-techniques-of-oceanbase-database" href="/blog/high-concurrency#key-high-concurrency-techniques-of-oceanbase-database">​</a></h2>
<p>A database system must ensure both the correctness and high concurrency of the database. <strong>The key to ensure database correctness in high-concurrency scenarios is to ensure the ACID properties of transactions.</strong> Isolation (I) in ACID means that parallel execution of concurrent transactions produces the same effect as serial execution of those transactions. This kind of isolation is a serializable isolation. A serializable isolation is often accompanied by a large amount of conflict wait time or a large number of conflict failures. Therefore, the costs are relatively high.</p>
<p>To provide better performance of concurrent execution, the database has to relax the validation on schedules, allowing more non-serializable schedules to be run. The result of multiple concurrent transactions may no longer be equivalent to the result of any kind of serializable execution. The following promises must be made to regulate the database use: what kinds of errors will occur and what will not. These promises reflect the isolation levels of the database.</p>
<p>Based on three phenomena that can lead to data errors in the concurrent execution of transactions, the SQL-92 standard defines a set of isolation levels. It defines four isolation levels based on whether they allow each of the phenomena. <strong>A critique of ANSI SQL Isolation Levels</strong>, a paper published in 1995, identified a number of problems with the definitions of isolation levels in the SQL-92 standard.</p>
<ol>
<li>The definition of phenomena in SQL-92 is too narrow. It is impossible to achieve serializable isolation even if the three phenomena are excluded.</li>
<li>Several new phenomena are added: dirty write, lost update, read skew, and write skew.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consistency-of-distributed-transactions"><strong>Consistency of distributed transactions</strong><a class="hash-link" aria-label="Direct link to consistency-of-distributed-transactions" title="Direct link to consistency-of-distributed-transactions" href="/blog/high-concurrency#consistency-of-distributed-transactions">​</a></h3>
<p>For concurrent transactions, distributed databases face more challenges than standalone databases.</p>
<p><strong>The first challenge is read/write concurrency.</strong></p>
<p>In distributed database systems, a two-phase commit protocol or rollback compensation mechanism is usually used to ensure atomicity of distributed transactions. Regardless of which mechanism is used, the read/write concurrency problem exists. Take two-phase commit as an example, it involves two phases: prepare phase and commit phase. After all participants are prepared to commit, the coordinator will initiate a commit request to them. It is impossible to guarantee that all participants will commit at the same time in the protocol.</p>
<p>Suppose T1 is a transaction that transfers $50 from account A to account B. T1 is in the process of committing. The modification to account A has been committed, and the modification to account B is being committed. What are the balance values of accounts A and B read by the concurrent transaction T2?</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221222816-a931bbcf-a0ef-4bca-8572-3ec63042a62b.png" alt="" class="img_ev3q"></p>
<p><strong>The other challenge is external consistency that distributed database systems often face.</strong></p>
<p>Suppose a user places an order on Taobao and the payment is successful.</p>
<p>The order transaction T1 and the payment transaction T2 are located on different servers. T1 and T2 are committed separately. The version number of T1 is 1000, and that of T2 is 800. Assume that the system also has a read transaction T3, whose snapshot version number is 900. T3 can read the successful payment information but cannot read the order information. It violates the business semantics.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221277781-781e9486-aa16-4a67-b0e7-f37a4e6a1172.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scheduling-algorithms-of-concurrent-transactions"><strong>Scheduling algorithms of concurrent transactions</strong><a class="hash-link" aria-label="Direct link to scheduling-algorithms-of-concurrent-transactions" title="Direct link to scheduling-algorithms-of-concurrent-transactions" href="/blog/high-concurrency#scheduling-algorithms-of-concurrent-transactions">​</a></h3>
<p>We have described the challenges brought by concurrent transactions. The behavior of concurrent transactions depends on the scheduling. General concurrent transaction scheduling methods are as follows:</p>
<ul>
<li>The first method is two-phase locking. Two-phase locking is a pessimistic concurrency control method that guarantees serializable schedules of concurrent transactions. Different levels of isolation can be implemented by adjusting the strategy of reading and acquiring locks.</li>
<li>The second method is about concurrency control in an optimistic way, which includes timestamp ordering concurrency control and optimistic concurrency control (OCC).</li>
<li>The third method is the multi-version concurrency control mechanism that is widely used by popular databases.</li>
</ul>
<p>This post focuses on two-phase locking and multi-version concurrency control.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="two-phase-locking"><strong>Two-phase locking</strong><a class="hash-link" aria-label="Direct link to two-phase-locking" title="Direct link to two-phase-locking" href="/blog/high-concurrency#two-phase-locking">​</a></h3>
<p>As the name implies, the two-phase locking protocol involves two phases: the locking phase and the unlocking phase. In the locking phase, each transaction requests the locks that it needs from the lock manager but it cannot release any locks. Each transaction can request for a read or write lock. When the lock manager denies the lock requests, the transactions need to wait. When the transactions enter the unlocking phase, no more lock requests can be made. In database practices, a strict two-phase locking technique is employed. That means transactions can release locks only after they are committed.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221384181-94e3c4f5-fa76-4eee-b9b9-75251890d6d8.png" alt="" class="img_ev3q"></p>
<p>Take a look at an example of a strict two-phase locking scheduling case. Assume T1 is a transaction that transfers USD 10 from account A to account B. During the transfer, a mutually exclusive lock is placed on accounts A and B respectively. Transaction T2 requires a read lock to read the balances of accounts A and B. However, due to the mutually exclusive locks, the read request from T2 has to wait. T2 can only release the exclusive locks after transaction T1 is committed. At last, T2 reads the values of accounts A (90) and B (110) and the total value satisfies the constraint that the sum of the two accounts is equal to 200.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221459615-669f85f8-ae26-4d14-a862-179ce623eace.png" alt="" class="img_ev3q"></p>
<p>The two-phase locking protocol is relatively simple to implement. But when a transaction finds a lock conflict, the transaction needs to wait, which may reduce the concurrent processing capacity of the database. In addition, multiple concurrent transactions are likely to cause deadlocks because they tend to contend for locks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-version-concurrency-control"><strong>Multi-version concurrency control</strong><a class="hash-link" aria-label="Direct link to multi-version-concurrency-control" title="Direct link to multi-version-concurrency-control" href="/blog/high-concurrency#multi-version-concurrency-control">​</a></h3>
<p>To solve the problem of read/write conflict, many databases use the mechanism of multi-version concurrency control. The biggest benefit of this mechanism is that readers do not block writers and writers do not block readers, which greatly improves the concurrency capacity of the system.</p>
<p>Take the implementation of multi-version concurrency control in MySQL InnoDB as an example. InnoDB data blocks record the latest version of data. Multiple old versions of data are recorded in undo logs. InnoDB adds two hidden fields to each row: transaction ID field, which records the identifier for the last transaction that modified the row, and a rollback pointer, which points to old versions of data. The initial content of the row can be traced back through the rollback pointer of the current record. Before a transaction modifies a row in InnoDB, it first locks the row with a mutually exclusive lock to prevent other transactions from modifying the row simultaneously. Then, it writes an undo log and a redo log. Finally, it updates the row data, changes the transaction ID of the row to its ID, and points the rollback pointer to the undo log it just wrote. This is a brief process of how a transaction modifies the data in InnoDB.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221536100-26733a35-ce30-4043-a16c-b4db0d47ee1a.png" alt="" class="img_ev3q"></p>
<p>Take a look at the read process of a transaction. Before a transaction reads the data, it is assigned a read view, which represents the visible scope of the current transaction. The read view contains several pieces of information. First, the ID of this transaction. Second, the list of active transactions and the upper and lower limits of these transactions. After the read view is assigned, the snapshot of the transaction is established. Then, the transaction reads the row records and checks the row records based on the read view. If the current row is invisible, the rollback pointer is used to find the old versions of data. In the read process, the transaction first checks the current transaction ID of the row. If the ID is in the list of active transactions or larger than the maximum transaction ID of the read view, the row data is invisible to the transaction and the transaction needs to find old versions of data. Otherwise, the row data is visible.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/180072/1604304172889-f4478653-ab85-47e0-976c-957f18321415.png?x-oss-process=image%2Fresize%2Cw_1500" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-version-management"><strong>Multi-version management</strong><a class="hash-link" aria-label="Direct link to multi-version-management" title="Direct link to multi-version-management" href="/blog/high-concurrency#multi-version-management">​</a></h3>
<p>OceanBase Database implements multi-version concurrency control based on mutual exclusive locks. The storage engine of OceanBase Database uses an LSM-tree architecture to split data into static data and dynamic data. Dynamic data is stored in MemTables and periodically dumped to the disk. MemTables use B+Tree and dual hash index structures to keep data stored. The B+Tree structure is used for range query while hash indexes are used for single row query.</p>
<p>The leaf nodes of the B+Tree structure store the meta information of the row data. The meta information contains many fields. Only three fields are introduced here: primary key information, lock information, and linked-list pointer.</p>
<ul>
<li>Lock information indicates whether a transaction holds a row lock. Before a transaction modifies data, it needs to acquire a row lock.</li>
<li>A linked-list points to multiple versions of the data. Each version only keeps incremental information. For example, if only one field is modified at a time, only modifications to that field are recorded.</li>
</ul>
<p>As you can see from the following figure, the row with a primary key equal to 1 has been modified three times. The first modification is an insert operation by a transaction with a version number of 1000. The second modification to the field b is made by a transaction with a version number of 1005. The third modification to the field b is made by a transaction with an infinite version number, indicating that the current transaction is not committed.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/180072/1604307652308-90813d94-5b83-4545-9f6c-e76eb85d2456.png?x-oss-process=image%2Fresize%2Cw_1500" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mechanism-and-implementation-of-multi-version-concurrency-control"><strong>Mechanism and implementation of multi-version concurrency control</strong><a class="hash-link" aria-label="Direct link to mechanism-and-implementation-of-multi-version-concurrency-control" title="Direct link to mechanism-and-implementation-of-multi-version-concurrency-control" href="/blog/high-concurrency#mechanism-and-implementation-of-multi-version-concurrency-control">​</a></h3>
<p>The OceanBase distributed database system schedules transactions to ensure that concurrent transactions do not cause consistency issues. Assume that the system has three concurrent transactions, which are read/write transaction T1, read/only transaction T2, and read/write transaction T3. T1 does not commit and holds a lock on row 1.</p>
<p>T3 needs to acquire the row lock of row 1 before it modifies row 1. The lock of row 1 is held by T1, T3 needs to wait until T1 is committed and the row lock is released. T2 is a read-only transaction with a snapshot version number of 1008. Before T2 reads data, it first finds the metadata of the row by the index structure. Then, it finds the committed data with a maximum version number smaller than the snapshot version number based on the snapshot version number. The following figure shows that T2 is able to read the committed data with version number 1005. The preceding is the internal read/write concurrency control mechanism of OceanBase Database. This mechanism solves the write/write conflicts using the mutually exclusive locks on the rows. A multi-version mechanism is used to ensure that readers do not block writers and writers do not block readers.</p>
<p>The multi-version concurrency control mechanism in OceanBase Database is very simple to implement. The snapshot version is a timestamp. The transaction visibility of row records can be determined by comparing the sizes of timestamps without the need to maintain active transactions. In some distributed database systems, a global transaction manager is maintained, which is used to determine transaction snapshots. If the system has multiple concurrent transactions, the global transaction manager can become the bottleneck of the cluster. OceanBase Database does not need to maintain a global transaction manager. Another point is that the lock information is stored on the row metadata in OceanBase Database, eliminating the need for an additional lock manager.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/180072/1604307986350-c0c98d47-c314-46d0-bda5-9f067e0bc1d8.png?x-oss-process=image%2Fresize%2Cw_1500" alt="" class="img_ev3q"></p>
<p>Back to the read/write concurrency problem discussed in the beginning. When T1 is committing, the modification to account A is committed and the modification to account B is being committed. To solve the read/write concurrency problem, a two-phase locking schema is used in some distributed systems. That means T2 needs to acquire a read lock before it can read the balances of accounts A and B after T1 is committed.</p>
<p>In the OceanBase distributed database system, the read request will first find data of the corresponding version based on the snapshot version number. Assume that the version number of the committed transaction T1 is smaller than the snapshot version number of T2. T2 can read modifications made by T1. If T2 finds that row B is in the committing state, T2 needs to wait until row B is committed. This ensures that T2 can read data on both row A and row B. The time window that T2 needs to wait in this scenario starts from the prepare phase and ends at the commit phase. This is much shorter than the time spent to acquire a lock in the two-phase locking process.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221770870-f198b243-22c0-479a-b2eb-2260da52abdc.png" alt="" class="img_ev3q"></p>
<p>Another issue that troubles distributed database systems is external consistency.</p>
<p>For example, to purchase a phone on Taobao, you need to place an order first, and then pay for that order. Order placement and payment are two transactions. Assume that they are T1 and T2 respectively and are handled on two servers that generate independent commit versions. The commit version of T1 is 1000 and that of T2 is 800. When you start a query transaction T3, the version number of which is 900, T3 can read the payment information, but not the order information. This does not agree with the actual order of the transactions, and is therefore an external consistency problem.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="global-timestamp-service-gts"><strong>Global timestamp service (GTS)</strong><a class="hash-link" aria-label="Direct link to global-timestamp-service-gts" title="Direct link to global-timestamp-service-gts" href="/blog/high-concurrency#global-timestamp-service-gts">​</a></h3>
<p><strong>To address external consistency, OceanBase Database introduces the GTS, which assigns snapshot versions and commit versions based on a global timestamp.</strong></p>
<p>In the following figure, you can see that transactions T1 and T2 each requests a timestamp from GTS upon commit as its commit version. Transaction T3 also requests a timestamp as its snapshot version. GTS ensures that TS1 &lt; TS2 &lt; TS3. In other words, if T3 is able to read data modified by T2, it must also be able to read data modified by T1. External consistency is therefore ensured.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221874136-d344c528-d27d-4ae0-90c8-807e06904eba.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="early-lock-release-elr"><strong>Early lock release (ELR)</strong><a class="hash-link" aria-label="Direct link to early-lock-release-elr" title="Direct link to early-lock-release-elr" href="/blog/high-concurrency#early-lock-release-elr">​</a></h3>
<p>A nuisance in single-server database systems, hotspot row updates present a bigger challenge for distributed databases. The longer the row locks are held, the more the performance of the update is affected.</p>
<p>Transactions in a distributed database have longer delays than that in a single-server database. Therefore, row locks are held longer in a distributed database. This problem is more serious in a deployment model with five IDCs across three regions, where log synchronization may cause a delay of up to dozens of milliseconds. OceanBase addresses this problem using the ELR feature.</p>
<p>In a conventional database, row locks are added when a transaction is running and released after the transaction is persisted. In OceanBase Database, row locks are also added when a transaction is running. The difference is that locks can be released as soon as the system receives the request to commit the transaction, without waiting for the persistence of the transaction. In the following figure, you can see that transactions take place one after another without ELR. When ELR is enabled, the next transaction is able to acquire locks before the previous transaction is persisted. The duration in which the locks are held is significantly reduced.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/23425/1604221996559-1b3cf217-088a-4046-8935-a2811d47e43b.png" alt="" class="img_ev3q"></p>
<p>We measured the time required by each phase of running an OLTP update transaction in a test. It took 60 μs to generate the execution plan, 50 μs to perform the DML operation, 33 μs to write the clog, and an additional 170 μs to synchronize that clog. The transaction held its locks for about 270 μs during the execution process. When ELR is enabled, this duration is reduced by 65%, which means the performance of hotspot row updates can be tripled.</p>
<p><img decoding="async" loading="lazy" src="https://intranetproxy.alipay.com/skylark/lark/0/2020/png/180072/1604312990338-3c7dfd2d-9224-43a1-ad1f-0b9afd93a30c.png?x-oss-process=image%2Fresize%2Cw_1500" alt="" class="img_ev3q"></p>
<p>When you were learning about the ELR feature, some of you may have wondered: What if a preceding transaction fails to persist? How should subsequent transactions be handled?</p>
<p>When one transaction fails, all subsequent transactions must be rolled back. This is what is referred to as a cascading rollback and must be avoided, as pointed out by many papers related to database management. However, in actual application scenarios and tests, the possibility of a transaction failure and cascading rollback is very low.</p>
<p>To support cascading rollback, you must maintain the dependencies among transactions on each hotspot row. You can create a linked list that contain all transactions that modify the same row. This ensures that when a transaction fails, all subsequent transactions can be rolled back. For example, transactions T1, T2, and T3 modify data of the same hotspot row. Before T1 is persisted, it releases the row lock so that T2 may acquire the lock. T2 also releases the lock early for T3 to acquire lock. As a result, T3 depends on T2, and T2 depends on T1. A linked list is created based on these dependencies so that, if T1 is not persisted, both T2 and T3 are rolled back to ensure the data is correct.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/oceanbase/oceanbase.github.io/tree/main/blog/blog/tech-high-concurrency.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/distributed-push-down"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">OceanBase Distributed Pushdown Technology</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/refine-performance"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How We Approach Improving Distributed Query Performance</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#cases"><strong>Cases</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#key-high-concurrency-techniques-of-oceanbase-database"><strong>Key high-concurrency techniques of OceanBase Database</strong></a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#consistency-of-distributed-transactions"><strong>Consistency of distributed transactions</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#scheduling-algorithms-of-concurrent-transactions"><strong>Scheduling algorithms of concurrent transactions</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#two-phase-locking"><strong>Two-phase locking</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#multi-version-concurrency-control"><strong>Multi-version concurrency control</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#multi-version-management"><strong>Multi-version management</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#mechanism-and-implementation-of-multi-version-concurrency-control"><strong>Mechanism and implementation of multi-version concurrency control</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#global-timestamp-service-gts"><strong>Global timestamp service (GTS)</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/high-concurrency#early-lock-release-elr"><strong>Early lock release (ELR)</strong></a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/oceanbase/shared_invite/zt-1e25oz3ol-lJ6YNqPHaKwY_mhhioyEuw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum (in Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">SIG</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/sig/AI/sig_intro">AI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/cloud-native/sig_intro">cloud-native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/develop-tools/sig_intro">develop-tools</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/miniob/sig_intro">MiniOB</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/obdiag/sig_intro">obdiag</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/operation/sig_intro">operation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://en.oceanbase.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">About OceanBase<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/oceanbase/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OceanBase, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>