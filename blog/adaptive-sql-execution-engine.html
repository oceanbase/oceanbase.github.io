<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Adaptive Techniques in the OceanBase SQL Execution Engine | OceanBase</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://oceanbase.github.io/blog/adaptive-sql-execution-engine"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Adaptive Techniques in the OceanBase SQL Execution Engine | OceanBase"><meta data-rh="true" name="description" content="I have been studying the book &quot;An Interpretation of OceanBase Database Source Code&quot; and noticed that it contains very little content about the SQL executor. The book focuses on parallel execution in the executor. This blog post introduces some common adaptive techniques in the executor of OceanBase Database. You can take it as a supplement to the executor part in this book."><meta data-rh="true" property="og:description" content="I have been studying the book &quot;An Interpretation of OceanBase Database Source Code&quot; and noticed that it contains very little content about the SQL executor. The book focuses on parallel execution in the executor. This blog post introduces some common adaptive techniques in the executor of OceanBase Database. You can take it as a supplement to the executor part in this book."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-06-03T13:23:07.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://oceanbase.github.io/blog/adaptive-sql-execution-engine"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/blog/adaptive-sql-execution-engine" hreflang="en"><link data-rh="true" rel="alternate" href="https://oceanbase.github.io/blog/adaptive-sql-execution-engine" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://6JQM9QDU5V-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://oceanbase.github.io/blog/adaptive-sql-execution-engine","mainEntityOfPage":"https://oceanbase.github.io/blog/adaptive-sql-execution-engine","url":"https://oceanbase.github.io/blog/adaptive-sql-execution-engine","headline":"Adaptive Techniques in the OceanBase SQL Execution Engine","name":"Adaptive Techniques in the OceanBase SQL Execution Engine","description":"I have been studying the book \"An Interpretation of OceanBase Database Source Code\" and noticed that it contains very little content about the SQL executor. The book focuses on parallel execution in the executor. This blog post introduces some common adaptive techniques in the executor of OceanBase Database. You can take it as a supplement to the executor part in this book.","datePublished":"2024-06-03T13:23:07.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://oceanbase.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OceanBase RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OceanBase Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8d7d8da1.css">
<script src="/assets/js/runtime~main.7aa83aaa.js" defer="defer"></script>
<script src="/assets/js/main.87d99720.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="OceanBase Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OceanBase</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blogs</a><div class="navbar__item dropdown dropdown--hoverable"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/blog/adaptive-sql-execution-engine">Docs</a><ul class="dropdown__menu"><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Product Docs</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">User Manual</a><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Developer Manual</a></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/blog/adaptive-sql-execution-engine">Community</a><ul class="dropdown__menu"><a class="sub-dropdown dropdown__link dropdown--hoverable" style="cursor:pointer">Special Interest Group(SIG)</a><span><li><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub Discussion<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://join.slack.com/t/oceanbase/shared_invite/zt-1e25oz3ol-lJ6YNqPHaKwY_mhhioyEuw" target="_blank" rel="noopener noreferrer" class="dropdown__link">Slack<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Forum (in Chinese)<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span><span><li><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stack Overflow<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></span></ul><ul class="dropdown__menu" style="left:160px;display:none"></ul></div><a href="https://en.oceanbase.com/softwarecenter" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Downloads<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oceanbase" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/architectural-evolution">The architectural evolution of OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/compression-ratio">Data Compression Technology Explained Balance between Costs &amp; Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/flink-cdc">Flink CDC + OceanBase integration solution for full and incremental synchronization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrated-architecture">Integrated Architecture of OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrated-sql-engine">Integrated SQL Engine in OceanBase Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/vectorized-engine">Implementing a Vectorized Engine in a Distributed Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/boss-zhipin">BOSS Zhipin —— How to save 70% storage cost through OceanBase with an archive database of 1 billion rows per day?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dmall">DMALL —— a summary of database selection experience in SaaS scenarios</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sichuan-hwadee">Sichuan Hwadee —— The practice of lightweight data warehouse construction of health big data based on OceanBase</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kuayue-express">KUAYUE EXPRESS —— In the real-time warehouse scenario, utilizing OceanBase to make up for the shortcomings of MySQL and StarRocks</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/momo">Momo —— Exploration and practice of persistent cache based on OceanBase KV storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/all-in-one">Work with developers to create an all-in-one database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/io-isolation">OceanBase provides users with sufficiently flexible and simple I/O resource isolation experiences.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/miniaturization">OceanBase 4.0 interpretation: Reduce the threshold of distributed database use, talk about our thinking on small specifications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ob-430">OceanBase 4.3 - Milestone release for real-time AP analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/resource-isolation">Why is resource isolation important for HTAP?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/flink-and-ob">Flink CDC + OceanBase integration solution for full and incremental synchronization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hello-oceanbase">Hello OceanBase! The first lesson for becoming an OceanBase contributor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/obcloud">How OB Cloud Achieves Cost Reduction and Efficiency Improvement in Replacing MySQL Scenarios ？</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/adaptive-sql-execution-engine">Adaptive Techniques in the OceanBase SQL Execution Engine</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/distributed-push-down">OceanBase Distributed Pushdown Technology</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/high-concurrency">OceanBase Technical Insights for High-Concurrency Scenarios</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/refine-performance">How We Approach Improving Distributed Query Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tp-to-ap">From OLTP to OLAP: Exploration and practice of the OceanBase SQL engine</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Adaptive Techniques in the OceanBase SQL Execution Engine</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-06-03T13:23:07.000Z">June 3, 2024</time> · <!-- -->12 min read</div></header><div id="__blog-post-container" class="markdown"><blockquote>
<p>I have been studying the book &quot;An Interpretation of OceanBase Database Source Code&quot; and noticed that it contains very little content about the SQL executor. The book focuses on parallel execution in the executor. This blog post introduces some common adaptive techniques in the executor of OceanBase Database. You can take it as a supplement to the executor part in this book.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges-facing-ap-performance-improvement">Challenges facing AP performance improvement<a class="hash-link" aria-label="Direct link to Challenges facing AP performance improvement" title="Direct link to Challenges facing AP performance improvement" href="/blog/adaptive-sql-execution-engine#challenges-facing-ap-performance-improvement">​</a></h2>
<p>If you want to improve the AP performance of a database, you will face three challenges:</p>
<ul>
<li>First, the optimizer cannot ensure that its estimates are always absolutely accurate. The reasons are complex. For example, the statistics are inaccurate in some scenarios, or the cost model is inconsistent with the actual model. These reasons will contribute to a non-optimal execution plan.</li>
<li>Second, data skew often occurs in production and business scenarios, which will significantly affect the execution efficiency, especially the parallel execution efficiency.</li>
<li>Third, the semantics of NULL are special. Characteristics of widespread NULL values are different from those of normal values in operations such as joins, but this is easily ignored. The executor must perform special processing on NULL values. Otherwise, various bad cases can occur.</li>
</ul>
<p>Adaptive techniques enable the execution engine to dynamically adjust the execution strategy based on the actual situation, thereby improving the execution performance. In a word, adaptive techniques are introduced to address the preceding challenges. Next, let me introduce some typical adaptive techniques in the executor of OceanBase Database.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adaptive-join-filter">Adaptive join filter<a class="hash-link" aria-label="Direct link to Adaptive join filter" title="Direct link to Adaptive join filter" href="/blog/adaptive-sql-execution-engine#adaptive-join-filter">​</a></h2>
<p>Let me take a hash join shown in the following figure as an example to introduce the background of join filters. The hash join involves two tables and uses hash repartitioning as the data shuffle mode. In other words, each row in the left-side and right-side tables will be repartitioned based on the hash value.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636564738.png" alt="1705636564" class="img_ev3q"></p>
<p>Generally, the right-side table of a hash join is very large in size, which will lead to a high cost in data shuffle. When the left-side table is read to build the hash table, a join filter can extract the data characteristics of the left-side table and send them to the right-side table. This can filter out some of the data in the right-side table before a shuffle. If the join filter has high filtering performance, this step can significantly reduce the network overhead.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636577135.png" alt="1705636577" class="img_ev3q"></p>
<p>OceanBase Database has implemented join filters as early as in V3.x and has been undergoing join filter optimization ever since. The following figure shows the impact of join filters on the overall performance during the TPC-H benchmark run in 2021, in which OceanBase Database won the first place in the world.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636587368.png" alt="1705636587" class="img_ev3q"></p>
<p>Join filters help significantly improve the performance for joins on large tables, such as Q9 shown in the preceding figure.</p>
<p>However, join filters cannot always bring positive benefits in all scenarios, such as Q18 shown in the preceding figure. The overhead of a join filter is used for three tasks:</p>
<ul>
<li>Create the join filter. This is to extract the data characteristics of the left-side table in a hash join when the left-side table is read to build the hash table.</li>
<li>Send the join filter. This is to send the data characteristics of the left-side table to the right-side table.</li>
<li>Apply the join filter. This is to apply the data characteristics of the left-side table on the right-side table for row filtering.</li>
</ul>
<p>If the selectivity of the join filter is low, the reduced network overhead cannot make up the preceding overhead, and the overall performance will deteriorate.</p>
<p>The optimizer determines whether to allocate a join filter based on the cost. The optimizer can roughly estimate the selectivity of a join filter based on statistics such as the number of distinct values (NDV) and MIN/MAX values. However, the optimizer cannot provide accurate estimates of intermediate calculation results in the executor.</p>
<p>To resolve this issue, OceanBase Database V4.1 implements sliding window-based adaptive join filters. This algorithm aims to make up the performance loss when an incorrect join filter is applied.</p>
<p>This algorithm splits data into multiple sliding windows and collects statistics on the apply process of each window. If the algorithm detects that the filtering effects of a window are not as expected, it will not apply the join filter on the next window and pass this window. If the filtering effects of continuous windows are not as expected, the number of passed windows will also increase linearly to reduce the apply cost.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636596184.png" alt="1705636596" class="img_ev3q"></p>
<p>The following figure shows a bad case of join filter. Different strategies are used for performance tests. In the performance test where an adaptive join filter is used, the performance loss is made up by half. However, the performance after compensation is still lower than that achieved when the join filter is not allocated.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636604838.png" alt="1705636604" class="img_ev3q"></p>
<p>Although this solution makes up the performance loss caused by applying a join filter on the right-side table, the cost in creating and sending the join filter is not made up. OceanBase Database will enhance the capability for adaptive join filter creation in later versions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adaptive-hash-group-by">Adaptive HASH GROUP BY<a class="hash-link" aria-label="Direct link to Adaptive HASH GROUP BY" title="Direct link to Adaptive HASH GROUP BY" href="/blog/adaptive-sql-execution-engine#adaptive-hash-group-by">​</a></h2>
<p>This section introduces the adaptive algorithm for HASH GROUP BY in OceanBase Database.</p>
<p>The following figures show the execution plans for HASH GROUP BY in a parallel scenario.</p>
<p>Here is the execution plan for two-phase HASH GROUP BY.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636615372.png" alt="1705636615" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636625338.png" alt="1705636625" class="img_ev3q"></p>
<p>Here is the execution plan for one-phase HASH GROUP BY.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636635870.png" alt="1705636636" class="img_ev3q"></p>
<p>The difference is that two-phase HASH GROUP BY performs a partial GROUP BY operation on data before a shuffle. Like join filters, one-phase and two-phase HASH GROUP BY have their own advantages and disadvantages.</p>
<ul>
<li>Two-phase HASH GROUP BY applies to scenarios with a high data aggregation rate, where the amount of data to be shuffled can be decreased through pre-aggregation.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636648890.png" alt="1705636648" class="img_ev3q"></p>
<ul>
<li>One-phase HASH GROUP BY applies to scenarios with a low data aggregation rate.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636705335.png" alt="1705636705" class="img_ev3q"></p>
<p>If the data aggregation rate is low, the network overhead will still be high because a two-phase plan will consume extra CPU resources to probe the hash table, leading to poorer performance than a one-phase plan.</p>
<p>The following figure compares the performance of two-phase and one-phase plans for queries in ClickBench. It can be observed that some queries are suitable for two-phase execution while others are suitable for one-phase execution. Generally, the optimizer tends to select a two-phase plan to avoid serious performance deterioration.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636714319.png" alt="1705636714" class="img_ev3q"></p>
<p>In versions earlier than OceanBase Database V4.x, the optimizer will determine whether to select a two-phase plan or one-phase plan based on the NDV value in the statistics. You can also use the session variable _GROUPBY_NOPUSHDOWN_CUT_RATIO to set the plan preference. If the ratio of the input data amount to the data amount after aggregation is greater than the specified value, a two-phase plan is generated. Otherwise, a one-phase plan is generated. In practice, it is difficult to use this variable. The input and output data amounts of GROUP BY are estimated by the optimizer based on statistics. Generally, it is challenging for O&amp;M personnel to set this variable to an appropriate value, ensuring that the optimizer selects a better plan for GROUP BY.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636723981.png" alt="1705636724" class="img_ev3q"></p>
<p>In OceanBase Database V4.x, the _GROUPBY_NOPUSHDOWN_CUT_RATIO variable is deprecated and the optimizer is forced to select a two-phase plan. In a two-phase plan in V4.x, the first phase must be adaptive GROUP BY.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636736767.png" alt="1705636736" class="img_ev3q"></p>
<p>The core idea of the adaptive GROUP BY technique is to determine whether to perform deduplication or directly send data based on an NDV value collected in real time. The technique splits data into multiple rounds and measures the aggregation rate of each round. If the deduplication rate of a round is not as expected, the technique will clear the hash table, flush all the data obtained in the first phase to the network, and aggregate the final data in the second phase.</p>
<p>Data is split into rounds based on the size of three-level CPU caches. This is because if the hash table can be accommodated in the L2 cache, the performance can be improved by more than 30% compared with that of a large hash table. A cache-aware mechanism is provided to increase the size of data in each round from the L2 cache size to the L3 cache size when the deduplication rate becomes low so that data will be accommodated in the L3 cache.</p>
<p>If the hash deduplication effects of multiple consecutive rounds are poor, the bypass strategy is used. Specifically, rows are directly delivered to the upper-layer operator without hash deduplication, which looks like a one-phase plan.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636744584.png" alt="1705636744" class="img_ev3q"></p>
<p>This strategy greatly improves the performance but also has bad cases where a large amount of data is involved while the overall deduplication rate is favorable. If the overall deduplication rate is estimated based on only a small part of the data, the estimate is probably inaccurate. In OceanBase Database V4.2, the NDV values of multiple data rounds are merged to improve the estimate accuracy.</p>
<p>The following figure compares the performance of one-phase, adaptive, and two-phase GROUP BY for queries in ClickBench.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636754240.png" alt="1705636754" class="img_ev3q"></p>
<p>The result shows that adaptive GROUP BY can select an appropriate execution strategy almost in all scenarios. With adaptive GROUP BY, one plan applies to different data models. This is the goal we aim to achieve. OceanBase Database V4.3 will support a global NDV estimate strategy to make adaptive decision-making more accurate.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adaptive-hybrid-hash-shuffling">Adaptive hybrid hash shuffling<a class="hash-link" aria-label="Direct link to Adaptive hybrid hash shuffling" title="Direct link to Adaptive hybrid hash shuffling" href="/blog/adaptive-sql-execution-engine#adaptive-hybrid-hash-shuffling">​</a></h2>
<p>Next, let me introduce some adaptive techniques we have developed based on data skew. The following figures show two common plans for a simple distributed hash join.</p>
<p>One is a broadcast plan, which broadcasts the left-side table to each thread of the right-side table. The threads will use data in the right-side table to probe data in the left-side table.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636765811.png" alt="1705636765" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636772964.png" alt="1705636773" class="img_ev3q"></p>
<p>The other is a hash repartitioning plan, which distributes the data in the left-side and right-side tables to different threads based on the hash value. Each thread performs a join separately.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636780959.png" alt="1705636781" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636790880.png" alt="1705636790" class="img_ev3q"></p>
<p>The two plans have their own advantages and disadvantages. Generally, the broadcast plan applies to a scenario where a large table is joined with a small table. In this scenario, the small table is broadcast to limit the broadcast cost. In a scenario where two large tables are joined and repartitioning based on the join key is not supported, hash-hash is almost the only choice. However, the hash-hash strategy also has bad cases in data skew scenarios. For example, the following figure shows a high-frequency value. Since data is distributed to different threads based on the hash value for hash repartitioning, all instances of the high-frequency value are distributed to the same hash join, leading to a long-tail situation of the hash join.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636798440.png" alt="1705636798" class="img_ev3q"></p>
<p>The following figure shows a similar business scenario as observed by the SQL plan monitor tool.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636805216.png" alt="1705636805" class="img_ev3q"></p>
<p>To resolve this issue, OceanBase Database V4.x implements the hybrid hash shuffling algorithm. The following figure shows an execution plan that uses this algorithm. It looks like a plan that uses the hash repartitioning algorithm. The only difference is that a HYBRID keyword is contained in the EXCHANGE operator.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636812110.png" alt="1705636812" class="img_ev3q"></p>
<p>The hybrid hash shuffling algorithm will obtain related information about high-frequency values from the optimizer. For regular values, normal hash shuffling is used for hash repartitioning. For a high-frequency value, if it exists on the left side (hash join build side), the value will be broadcast to all threads to build the hash table. If it exists on the right side (hash join probe side), the instances of this value are randomly distributed to ensure the evenness. This algorithm can effectively resolve performance issues caused by hash repartitioning in data skew scenarios.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636821493.png" alt="1705636821" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adaptive-null-aware-hash-join">Adaptive NULL-aware hash join<a class="hash-link" aria-label="Direct link to Adaptive NULL-aware hash join" title="Direct link to Adaptive NULL-aware hash join" href="/blog/adaptive-sql-execution-engine#adaptive-null-aware-hash-join">​</a></h2>
<p>Finally, let me briefly introduce some optimization techniques we have applied to handle NULL values. For a join, the return result of a NULL value is always NULL in an equal condition. However, the semantics of NULL vary based on the join method.</p>
<p>In inner joins and semi-joins, values whose join key is NULL can be ignored.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636829687.png" alt="1705636829" class="img_ev3q"></p>
<p>In left outer joins, NULL values on the left side also need to be output.</p>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636835954.png" alt="1705636836" class="img_ev3q"></p>
<p>If NULL values are processed as normal values, correct results can be obtained. However, data skew of NULL values or a useless network shuffle of massive NULL values may occur. The following special measures are taken inside hash joins and during a hash join shuffle:</p>
<ul>
<li>Skip NULL values in join keys. This measure usually applies to inner joins and semi-joins, in which values whose join key is NULL will not be output.</li>
<li>Randomly distribute NULL values to avoid data skew. Generally, for an outer join, specifically, the left side of a left outer join, right side of a right outer join, or both sides of a full outer join, if the NULL values of one side or both sides need to be output, these NULL values will not successfully match any value. In this case, random hash values are assigned to these NULL values and the NULL values are randomly distributed to different threads. A NULL value that does not need to be output will still be skipped.</li>
<li>Use the NULL-aware anti-join algorithm, which will not be described in this post, to process anti-joins that contain NOT IN. The semantics of such anti-joins are special.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://obcommunityprod.oss-cn-shanghai.aliyuncs.com/prod/blog/2024-01/1705636844393.png" alt="1705636844" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preview-of-the-next-post">Preview of the next post<a class="hash-link" aria-label="Direct link to Preview of the next post" title="Direct link to Preview of the next post" href="/blog/adaptive-sql-execution-engine#preview-of-the-next-post">​</a></h2>
<p>This post introduces some representative adaptive techniques in the executor of OceanBase Database, based on the assumption that you have a basic understanding of the two-phase pushdown technique for HASH GROUP BY. If you are unfamiliar with the multi-phase pushdown technique of the executor, please look forward to the next post <a href="https://open.oceanbase.com/blog/5382203648" target="_blank" rel="noopener noreferrer">Distributed Pushdown Techniques of OceanBase Database</a>.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/oceanbase/oceanbase.github.io/tree/main/blog/blog/tech-adaptive-engine.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/obcloud"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">How OB Cloud Achieves Cost Reduction and Efficiency Improvement in Replacing MySQL Scenarios ？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/distributed-push-down"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">OceanBase Distributed Pushdown Technology</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#challenges-facing-ap-performance-improvement">Challenges facing AP performance improvement</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#adaptive-join-filter">Adaptive join filter</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#adaptive-hash-group-by">Adaptive HASH GROUP BY</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#adaptive-hybrid-hash-shuffling">Adaptive hybrid hash shuffling</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#adaptive-null-aware-hash-join">Adaptive NULL-aware hash join</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/adaptive-sql-execution-engine#preview-of-the-next-post">Preview of the next post</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://github.com/oceanbase/oceanbase/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/oceanbase/shared_invite/zt-1e25oz3ol-lJ6YNqPHaKwY_mhhioyEuw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ask.oceanbase.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum (in Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">SIG</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/sig/AI/sig_intro">AI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/cloud-native/sig_intro">cloud-native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/develop-tools/sig_intro">develop-tools</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/miniob/sig_intro">MiniOB</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/obdiag/sig_intro">obdiag</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/sig/operation/sig_intro">operation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://en.oceanbase.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">About OceanBase<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/oceanbase/oceanbase" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OceanBase, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>